---
title: "Q method paper"
author: "Chris Katanski"
date: "12/10/2021"
output: html_document
---

#Set up
```{r, set up packages etc., echo=FALSE, results="hide", warning=FALSE, message=FALSE}
#Improt packages for plotting and data manipulation.
library(ggplot2) #Praise be to Hadley
library(scales)
library(reshape2)
library(tidyr)
library(dplyr) #its important that this is after tidyr I think

library(grid) #for faceting figures
library(gridExtra) #more grid
library(ggh4x) #For nested faceting
library(ggpubr) #pables and p-values
library(errors) #for error propegation
library(gtools) #Combinations and permutations

#Reading in svg files into r for ggplotting
library(grImport2)
library(grConvert)
#Reading and plotting jpeg and PNG
library(jpeg)
library(png) #save hiRes png figures
library(svglite) #for saving SVG figures with arbitrary resolution

library(ggrepel) #The fanciest figure labels
library(stringr) #playig games with strings for labels
library(forcats) #Categorical variables need love too
library(readxl) #Read in excel data

library(pwr)
library(pROC)

#For nice log labels
#library(cat.extras)
#library(plotly)

library(extrafont) #We want the fonts
font_import() #Gotta get those fonts
loadfonts() #oowww!

#Set the global figure theme now
theme_set(
  theme_bw() + theme(#legend.position = "None", 
        text = element_text(family = "Arial", size = 14),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        panel.background = element_rect(color = "black"),
        strip.background = element_blank())
  )

#Define a function that excludes things
`%nin%` = Negate(`%in%`)

empty_graph <- ggplot() + theme_void()
```

#Set working directory
```{r}

#CHANGE THIS TO MATCH YOUR COMPUTER
setwd("~/4SR/data/20211210_Queuosine_method_paper/Source/")

```

#_
#Read in human 0Q 100Q data
##Basewise
```{r}
PATH <- "../data/20211011_human0Q100Q/5_tsv/hg19CCA+mito_adjusted_names+5Setc_020321/"
# PATH="../../20201021_COVID/5_tsv/hg19CCA+mito_adjusted_names+5Setc/" #Old stuff is good still
FILES <-data.frame( file_name = list.files(PATH) ) %>%
  filter(!grepl("unassigned", file_name))

#Split generic file names into salient parts
FILES <- FILES %>%
  extract(file_name, "(.*).tsv", into="file_name2", remove=FALSE) %>%
  separate(file_name2, remove=TRUE, sep="_", c("library","junk1", "junk2","barcode", "junk3","bin_start","bin_stop")) %>%
  separate(library, sep="CW", into = c("junk4", "library")) %>%
  mutate(sample = paste0("CW", library, "_", barcode)) %>%
  select(-junk1, -junk2, -junk3, -junk4)
#Annotate the total BIN
FILES <- FILES %>%
  mutate(bin_start = ifelse(is.na(bin_start), -3, bin_start),
         bin_stop = ifelse(is.na(bin_stop), -3, bin_stop))

#====================================
#PROJECT SPECIFIC DECODING
FILES$file_name <- as.character(FILES$file_name)

FILES$sample <- recode(FILES$sample, 
                       "CW01_bc1"="Q_Q0_rep1_minusI",
                       "CW01_bc2"="Q_Q0_rep2_minusI",
                       "CW01_bc3"="Q_Q100_rep1_minusI",
                       "CW01_bc4"="Q_Q100_rep2_minusI",
                       "CW02_bc1"="Q_Q0_rep1_plusI",
                       "CW02_bc2"="Q_Q0_rep2_plusI",
                       "CW02_bc3"="Q_Q100_rep1_plusI",
                       "CW02_bc4"="Q_Q100_rep2_plusI",
                       
                       "CW07_bc1"="Q2_Q100_rep1_minusI-minusT",
                       "CW08_bc1"="Q2_Q100_rep1_plusI-minusT",
                       "CW09_bc1"="Q2_Q100_rep1_minusI-plusT",
                       "CW10_bc1"="Q2_Q100_rep1_plusI-plusT")

FILES <- FILES %>%
  separate(sample, sep="_", into =c("project", "sample", "rep", "treatment")) %>%
  filter(!grepl("CW", project))

#End project specific ================================

read_in_one <- function(row){
  output <- read.csv(paste0(PATH, row$file_name), header=T, sep="\t") %>%
    mutate(bin_start = row$bin_start,
           bin_stop  = row$bin_stop,
           #Some project specific bits
           sample = row$sample,
           project = row$project,
           rep = row$rep,
           treatment = row$treatment
           )
  #specify data types since enpty dataframes get confused and sad
  output$gene <- as.character(output$gene)
  output$base <- as.character(output$base)
  return(output)
}

data_Q_base <- FILES %>%
  group_by(file_name) %>%
  do(read_in_one(.)) %>%
  ungroup()

data_Q_base <- data_Q_base %>%
  filter(gene %nin% c("Ecoli_Lys","Ecoli_Tyr","Yeast_Phe",
                      "spikein_SCC1", "spikein_SCCA1",
                      "spikein_SCCA2", "spikein_SCCA3"))
```

###Extra processing
```{r}
#Remove select snoRNAs, rRNAs, and control RNAs from subsequent analysis
temp <- data_Q_base %>%
  filter(gene %nin% c("NR_004394.1",
                      "NR_002716.3",
                      "NR_003925.1",
                      "NR_004430.2",
                      "NR_002756.2",
                      "NR_004391.1",
                      "NR_004392.1",
                      "NR_004393.1",
                      "NR_001571.2",
                      "Homo_sapiens_chrX.rRNA-5SR5SR",
                      "Homo_sapiens_chrX.rRNA-58S58S",
                      "Ecoli_Tyr",
                      "Yeast_Phe",
                      "Ecoli_Lys",
                      "spikein_SCC1",
                      "spikein_SCCA1"))

#fix mitochondrial names
#Then rearrange all names
temp <- temp %>%
  mutate(source="cytosolic")
temp <- temp %>%
  filter(grepl("mt", gene)) %>%
  mutate(gene = paste0("Homo_sapiens_chrMT.trna1-", gene)) %>%
  mutate(source="mitochondrial") %>%
  rbind(filter(temp, !grepl("mt",gene))) #%>%
  # select(-file_name)

#Simplify names
temp$info <- str_replace_all(temp$gene, "Homo_sapiens_","")


temp <- temp%>%
  separate(info, sep="-", c("chr","AA")) %>%
  separate(AA, sep= -3, c("AA", "anticodon")) 

#Rename Met genes as elongator or initiator based on 5' A/C or G respectively
temp_iMet <- temp %>%
  filter(AA =="Met" ,
         bin_start=="-3") %>%
  #filter(position==1) %>%
  mutate(gene_symbol2 = ifelse(gene %in% c("Homo_sapiens_chr6.trna61-MetCAT",
                                           "Homo_sapiens_chr1.trna32-MetCAT",
                                           "Homo_sapiens_chr9.trna1-MetCAT"), 
                               paste0(AA, "i"), paste0(AA,"e")) ) %>%
  #https://www.ncbi.nlm.nih.gov/pmc/articles/PMC108860/#:~:text=A%20special%20methionine%20tRNA%20is,linkages%20(33%2C%2048).
  group_by(gene) %>%
  summarise(gene_symbol2 = gene_symbol2[1] )

#Resume fMet filtering
temp <- temp %>%
  full_join(., temp_iMet, by=c("gene")) %>%
  mutate(AA = ifelse(is.na(gene_symbol2), AA, gene_symbol2) ) %>%
  select(-gene_symbol2) 

temp <- temp %>%
  filter(AA %nin% c("Undet", "Sup"))

Q_base <- temp %>%
  filter(!grepl("AsnATT", gene),
         !grepl("SerACC", gene),
         !grepl("CysACA", gene),
         !grepl("TyrATA", gene),
         !(anticodon=="GAT" & AA=="Ile" & source=="cytosolic"),
         !grepl("SeCTCA", gene),
         !grepl("SerACT", gene))

```


##Counts
```{r}
PATH <- "../data/20211011_human0Q100Q/6_sam_counter/hg19CCA+mito_adjusted_names+5Setc_020321/"
# PATH="../../20201021_COVID/5_tsv/hg19CCA+mito_adjusted_names+5Setc/" #Old stuff is good still
FILES <-data.frame( file_name = list.files(PATH) ) %>%
  filter(!grepl("unassigned", file_name),
         !grepl(".out", file_name))

#Split generic file names into salient parts
FILES <- FILES %>%
  extract(file_name, "(.*).tsv", into="file_name2", remove=FALSE) %>%
  separate(file_name2, remove=TRUE, sep="_", c("library","junk1", "junk2","barcode", "junk3","bin_start","bin_stop")) %>%
  separate(library, sep="CW", into = c("junk4", "library")) %>%
  mutate(sample = paste0("CW", library, "_", barcode)) %>%
  select(-junk1, -junk2, -junk3, -junk4)
#Annotate the total BIN
FILES <- FILES %>%
  mutate(bin_start = ifelse(is.na(bin_start), -3, bin_start),
         bin_stop = ifelse(is.na(bin_stop), -3, bin_stop))

#====================================
#PROJECT SPECIFIC DECODING
FILES$file_name <- as.character(FILES$file_name)

FILES$sample <- recode(FILES$sample, 
                       "CW01_bc1"="Q_Q0_rep1_minusI",
                       "CW01_bc2"="Q_Q0_rep2_minusI",
                       "CW01_bc3"="Q_Q100_rep1_minusI",
                       "CW01_bc4"="Q_Q100_rep2_minusI",
                       "CW02_bc1"="Q_Q0_rep1_plusI",
                       "CW02_bc2"="Q_Q0_rep2_plusI",
                       "CW02_bc3"="Q_Q100_rep1_plusI",
                       "CW02_bc4"="Q_Q100_rep2_plusI",
                       
                       "CW07_bc1"="Q2_Q100_rep1_minusI-minusT",
                       "CW08_bc1"="Q2_Q100_rep1_plusI-minusT",
                       "CW09_bc1"="Q2_Q100_rep1_minusI-plusT",
                       "CW10_bc1"="Q2_Q100_rep1_plusI-plusT")

FILES <- FILES %>%
  separate(sample, sep="_", into =c("project", "sample", "rep", "treatment")) %>%
  filter(!grepl("CW", project))

#End project specific ================================

read_in_one <- function(row){
  output <- read.csv(paste0(PATH, row$file_name), header=T, sep="\t") %>%
    mutate(bin_start = row$bin_start,
           bin_stop  = row$bin_stop,
           #Some project specific bits
           sample = row$sample,
           project = row$project,
           rep = row$rep,
           treatment = row$treatment
           )
  #specify data types since enpty dataframes get confused and sad
  output$name <- as.character(output$name) #THIS VARIABLE IS DIFFERENT FOR COUNTS
  return(output)
}

data_Q_count <- FILES %>%
  group_by(file_name) %>%
  do(read_in_one(.)) %>%
  ungroup()

#Because gene and name variables are switched for this data type
data_Q_count <- data_Q_count %>%
  mutate(gene=name) %>%
  select(-name)

data_Q_count <- data_Q_count %>%
  filter(gene %nin% c("Ecoli_Lys","Ecoli_Tyr","Yeast_Phe",
                      "spikein_SCC1", "spikein_SCCA1",
                      "spikein_SCCA2", "spikein_SCCA3")) 

```


###Extra processing
```{r}

temp <- data_Q_count %>%
  filter(gene %nin% c("NR_004394.1", #U6
                      "NR_002716.3", #U2
                      "NR_003925.1", #U4
                      "NR_004430.2", #U1
                      "NR_002756.2", #U5A
                      "NR_004391.1", #Y1
                      "NR_004392.1", #Y3
                      "NR_004393.1", #Y4
                      "NR_001571.2", #Y5
                      "Homo_sapiens_chrX.rRNA-5SR5SR",
                      "Homo_sapiens_chrX.rRNA-58S58S",
                      "Ecoli_Tyr",
                      "Yeast_Phe",
                      "Ecoli_Lys",
                      "spikein_SCC1",
                      "spikein_SCCA1"))

#fix mitochondrial names
#Then rearrange all names
temp <- temp %>%
  mutate(source="cytosolic")

temp <- temp %>%
  filter(grepl("mt", gene)) %>%
  mutate(gene = paste0("Homo_sapiens_chrMT.trna1-", gene)) %>%
  mutate(source="mitochondrial") %>%
  rbind(filter(temp, !grepl("mt",gene))) %>%
  select(-file_name)

#Simplify names
temp$info <- str_replace_all(temp$gene, "Homo_sapiens_","")

temp <- temp%>%
  separate(info, sep="-", c("chr","AA")) %>%
  separate(AA, sep= -3, c("AA", "anticodon")) 

#Resume fMet filtering
temp <- temp %>%
  full_join(., temp_iMet, by=c("gene")) %>%
  mutate(AA = ifelse(is.na(gene_symbol2), AA, gene_symbol2) ) %>%
  select(-gene_symbol2) 

temp <- temp %>%
  filter(AA %nin% c("Undet", "Sup")) 


Q_count <- temp %>%
  filter(!grepl("AsnATT", gene),
         !grepl("SerACC", gene),
         !grepl("CysACA", gene),
         !grepl("TyrATA", gene),
         !(anticodon=="GAT" & AA=="Ile" & source=="cytosolic"),
         !grepl("SeCTCA", gene),
         !grepl("SerACT", gene))

```


#_
#Read in human calibration
##Basewise
```{r}
PATH <- "../data/20211228_calibration_curve/5_tsv/hg19CCA+mito_adjusted_names+5Setc_020321/"
# PATH="../../20201021_COVID/5_tsv/hg19CCA+mito_adjusted_names+5Setc/" #Old stuff is good still
FILES <-data.frame( file_name = list.files(PATH) ) %>%
  filter(!grepl("unassigned", file_name))

#Split generic file names into salient parts
FILES <- FILES %>%
  extract(file_name, "(.*).tsv", into="file_name2", remove=FALSE) %>%
  separate(file_name2, remove=TRUE, sep="_", c("library","junk1", "junk2","barcode", "junk3","bin_start","bin_stop")) %>%
  separate(library, sep="CW", into = c("junk4", "library")) %>%
  mutate(sample = paste0("CW", library, "_", barcode)) %>%
  select(-junk1, -junk2, -junk3, -junk4)
#Annotate the total BIN
FILES <- FILES %>%
  mutate(bin_start = ifelse(is.na(bin_start), -3, bin_start),
         bin_stop = ifelse(is.na(bin_stop), -3, bin_stop))

#====================================
#PROJECT SPECIFIC DECODING
FILES$file_name <- as.character(FILES$file_name)

FILES$sample <- recode(FILES$sample, 
                       "CW3-1_bc1"="Q0",
                       "CW3-1_bc2"="Q10",
                       "CW3-1_bc3"="Q20",
                       "CW3-1_bc4"="Q30",
                       "CW3-1_bc5"="Q40",
                       "CW3-1_bc6"="Q50",
                       "CW4-1_bc1"="Q60",
                       "CW4-1_bc2"="Q70",
                       "CW4-1_bc3"="Q80",
                       "CW4-1_bc4"="Q90",
                       "CW4-1_bc5"="Q100")

FILES <- FILES %>%
  filter(!grepl("CW", sample))

#End project specific ================================

read_in_one <- function(row){
  output <- read.csv(paste0(PATH, row$file_name), header=T, sep="\t") %>%
    mutate(bin_start = row$bin_start,
           bin_stop  = row$bin_stop,
           #Some project specific bits
           sample = row$sample,
           # project = row$project,
           # rep = row$rep,
           # treatment = row$treatment
           )
  #specify data types since enpty dataframes get confused and sad
  output$gene <- as.character(output$gene)
  output$base <- as.character(output$base)
  return(output)
}

data_Qcal_base <- FILES %>%
  group_by(file_name) %>%
  do(read_in_one(.)) %>%
  ungroup()

data_Qcal_base <- data_Qcal_base %>%
  filter(gene %nin% c("Ecoli_Lys","Ecoli_Tyr","Yeast_Phe",
                      "spikein_SCC1", "spikein_SCCA1",
                      "spikein_SCCA2", "spikein_SCCA3"))
```

###Extra processing
```{r}
#Remove select snoRNAs, rRNAs, and control RNAs from subsequent analysis
temp <- data_Qcal_base %>%
  filter(gene %nin% c("NR_004394.1",
                      "NR_002716.3",
                      "NR_003925.1",
                      "NR_004430.2",
                      "NR_002756.2",
                      "NR_004391.1",
                      "NR_004392.1",
                      "NR_004393.1",
                      "NR_001571.2",
                      "Homo_sapiens_chrX.rRNA-5SR5SR",
                      "Homo_sapiens_chrX.rRNA-58S58S",
                      "Ecoli_Tyr",
                      "Yeast_Phe",
                      "Ecoli_Lys",
                      "spikein_SCC1",
                      "spikein_SCCA1"))

#fix mitochondrial names
#Then rearrange all names
temp <- temp %>%
  mutate(source="cytosolic")
temp <- temp %>%
  filter(grepl("mt", gene)) %>%
  mutate(gene = paste0("Homo_sapiens_chrMT.trna1-", gene)) %>%
  mutate(source="mitochondrial") %>%
  rbind(filter(temp, !grepl("mt",gene))) #%>%
  # select(-file_name)

#Simplify names
temp$info <- str_replace_all(temp$gene, "Homo_sapiens_","")


temp <- temp%>%
  separate(info, sep="-", c("chr","AA")) %>%
  separate(AA, sep= -3, c("AA", "anticodon")) 

#Rename Met genes as elongator or initiator based on 5' A/C or G respectively
temp_iMet <- temp %>%
  filter(AA =="Met" ,
         bin_start=="-3") %>%
  #filter(position==1) %>%
  mutate(gene_symbol2 = ifelse(gene %in% c("Homo_sapiens_chr6.trna61-MetCAT",
                                           "Homo_sapiens_chr1.trna32-MetCAT",
                                           "Homo_sapiens_chr9.trna1-MetCAT"), 
                               paste0(AA, "i"), paste0(AA,"e")) ) %>%
  #https://www.ncbi.nlm.nih.gov/pmc/articles/PMC108860/#:~:text=A%20special%20methionine%20tRNA%20is,linkages%20(33%2C%2048).
  group_by(gene) %>%
  summarise(gene_symbol2 = gene_symbol2[1] )

#Resume fMet filtering
temp <- temp %>%
  full_join(., temp_iMet, by=c("gene")) %>%
  mutate(AA = ifelse(is.na(gene_symbol2), AA, gene_symbol2) ) %>%
  select(-gene_symbol2) 

temp <- temp %>%
  filter(AA %nin% c("Undet", "Sup"))

Qcal_base <- temp %>%
  filter(!grepl("AsnATT", gene),
         !grepl("SerACC", gene),
         !grepl("CysACA", gene),
         !grepl("TyrATA", gene),
         !(anticodon=="GAT" & AA=="Ile" & source=="cytosolic"),
         !grepl("SeCTCA", gene),
         !grepl("SerACT", gene))

```


##Counts
```{r}
PATH <- "../data/20211228_calibration_curve/6_sam_counter/hg19CCA+mito_adjusted_names+5Setc_020321/"
# PATH="../../20201021_COVID/5_tsv/hg19CCA+mito_adjusted_names+5Setc/" #Old stuff is good still
FILES <-data.frame( file_name = list.files(PATH) ) %>%
  filter(!grepl("unassigned", file_name),
         !grepl(".out", file_name))

#Split generic file names into salient parts
FILES <- FILES %>%
  extract(file_name, "(.*).tsv", into="file_name2", remove=FALSE) %>%
  separate(file_name2, remove=TRUE, sep="_", c("library","junk1", "junk2","barcode", "junk3","bin_start","bin_stop")) %>%
  separate(library, sep="CW", into = c("junk4", "library")) %>%
  mutate(sample = paste0("CW", library, "_", barcode)) %>%
  select(-junk1, -junk2, -junk3, -junk4)
#Annotate the total BIN
FILES <- FILES %>%
  mutate(bin_start = ifelse(is.na(bin_start), -3, bin_start),
         bin_stop = ifelse(is.na(bin_stop), -3, bin_stop))

#====================================
#PROJECT SPECIFIC DECODING
FILES$file_name <- as.character(FILES$file_name)

FILES$sample <- recode(FILES$sample, 
                       "CW3-1_bc1"="Q0",
                       "CW3-1_bc2"="Q10",
                       "CW3-1_bc3"="Q20",
                       "CW3-1_bc4"="Q30",
                       "CW3-1_bc5"="Q40",
                       "CW3-1_bc6"="Q50",
                       "CW4-1_bc1"="Q60",
                       "CW4-1_bc2"="Q70",
                       "CW4-1_bc3"="Q80",
                       "CW4-1_bc4"="Q90",
                       "CW4-1_bc5"="Q100")

# FILES <- FILES %>%
#   separate(sample, sep="_", into =c("project", "sample", "rep", "treatment")) %>%
#   filter(!grepl("CW", project))

#End project specific ================================

read_in_one <- function(row){
  output <- read.csv(paste0(PATH, row$file_name), header=T, sep="\t") %>%
    mutate(bin_start = row$bin_start,
           bin_stop  = row$bin_stop,
           #Some project specific bits
           sample = row$sample,
           # project = row$project,
           # rep = row$rep,
           # treatment = row$treatment
           )
  #specify data types since enpty dataframes get confused and sad
  output$name <- as.character(output$name) #THIS VARIABLE IS DIFFERENT FOR COUNTS
  return(output)
}

data_Qcal_count <- FILES %>%
  group_by(file_name) %>%
  do(read_in_one(.)) %>%
  ungroup()

#Because gene and name variables are switched for this data type
data_Qcal_count <- data_Qcal_count %>%
  mutate(gene=name) %>%
  select(-name)

data_Qcal_count <- data_Qcal_count %>%
  filter(gene %nin% c("Ecoli_Lys","Ecoli_Tyr","Yeast_Phe",
                      "spikein_SCC1", "spikein_SCCA1",
                      "spikein_SCCA2", "spikein_SCCA3")) 

```


###Extra processing
```{r}

temp <- data_Qcal_count %>%
  filter(gene %nin% c("NR_004394.1", #U6
                      "NR_002716.3", #U2
                      "NR_003925.1", #U4
                      "NR_004430.2", #U1
                      "NR_002756.2", #U5A
                      "NR_004391.1", #Y1
                      "NR_004392.1", #Y3
                      "NR_004393.1", #Y4
                      "NR_001571.2", #Y5
                      "Homo_sapiens_chrX.rRNA-5SR5SR",
                      "Homo_sapiens_chrX.rRNA-58S58S",
                      "Ecoli_Tyr",
                      "Yeast_Phe",
                      "Ecoli_Lys",
                      "spikein_SCC1",
                      "spikein_SCCA1"))

#fix mitochondrial names
#Then rearrange all names
temp <- temp %>%
  mutate(source="cytosolic")

temp <- temp %>%
  filter(grepl("mt", gene)) %>%
  mutate(gene = paste0("Homo_sapiens_chrMT.trna1-", gene)) %>%
  mutate(source="mitochondrial") %>%
  rbind(filter(temp, !grepl("mt",gene))) %>%
  select(-file_name)

#Simplify names
temp$info <- str_replace_all(temp$gene, "Homo_sapiens_","")

temp <- temp%>%
  separate(info, sep="-", c("chr","AA")) %>%
  separate(AA, sep= -3, c("AA", "anticodon")) 

#Resume fMet filtering
temp <- temp %>%
  full_join(., temp_iMet, by=c("gene")) %>%
  mutate(AA = ifelse(is.na(gene_symbol2), AA, gene_symbol2) ) %>%
  select(-gene_symbol2) 

temp <- temp %>%
  filter(AA %nin% c("Undet", "Sup")) 


Qcal_count <- temp %>%
  filter(!grepl("AsnATT", gene),
         !grepl("SerACC", gene),
         !grepl("CysACA", gene),
         !grepl("TyrATA", gene),
         !(anticodon=="GAT" & AA=="Ile" & source=="cytosolic"),
         !grepl("SeCTCA", gene),
         !grepl("SerACT", gene))

```






#_
#Read in E. coli plus minus
##Basewise
```{r}
PATH <- "../data/200320_Ecoli_plusminus/5_tsv/Escherichia_tRNA_reference_T/"
# PATH="../../20201021_COVID/5_tsv/hg19CCA+mito_adjusted_names+5Setc/" #Old stuff is good still
FILES <-data.frame( file_name = list.files(PATH) ) %>%
  filter(!grepl("unassigned", file_name))

#Split generic file names into salient parts
FILES <- FILES %>%
  extract(file_name, "(.*).tsv", into="file_name2", remove=FALSE) %>%
  separate(file_name2, remove=TRUE, sep="_", c("library","junk1", "junk2","junk3","barcode","junk4","bin_start","bin_stop", "junk5")) %>%
  mutate(treatment = barcode) %>%
  select(-barcode) %>%
  select(-junk1, -junk2, -junk3, -junk4, -junk5)
#Annotate the total BIN
FILES <- FILES %>%
  mutate(bin_start = ifelse(is.na(bin_start), -3, bin_start),
         bin_stop = ifelse(is.na(bin_stop), -3, bin_stop))

#====================================
#PROJECT SPECIFIC DECODING
FILES$file_name <- as.character(FILES$file_name)

FILES$treatment <- recode(FILES$treatment, 
                       "bc5"="untreated",
                       "bc6"="treated")

FILES <- FILES %>%
  filter(treatment %nin% c("bc1","bc2","bc3","bc4","bc7","bc8","bc9","bc10","bc11","bc12"))
#End project specific ================================

read_in_one <- function(row){
  output <- read.csv(paste0(PATH, row$file_name), header=T, sep="\t") %>%
    mutate(bin_start = row$bin_start,
           bin_stop  = row$bin_stop,
           #Some project specific bits
           # sample = row$sample,
           # project = row$project,
           # rep = row$rep,
           treatment = row$treatment
           )
  #specify data types since enpty dataframes get confused and sad
  output$gene <- as.character(output$gene)
  output$base <- as.character(output$base)
  return(output)
}

data_Q_ecoli_base <- FILES %>%
  group_by(file_name) %>%
  do(read_in_one(.)) %>%
  ungroup()


```

###Extra processing
```{r}
Ecoli_base <- data_Q_ecoli_base %>%
  separate(gene, sep="_", c("Esch","coli","str","K-12","substr","MG", "tRNA")) %>%
  select(-c("Esch","coli","str","K-12","substr","MG")) %>%
  separate(tRNA, sep="-", c("tRNA", "amino_acid", "anticodon", "n1", "n2")) %>%
  select(-tRNA)

```





#_
#Read in data E. coli stress
##Basewise

```{r}
PATH <- "../data/191227_Ecoli_stress/5_tsv/Escherichia_tRNA_reference/"
# PATH="../../20201021_COVID/5_tsv/hg19CCA+mito_adjusted_names+5Setc/" #Old stuff is good still
FILES <-data.frame( file_name = list.files(PATH) ) %>%
  filter(!grepl("unassigned", file_name))

#Split generic file names into salient parts
FILES <- FILES %>%
  extract(file_name, "(.*).tsv", into="file_name2", remove=FALSE) %>%
  separate(file_name2, remove=TRUE, sep="_", c("library","junk1", "barcode","junk2","bin_start","bin_stop", "junk3")) %>%
  select(-junk1, -junk2, -junk3)
#Annotate the total BIN
FILES <- FILES %>%
  mutate(bin_start = ifelse(is.na(bin_start), -3, bin_start),
         bin_stop = ifelse(is.na(bin_stop), -3, bin_stop))

#====================================
#PROJECT SPECIFIC DECODING
FILES$file_name <- as.character(FILES$file_name)

FILES$library <- recode(FILES$library, 
                       "TP-CK4-RPL7"="rep1_minus",
                       "TP-CK4-RPL10"="rep1_plus",
                       "TP-CK4-RPL11"="rep2_minus",
                       "TP-CK4-RPL12"="rep2_plus")
FILES$barcode <- recode(FILES$barcode, 
                       "bc6"="None",
                       "bc7"="DIP",
                       "bc10"="aMG",
                       "bc12"="H2O2")

FILES <- FILES %>%
  separate(library, sep="_", into =c("rep", "DM")) %>%
  mutate(treatment = barcode) %>%
  select(-barcode)

#End project specific ================================

read_in_one <- function(row){
  output <- read.csv(paste0(PATH, row$file_name), header=T, sep="\t") %>%
    mutate(bin_start = row$bin_start,
           bin_stop  = row$bin_stop,
           #Some project specific bits
           DM = row$DM,
           rep = row$rep,
           treatment = row$treatment
           )
  #specify data types since enpty dataframes get confused and sad
  output$gene <- as.character(output$gene)
  output$base <- as.character(output$base)
  return(output)
}

data_EcoliStress_base <- FILES %>%
  group_by(file_name) %>%
  do(read_in_one(.)) %>%
  ungroup()

data_EcoliStress_base <- data_EcoliStress_base

```

###Extra processing
```{r}
temp <- data_EcoliStress_base %>%
  separate(gene, sep="tRNA-", c("wasted","Isodecoder")) %>%
  filter(Isodecoder %nin% c("tRNA-Und-NNN-1-1","tRNA-Und-NNN-2-1")) %>%
  select(-wasted)
temp$Isodecoder <- str_replace_all(temp$Isodecoder, "-1-1","-1")
temp$Isodecoder <- str_replace_all(temp$Isodecoder, "-2-1","-2") 

temp <- temp %>%
  separate(Isodecoder, sep="-", into = c("AA", "anticodon", "chr"))

EcoliStress_base <- temp

```



#_
#Figures
#_
##Figure 1 - Initial observation

###Fig 1C: tRNA His 0Q 100Q
```{r}

temp <- Q_base %>%
  filter(project=="Q") %>%
  filter(AA=="His", source=="cytosolic",
         chr == "chr1.trna111",
         bin_start=="60",
         #sample=="Q0",
         pileup >=500) 

#To do RPM normalization, gott know how many reads in each sample
temp1 <- Q_count %>%
  filter(project=="Q",
         bin_start %in% c("-1", "-2", "-3")) %>%
  group_by(treatment, rep, sample) %>%
  summarise(total_count = sum(count))

temp <-  temp %>%
  full_join(., temp1, by=c("treatment","rep","sample"))

temp$treatment <- recode(temp$treatment, "minusI"="untreated", "plusI"="treated")
temp$sample <- recode(temp$sample, "Q0"="0Q", "Q100"="100Q")


plot1 <- ggplot(filter(temp, 
              ),
       aes(x=position, y= deletion / pileup, color=treatment, group = interaction(treatment, rep, sample, gene))) +
  geom_line() +
  coord_cartesian(ylim = c(-0,0.1)) +
  scale_y_continuous(breaks=c(0,0.05,0.10)) +
  # geom_text(aes(label=base), y=-0.01, color="black") +
  scale_color_manual("IO4", values= c("treated"="red", "untreated"="black")) +
  geom_vline(xintercept = c(34), linetype=2, alpha=0.3) +
  ylab("Deletion fraction") +
  facet_grid(rows = vars(sample),
             cols=vars(paste0(AA,anticodon))) +
  theme(legend.position = "None") +
  theme(axis.title.x = element_blank())


layout <- rbind(c(1))
myplot <- grid.arrange(plot1,  layout_matrix = layout)


figure <- arrangeGrob(myplot, bottom = textGrob("Position",
         gp=gpar(col="black", fontsize=16, fontfamily="Arial")))

path="../Draft/Figures20220128/"
figure_name="fig_1c_His_deletion_full"
width=2.5
height=2
scale=1.5
dpi=600
# ggsave(paste0(path, figure_name,".svg"), 
#        plot = figure,
#        scale = scale,
#        dpi = dpi,
#        width = width, 
#        height = height)

ggsave(paste0(path, figure_name,".png"),
       plot = figure,
       scale = scale,
       dpi = dpi,
       width = width,
       height = height)

```


###Fig 1C - zoom
```{r}
temp <- Q_base %>%
  filter(project=="Q") %>%
  filter(AA=="His", source=="cytosolic",
         chr == "chr1.trna111",
         bin_start=="60",
         # sample=="Q0",
         pileup >= 100)

temp$treatment <- recode(temp$treatment, "minusI"="-", "plusI"="+")
temp$sample <- recode(temp$sample, "Q0"="0Q", "Q100"="100Q")


plot1 <- ggplot(filter(temp, 
              # chr=="chr1.trna50"
              ),
       aes(x=position, y=deletion/pileup, color=treatment, group = interaction(treatment, rep, sample, gene))) +
  geom_line() +
  coord_cartesian(ylim = c(-0,0.1),
                  xlim = c(29,39)) +
  scale_x_continuous(breaks = c(30, 34,38)) +
  scale_y_continuous(breaks=c(0,0.05,0.1))+
  # geom_text(aes(label=base), y=-0.01, color="black") +
  geom_vline(xintercept = c(34), linetype=2, alpha=0.3) +
  scale_color_manual("Periodate", values= c("+"="red", "-"="black")) +
  ylab("Deletion fraction") +
  xlab("Position") +
  facet_grid(cols=vars( paste0(AA, anticodon)),
             rows=vars( sample)) +
  theme(#legend.position = c(0.8,0.7),
        legend.position = "left",
        legend.background = element_rect(color="black", fill="white", linetype="solid"))

layout <- rbind(c(1))
figure <- grid.arrange(plot1,  layout_matrix = layout)

path="../Draft/Figures20220128/"
figure_name="fig_1c_His_zoom"
width=2.5
height=2
scale=1.5
dpi=600
# ggsave(paste0(path, figure_name,".svg"), 
#        plot = figure,
#        scale = scale,
#        dpi = dpi,
#        width = width, 
#        height = height)

ggsave(paste0(path, figure_name,".png"),
       plot = figure,
       scale = scale,
       dpi = dpi,
       width = width,
       height = height)

```

###Fig 1d - all features
```{r}
temp <- Q_base %>%
  filter(project=="Q") %>%
  filter(AA=="His", source=="cytosolic",
         chr == "chr1.trna111",
         bin_start=="60",
         #sample=="Q0",
         position >=29,
         position <= 39,
         pileup >=500) 

#To do RPM normalization, gott know how many reads in each sample
temp1 <- Q_count %>%
  filter(project=="Q",
         bin_start %in% c("-1", "-2", "-3")) %>%
  group_by(treatment, rep, sample) %>%
  summarise(total_count = sum(count))

temp <-  temp %>%
  full_join(., temp1, by=c("treatment","rep","sample"))

temp$treatment <- recode(temp$treatment, "minusI"="untreated", "plusI"="treated")
temp$sample <- recode(temp$sample, "Q0"="0Q", "Q100"="100Q")





plot1 <- ggplot(filter(temp, 
              ),
       aes(x=position, y= mutation, color=treatment, group = interaction(treatment, rep, sample, gene))) +
  geom_line() +
  coord_cartesian(ylim = c(0,0.05)) +
  # geom_text(aes(label=base), y=-0.01, color="black") +
  scale_color_manual("IO4", values= c("treated"="red", "untreated"="black")) +
  scale_x_continuous(breaks=c(30,32,34,36,38)) +
  scale_y_continuous(breaks=c(0,0.02,0.04)) +
  geom_vline(xintercept = c(34), linetype=2, alpha=0.3) +
  ylab("Mutation\nfraction") +
  facet_grid(rows = vars(sample)) +
  theme(legend.position = "None") +
  theme(axis.title.x = element_blank())


plot2 <- ggplot(filter(temp, 
              ),
       aes(x=position, y= insertion / pileup, color=treatment, group = interaction(treatment, rep, sample, gene))) +
  geom_line() +
  coord_cartesian(ylim = c(0,0.02)) +
  # geom_text(aes(label=base), y=-0.01, color="black") +
  scale_color_manual("IO4", values= c("treated"="red", "untreated"="black")) +
  scale_x_continuous(breaks=c(30,32,34,36,38)) +
  scale_y_continuous(breaks=c(0,0.01,0.02)) +
  geom_vline(xintercept = c(34), linetype=2, alpha=0.3) +
  ylab("Insertion\nfraction") +
  facet_grid(rows = vars(sample)) +
  theme(legend.position = "None") +
  theme(axis.title.x = element_blank()) 

plot3 <- ggplot(filter(temp, 
              ),
       aes(x=position, y= stop, color=treatment, group = interaction(treatment, rep, sample, gene))) +
  geom_line() +
  coord_cartesian(ylim = c(-0,0.1)) +
  # geom_text(aes(label=base), y=-0.01, color="black") +
  scale_color_manual("IO4", values= c("treated"="red", "untreated"="black")) +
  scale_x_continuous(breaks=c(30,32,34,36,38)) +
  scale_y_continuous(breaks = c(0,0.05,0.1)) +
  geom_vline(xintercept = c(34), linetype=2, alpha=0.3) +
  ylab("Stop\nfraction") +
  facet_grid(rows = vars(sample)) +
  theme(legend.position = "None") +
  theme(axis.title.x = element_blank())


layout <- rbind(c(1), c(2), c(3) )
myplot <- grid.arrange(plot1, plot2, plot3,  layout_matrix = layout)


figure <- arrangeGrob(myplot, bottom = textGrob("Position",
         gp=gpar(col="black", fontsize=16, fontfamily="Arial")))

path="../Draft/Figures20220128/"
figure_name="fig_1D_His_features"
width=2.5
height=4.5
scale=1.5
dpi=600
# ggsave(paste0(path, figure_name,".svg"), 
#        plot = figure,
#        scale = scale,
#        dpi = dpi,
#        width = width, 
#        height = height)

ggsave(paste0(path, figure_name,".png"),
       plot = figure,
       scale = scale,
       dpi = dpi,
       width = width,
       height = height)

```

#_
##Figure 2

###Fig 2A - Asn
```{r}
temp <- Q_base %>%
  filter(project=="Q") %>%
  filter(AA=="Asn", source=="cytosolic",
         # chr == "chr1.trna26",
         bin_start=="60",
         # sample=="Q0",
         pileup >= 100)

temp$treatment <- recode(temp$treatment, "minusI"="untreated", "plusI"="treated")
temp$sample <- recode(temp$sample, "Q0"="0Q", "Q100"="100Q")


plot1 <- ggplot(filter(temp, 
              chr=="chr1.trna26"
              # chr=="chr1.trna50"
              ),
       aes(x=position, y=deletion/pileup, color=treatment, group = interaction(treatment, rep, sample, gene))) +
  geom_line() +
  coord_cartesian(ylim = c(0,0.15),
                  xlim = c(30,40)) +
  scale_x_continuous(breaks = c(31,33,35,37,39)) +
  # geom_text(aes(label=base), y=-0.01, color="black") +
  geom_vline(xintercept = c(35), linetype=2, alpha=0.3) +
  scale_color_manual("IO4", values= c("treated"="red", "untreated"="black")) +
  ylab("Deletion fraction") +
  xlab("Position") +
  facet_grid(cols=vars( paste0(AA, anticodon, chr)),
             rows=vars( sample)) +
  theme(#legend.position = c(0.8,0.7),
        legend.position = "none",
        legend.background = element_rect(color="black", fill="white", linetype="solid"))

layout <- rbind(c(1))
figure <- grid.arrange(plot1,  layout_matrix = layout)

path="../Draft/Figures20220128/"
figure_name="fig_2a_Asn"
width=1.75
height=1.75
scale=1.5
dpi=600
# ggsave(paste0(path, figure_name,".svg"), 
#        plot = figure,
#        scale = scale,
#        dpi = dpi,
#        width = width, 
#        height = height)

ggsave(paste0(path, figure_name,".png"),
       plot = figure,
       scale = scale,
       dpi = dpi,
       width = width,
       height = height)

```

###Fig 2B - mtHis
```{r}
temp <- Q_base %>%
  filter(project=="Q") %>%
  filter(AA=="mtHis", #source=="cytosolic",
         # chr == "chr1.trna26",
         bin_start=="60",
         # sample=="Q0",
         pileup >= 100)

temp$treatment <- recode(temp$treatment, "minusI"="untreated", "plusI"="treated")
temp$sample <- recode(temp$sample, "Q0"="0Q", "Q100"="100Q")


plot1 <- ggplot(filter(temp, 
              # chr=="chr1.trna50"
              ),
       aes(x=position, y=deletion/pileup, color=treatment, group = interaction(treatment, rep, sample, gene))) +
  geom_line() +
  coord_cartesian(ylim = c(0,0.15),
                  xlim = c(26,37)) +
  scale_x_continuous(breaks = c(27,29,31,33,35)) +
  # geom_text(aes(label=base), y=-0.01, color="black") +
  geom_vline(xintercept = c(31), linetype=2, alpha=0.3) +
  scale_color_manual("IO4", values= c("treated"="red", "untreated"="black")) +
  ylab("Deletion fraction") +
  xlab("Position") +
  facet_grid(cols=vars( paste0(AA, anticodon, chr)),
             rows=vars( sample)) +
  theme(#legend.position = c(0.8,0.7),
        legend.position = "none",
        legend.background = element_rect(color="black", fill="white", linetype="solid"))

layout <- rbind(c(1))
figure <- grid.arrange(plot1,  layout_matrix = layout)

path="../Draft/Figures20220128/"
figure_name="fig_2b_mtHis"
width=1.75
height=1.75
scale=1.5
dpi=600
# ggsave(paste0(path, figure_name,".svg"), 
#        plot = figure,
#        scale = scale,
#        dpi = dpi,
#        width = width, 
#        height = height)

ggsave(paste0(path, figure_name,".png"),
       plot = figure,
       scale = scale,
       dpi = dpi,
       width = width,
       height = height)


```


###Fig 2C - mtAsn
```{r}
temp <- Q_base %>%
  filter(project=="Q") %>%
  filter(AA=="mtAsn", #source=="cytosolic",
         # chr == "chr1.trna26",
         bin_start=="60",
         # sample=="Q0",
         pileup >= 100)

temp$treatment <- recode(temp$treatment, "minusI"="untreated", "plusI"="treated")
temp$sample <- recode(temp$sample, "Q0"="0Q", "Q100"="100Q")


plot1 <- ggplot(filter(temp, 
              # chr=="chr1.trna50"
              ),
       aes(x=position, y=deletion/pileup, color=treatment, group = interaction(treatment, rep, sample, gene))) +
  geom_line() +
  coord_cartesian(ylim = c(0,0.25),
                  xlim = c(29,39)) +
  scale_x_continuous(breaks = c(30,32,34,36,38)) +
  scale_y_continuous(breaks=c(0,0.1,0.2)) +
  # geom_text(aes(label=base), y=-0.01, color="black") +
  geom_vline(xintercept = c(34), linetype=2, alpha=0.3) +
  scale_color_manual("IO4", values= c("treated"="red", "untreated"="black")) +
  ylab("Deletion fraction") +
  xlab("Position") +
  facet_grid(cols=vars( paste0(AA, anticodon, chr)),
             rows=vars( sample)) +
  theme(#legend.position = c(0.8,0.7),
        legend.position = "none",
        legend.background = element_rect(color="black", fill="white", linetype="solid"))

layout <- rbind(c(1))
figure <- grid.arrange(plot1,  layout_matrix = layout)

path="../Draft/Figures20220128/"
figure_name="fig_2c_mtAsn"
width=1.75
height=1.75
scale=1.5
dpi=600
# ggsave(paste0(path, figure_name,".svg"), 
#        plot = figure,
#        scale = scale,
#        dpi = dpi,
#        width = width, 
#        height = height)

ggsave(paste0(path, figure_name,".png"),
       plot = figure,
       scale = scale,
       dpi = dpi,
       width = width,
       height = height)

```

###Fig 2D - His
```{r}
temp <- Q_base %>%
  filter(project=="Q") %>%
  filter(AA=="His", source=="cytosolic",
         chr == "chr1.trna111",
         bin_start=="60",
         # sample=="Q0",
         pileup >= 100)

temp$treatment <- recode(temp$treatment, "minusI"="-", "plusI"="+")
temp$sample <- recode(temp$sample, "Q0"="0Q", "Q100"="100Q")


plot1 <- ggplot(filter(temp, 
              # chr=="chr1.trna50"
              ),
       aes(x=position, y=deletion/pileup, color=treatment, group = interaction(treatment, rep, sample, gene))) +
  geom_line() +
  coord_cartesian(ylim = c(0,0.1),
                  xlim = c(29,39)) +
  scale_x_continuous(breaks = c(30, 34,38)) +
  scale_y_continuous(breaks=c(0,0.05,0.1))+
  # geom_text(aes(label=base), y=-0.01, color="black") +
  geom_vline(xintercept = c(34), linetype=2, alpha=0.3) +
  scale_color_manual("Periodate", values= c("+"="red", "-"="black")) +
  ylab("Deletion fraction") +
  xlab("Position") +
  facet_grid(cols=vars( paste0(AA, anticodon, chr)),
             rows=vars( sample)) +
  theme(#legend.position = c(0.8,0.7),
        legend.position = "none",
        legend.background = element_rect(color="black", fill="white", linetype="solid"))

layout <- rbind(c(1))
figure <- grid.arrange(plot1,  layout_matrix = layout)

path="../Draft/Figures20220128/"
figure_name="fig_2d_His"
width=1.75
height=1.75
scale=1.5
dpi=600
# ggsave(paste0(path, figure_name,".svg"), 
#        plot = figure,
#        scale = scale,
#        dpi = dpi,
#        width = width, 
#        height = height)

ggsave(paste0(path, figure_name,".png"),
       plot = figure,
       scale = scale,
       dpi = dpi,
       width = width,
       height = height)

```

###Fig 2E - mtTyr
```{r}
temp <- Q_base %>%
  filter(project=="Q") %>%
  filter(AA=="mtTyr", #source=="cytosolic",
         # chr == "chr1.trna26",
         bin_start=="60",
         # sample=="Q0",
         pileup >= 100)

temp$treatment <- recode(temp$treatment, "minusI"="untreated", "plusI"="treated")
temp$sample <- recode(temp$sample, "Q0"="0Q", "Q100"="100Q")


plot1 <- ggplot(filter(temp, 
              # chr=="chr1.trna50"
              ),
       aes(x=position, y=deletion/pileup, color=treatment, group = interaction(treatment, rep, sample, gene))) +
  geom_line() +
  coord_cartesian(ylim = c(0,0.15),
                  xlim = c(25,35)) +
  scale_x_continuous(breaks = c(26,28,30,32,34)) +
  # geom_text(aes(label=base), y=-0.01, color="black") +
  geom_vline(xintercept = c(30), linetype=2, alpha=0.3) +
  scale_color_manual("IO4", values= c("treated"="red", "untreated"="black")) +
  ylab("Deletion fraction") +
  xlab("Position") +
  facet_grid(cols=vars( paste0(AA, anticodon, chr)),
             rows=vars( sample)) +
  theme(#legend.position = c(0.8,0.7),
        legend.position = "none",
        legend.background = element_rect(color="black", fill="white", linetype="solid"))

layout <- rbind(c(1))
figure <- grid.arrange(plot1,  layout_matrix = layout)

path="../Draft/Figures20220128/"
figure_name="fig_2e_mtTyr"
width=1.75
height=1.75
scale=1.5
dpi=600
# ggsave(paste0(path, figure_name,".svg"), 
#        plot = figure,
#        scale = scale,
#        dpi = dpi,
#        width = width, 
#        height = height)

ggsave(paste0(path, figure_name,".png"),
       plot = figure,
       scale = scale,
       dpi = dpi,
       width = width,
       height = height)

```



###Fig 2F - mtAsp
```{r}
temp <- Q_base %>%
  filter(project=="Q") %>%
  filter(AA=="mtAsp", #source=="cytosolic",
         # chr == "chr1.trna26",
         bin_start=="60",
         # sample=="Q0",
         pileup >= 100)

temp$treatment <- recode(temp$treatment, "minusI"="untreated", "plusI"="treated")
temp$sample <- recode(temp$sample, "Q0"="0Q", "Q100"="100Q")


plot1 <- ggplot(filter(temp, 
              # chr=="chr1.trna50"
              ),
       aes(x=position, y=deletion/pileup, color=treatment, group = interaction(treatment, rep, sample, gene))) +
  geom_line() +
  coord_cartesian(ylim = c(0,0.1),
                  xlim = c(26,36)) +
  scale_x_continuous(breaks = c(27,29,31,33,35)) +
  scale_y_continuous(breaks=c(0,0.05,0.1)) +
  # geom_text(aes(label=base), y=-0.01, color="black") +
  geom_vline(xintercept = c(31), linetype=2, alpha=0.3) +
  scale_color_manual("IO4", values= c("treated"="red", "untreated"="black")) +
  ylab("Deletion fraction") +
  xlab("Position") +
  facet_grid(cols=vars( paste0(AA, anticodon, chr)),
             rows=vars( sample)) +
  theme(#legend.position = c(0.8,0.7),
        legend.position = "none",
        legend.background = element_rect(color="black", fill="white", linetype="solid"))

layout <- rbind(c(1))
figure <- grid.arrange(plot1,  layout_matrix = layout)

path="../Draft/Figures20220128/"
figure_name="fig_2f_mtAsp"
width=1.75
height=1.75
scale=1.5
dpi=600
# ggsave(paste0(path, figure_name,".svg"), 
#        plot = figure,
#        scale = scale,
#        dpi = dpi,
#        width = width, 
#        height = height)

ggsave(paste0(path, figure_name,".png"),
       plot = figure,
       scale = scale,
       dpi = dpi,
       width = width,
       height = height)

```

###Fig 2G - Tyr
```{r}
temp <- Q_base %>%
  filter(project=="Q") %>%
  filter(AA=="Tyr", source=="cytosolic",
         chr == "chr14.trna16",
         bin_start=="60",
         # sample=="Q0",
         pileup >= 100)

temp$treatment <- recode(temp$treatment, "minusI"="untreated", "plusI"="treated")
temp$sample <- recode(temp$sample, "Q0"="0Q", "Q100"="100Q")


plot1 <- ggplot(filter(temp, 
              # chr=="chr1.trna50"
              ),
       aes(x=position, y=deletion/pileup, color=treatment, group = interaction(treatment, rep, sample, gene))) +
  geom_line() +
  coord_cartesian(ylim = c(0,0.01),
                  xlim = c(29,39)) +
  scale_x_continuous(breaks = c(30,32,34,36,38)) +
  scale_y_continuous(breaks=c(0,0.01)) +
  # geom_text(aes(label=base), y=-0.01, color="black") +
  geom_vline(xintercept = c(34), linetype=2, alpha=0.3) +
  scale_color_manual("IO4", values= c("treated"="red", "untreated"="black")) +
  ylab("Deletion fraction") +
  xlab("Position") +
  facet_grid(cols=vars( paste0(AA, anticodon, chr)),
             rows=vars( sample)) +
  theme(#legend.position = c(0.8,0.7),
        legend.position = "none",
        legend.background = element_rect(color="black", fill="white", linetype="solid"))

layout <- rbind(c(1))
figure <- grid.arrange(plot1,  layout_matrix = layout)

path="../Draft/Figures20220128/"
figure_name="fig_2g_Tyr"
width=1.75
height=1.75
scale=1.5
dpi=600
# ggsave(paste0(path, figure_name,".svg"), 
#        plot = figure,
#        scale = scale,
#        dpi = dpi,
#        width = width, 
#        height = height)

ggsave(paste0(path, figure_name,".png"),
       plot = figure,
       scale = scale,
       dpi = dpi,
       width = width,
       height = height)

```


###Fig 2H - Asp
```{r}
temp <- Q_base %>%
  filter(project=="Q") %>%
  filter(AA=="Asp", source=="cytosolic",
         chr == "chr1.trna69",
         bin_start=="60",
         # sample=="Q0",
         pileup >= 100)

temp$treatment <- recode(temp$treatment, "minusI"="untreated", "plusI"="treated")
temp$sample <- recode(temp$sample, "Q0"="0Q", "Q100"="100Q")


plot1 <- ggplot(filter(temp, 
              # chr=="chr1.trna50"
              ),
       aes(x=position, y=deletion/pileup, color=treatment, group = interaction(treatment, rep, sample, gene))) +
  geom_line() +
  coord_cartesian(ylim = c(0,0.03),
                  xlim = c(29,39)) +
  scale_x_continuous(breaks = c(30,32,34,36,38)) +
  scale_y_continuous(breaks=c(0,0.01,0.02, 0.03)) +
  # geom_text(aes(label=base), y=-0.01, color="black") +
  geom_vline(xintercept = c(34), linetype=2, alpha=0.3) +
  scale_color_manual("IO4", values= c("treated"="red", "untreated"="black")) +
  ylab("Deletion fraction") +
  xlab("Position") +
  facet_grid(cols=vars( paste0(AA, anticodon, chr)),
             rows=vars( sample)) +
  theme(#legend.position = c(0.8,0.7),
        legend.position = "none",
        legend.background = element_rect(color="black", fill="white", linetype="solid"))

layout <- rbind(c(1))
figure <- grid.arrange(plot1,  layout_matrix = layout)

path="../Draft/Figures20220128/"
figure_name="fig_2h_Asp"
width=1.75
height=1.75
scale=1.5
dpi=600
# ggsave(paste0(path, figure_name,".svg"), 
#        plot = figure,
#        scale = scale,
#        dpi = dpi,
#        width = width, 
#        height = height)

ggsave(paste0(path, figure_name,".png"),
       plot = figure,
       scale = scale,
       dpi = dpi,
       width = width,
       height = height)

```


#_
##Figure 3


###Fig 3A: Overlay His
```{r}
temp <- Qcal_base %>%
  filter(#project=="Q", 
         pileup >= 1000,
         bin_start=="60") %>%
  filter(#(AA=="Asp" & chr=="chr1.trna69") |
         #(AA=="Asn" & chr=="chr1.trna26") |
         #(AA=="Tyr" & chr =="chr14.trna16") |
         (AA=="His" & chr == "chr1.trna111") #|
         #(AA =="mtHis") |
         #(AA =="mtAsn") |
         #(AA =="mtTyr") |
         #( AA =="mtAsp") 
         )

temp$sample <- recode(temp$sample, "Q0"=0, "Q10"=10, "Q20"=20, "Q30"=30, "Q40"=40, 
                      "Q50"=50, "Q60"=60, "Q70"=70, "Q80"=80, "Q90"=90, "Q100"=100)
plot1 <- ggplot(temp,
       aes(x=position, y=deletion / pileup, color=sample, group=interaction(sample))) +
  geom_line() +
  ylab("Deletion fraction") +
  scale_color_continuous(low="black", high="red") +
  geom_vline(xintercept = c(34), alpha=0.3, linetype=2) +
  scale_x_continuous(breaks=c(32,34,36,38)) +
  scale_y_continuous(breaks=c(0,0.02, 0.04)) +
  # scale_y_log10() +
  coord_cartesian(xlim = c(31,36.7),
                  ylim = c(0, 0.05 )) +
  facet_wrap(~AA) +
  theme(legend.position = "none")


layout <- rbind(c(1))
figure <- grid.arrange(plot1,  layout_matrix = layout)

path="../Draft/Figures20220128/"
figure_name="fig_3a_His_overlay"
width=2
height=1.75
scale=1.5
dpi=600
# ggsave(paste0(path, figure_name,".svg"), 
#        plot = figure,
#        scale = scale,
#        dpi = dpi,
#        width = width, 
#        height = height)

ggsave(paste0(path, figure_name,".png"),
       plot = figure,
       scale = scale,
       dpi = dpi,
       width = width,
       height = height)
```

####Legend
```{r}
temp <- data.frame(X = c(1,2,3,4),  Y = c(1,2,3,4), FractionQ = c(0,.33, .66, 1))

plot1 <- ggplot(temp, aes(x=X,y=Y, color=FractionQ)) +
  geom_point() +
  theme(legend.position = "right") +
  scale_color_gradient(low="black", high="red", breaks=c(0,0.5,1.0))

layout <- rbind(c(1))
figure <- grid.arrange(plot1,  layout_matrix = layout)

path="../Draft/Figures20220128/"
figure_name="fig_3a_legend"
width=2
height=1.75
scale=1.5
dpi=600
# ggsave(paste0(path, figure_name,".svg"), 
#        plot = figure,
#        scale = scale,
#        dpi = dpi,
#        width = width, 
#        height = height)

ggsave(paste0(path, figure_name,".png"),
       plot = figure,
       scale = scale,
       dpi = dpi,
       width = width,
       height = height)
```

###Fig 3B: Overlay Asn
```{r}
temp <- Qcal_base %>%
  filter(#project=="Q", 
         pileup >= 1000,
         bin_start=="-2") %>%
  filter(#(AA=="Asp" & chr=="chr1.trna69") |
         (AA=="Asn" & chr=="chr1.trna26") #|
         #(AA=="Tyr" & chr =="chr14.trna16") |
         #(AA=="His" & chr == "chr1.trna111") #|
         #(AA =="mtHis") |
         #(AA =="mtAsn") |
         #(AA =="mtTyr") |
         #( AA =="mtAsp") 
         )

temp$sample <- recode(temp$sample, "Q0"=0, "Q10"=10, "Q20"=20, "Q30"=30, "Q40"=40, 
                      "Q50"=50, "Q60"=60, "Q70"=70, "Q80"=80, "Q90"=90, "Q100"=100)
plot1 <- ggplot(temp,
       aes(x=position, y=deletion / pileup, color=sample, group=interaction(sample))) +
  geom_line() +
  scale_color_continuous(low="black", high="red") +
  geom_vline(xintercept = c(35), alpha=0.3, linetype=2) +
  scale_x_continuous(breaks=c(32,34,36,38)) +
  scale_y_continuous(breaks = c(0,0.05, 0.1)) +
  ylab("Deletion fraction") +
  # scale_y_log10() +
  coord_cartesian(xlim = c(32,38),
                  ylim = c(0, 0.1)) +
  facet_wrap(~AA) +
  theme(legend.position = "none")


layout <- rbind(c(1))
figure <- grid.arrange(plot1,  layout_matrix = layout)

path="../Draft/Figures20220128/"
figure_name="fig_3b_Asn_overlay"
width=2
height=1.75
scale=1.5
dpi=600
# ggsave(paste0(path, figure_name,".svg"), 
#        plot = figure,
#        scale = scale,
#        dpi = dpi,
#        width = width, 
#        height = height)

ggsave(paste0(path, figure_name,".png"),
       plot = figure,
       scale = scale,
       dpi = dpi,
       width = width,
       height = height)
```


###Fig 3C: Calibration curve
```{r}

#Tao did this figure on origin

```

###Fig 3D: Asn isodecoders
```{r}
temp <- Q_base %>%
  filter(project=="Q") %>%
  filter(AA=="Asn", source=="cytosolic",
         chr %in% c("chr1.trna103","chr1.trna107","chr1.trna136","chr1.trna26","chr1.trna47"),
         bin_start=="60",
         sample=="Q100",
         pileup >= 100)

#To do RPM normalization, gott know how many reads in each sample
temp1 <- Q_count %>%
  filter(project=="Q",
         bin_start %in% c("-1", "-2", "-3")) %>%
  group_by(treatment, rep, sample) %>%
  summarise(total_count = sum(count))
temp <-  temp %>%
  full_join(., temp1, by=c("treatment","rep","sample")) %>%
  filter(pileup >= 0)
temp$treatment <- recode(temp$treatment, "minusI"="untreated", "plusI"="treated")
temp$chr <- recode(temp$chr, "chr1.trna103"="5","chr1.trna107"="2","chr1.trna136"="4","chr1.trna26"="1","chr1.trna47"="3")

plot1 <- ggplot(filter(temp, position%in% c(34,35), base=="G",
              # (chr=="chr1.trna69" & position==34)|(chr=="chr12.trna5" & position==34)|(chr=="chr6.trna144" & position==34),
              ), 
       aes(x=paste0(chr), y=deletion/pileup, color=treatment, group= interaction(treatment, rep, sample, gene))) +
  geom_point() +
  scale_color_manual("IO4", values= c("treated"="red", "untreated"="black")) +
  scale_y_continuous(breaks=c(0,0.05, 0.1, 0.15)) +
  coord_cartesian(ylim = c(0,0.15)) +
  ylab("Deletion fraction") +
  theme(axis.text.x = element_text(angle=0, vjust=0.5, size=10),
        axis.title.x = element_blank(),
        legend.position = "none")


# plot2 <- ggplot(filter(temp, position%in% c(34,35), base=="G",
#               # (chr=="chr1.trna69" & position==34)|(chr=="chr12.trna5" & position==34)|(chr=="chr6.trna144" & position==34),
#               ), 
#        aes(x=paste0(AA, anticodon, "\n",chr), y=pileup/total_count*1000000, color=treatment, group= interaction(treatment, rep, sample, gene))) +
#   geom_point() +
#   scale_color_manual("IO4", values= c("treated"="red", "untreated"="black")) +
#   ylab("Abundance (RPM)") +
#   coord_cartesian(ylim = c(100,10000)) +
#   scale_y_log10(breaks=c(100,300,1000,3000,10000)) +
#   scale_y_log10() +
#   theme(axis.text.x = element_text(angle=90, vjust=0.5, size=10),
#         axis.title.x = element_blank(),
#         legend.position = "none")

layout <- rbind(c(1))
figure <- grid.arrange(plot1,  layout_matrix = layout)

path="../Draft/Figures20220128/"
figure_name="fig_3d_Asn_isodecoders"
width=1.75
height=1.5
scale=1.5
dpi=600
# ggsave(paste0(path, figure_name,".svg"), 
#        plot = figure,
#        scale = scale,
#        dpi = dpi,
#        width = width, 
#        height = height)

ggsave(paste0(path, figure_name,".png"),
       plot = figure,
       scale = scale,
       dpi = dpi,
       width = width,
       height = height)


```





#_
#Figure 4 - thio
##Fig 4B - tau-m5-s2-U
```{r}

temp_most <- Q_base %>%
  filter(project=="Q") %>%
  filter(bin_start=="60",
         sample=="Q100",
         treatment=="plusI",
         pileup >=500) %>%
  group_by(AA, anticodon) %>%
  filter(position > 25, position < 40) %>%
  mutate(pileup_max = max(pileup)) %>%
  filter(pileup == pileup_max) %>%
  select(AA, anticodon, chr, gene)

temp2 <- data.frame(AA=c("mtGln", "mtGlu", "mtLys"), Qposition = c(34,31,29))

temp1 <- Q_base %>%
  filter(project=="Q") %>%
  filter(gene %in% temp_most$gene) %>%
  filter((AA=="mtGlu" ) | #Deletion
           (AA=="mtGln" ) |
           (AA=="mtLys" ),
         bin_start=="60",
         sample == "Q0",
         pileup >= 100) %>%
  mutate(modification = "τm5s2U34") %>%
  full_join(., temp2, by=c("AA"))


temp1$treatment <- recode(temp1$treatment, "minusI"="untreated", "plusI"="treated")
temp1$sample <- recode(temp1$sample, "Q0"="0Q", "Q100"="100Q")


plot1 <- ggplot(temp1, 
       aes(x=position - Qposition + 34, y=mutation, color=treatment, group=interaction(rep, treatment, sample))) +
  facet_nested(paste0(AA, anticodon) ~ modification ) +
  geom_line() +
  # geom_vline(aes(xintercept=Qposition), linetype=2, alpha=0.3) +
  geom_vline(xintercept = c(34), linetype=2, alpha=0.3) +
  coord_cartesian(xlim = c(29,39), ylim = c(0, 0.4) ) +
  scale_x_continuous(breaks=c(26,28,30,32,34,36,38)) +
  ylab("Mutation fraction") +
  xlab("position") +
  theme(legend.position = "none",#c(0.8,0.7),
        legend.background = element_rect(color="black", fill="white", linetype="solid")) +
  scale_color_manual("IO4", values= c("treated"="red", "untreated"="black")) +
  theme(axis.title.x = element_blank(),
        axis.text.x = element_text(angle=90, vjust=0.5)) 

plot2 <- ggplot(temp1, 
       aes(x=position - Qposition + 34, y=deletion / pileup, color=treatment, group=interaction(rep, treatment, sample))) +
  facet_nested(paste0(AA, anticodon) ~ modification ) +
  geom_line() +
  # geom_vline(aes(xintercept=Qposition), linetype=2, alpha=0.3) +
  geom_vline(xintercept = c(34), linetype=2, alpha=0.3) +
  coord_cartesian(xlim = c(29,39), ylim = c(0, 0.4) ) +
  scale_x_continuous(breaks=c(26,28,30,32,34,36,38)) +
  ylab("Deletion fraction") +
  xlab("position") +
  theme(legend.position = "none",#c(0.8,0.7),
        legend.background = element_rect(color="black", fill="white", linetype="solid")) +
  scale_color_manual("IO4", values= c("treated"="red", "untreated"="black")) +
  theme(axis.title.x = element_blank(),
        axis.text.x = element_text(angle=90, vjust=0.5)) 

layout <- rbind(c(1, 2))
figure <- grid.arrange(plot1, plot2,  layout_matrix = layout)

path="../Draft/Figures20220128/"
figure_name="fig_4b_human_tm5s2U34_trace_deletion"
width=3
height=3
scale=1.5
dpi=600
# ggsave(paste0(path, figure_name,".svg"), 
#        plot = figure,
#        scale = scale,
#        dpi = dpi,
#        width = width, 
#        height = height)

ggsave(paste0(path, figure_name,".png"),
       plot = figure,
       scale = scale,
       dpi = dpi,
       width = width,
       height = height)

```

##Fig 4C - taurine control
```{r}
temp_most <- Q_base %>%
  filter(project=="Q") %>%
  filter(bin_start=="60",
         sample=="Q100",
         treatment=="plusI",
         pileup >=500) %>%
  group_by(AA, anticodon) %>%
  filter(position > 25, position < 40) %>%
  mutate(pileup_max = max(pileup)) %>%
  filter(pileup == pileup_max) %>%
  select(AA, anticodon, chr, gene)

temp2 <- data.frame(AA=c("mtTrp", "mtLeu"), Qposition = c(33,36))

temp1 <- Q_base %>%
  filter(project=="Q") %>%
  filter(gene %in% temp_most$gene) %>%
  filter((AA=="mtTrp" ) | #Deletion
           (AA=="mtLeu" & anticodon == "TAA" ),
         bin_start=="60",
         # sample == "Q100",
         pileup >= 100) %>%
  mutate(modification = "τ5mU34") %>%
  full_join(., temp2, by=c("AA"))

temp1$treatment <- recode(temp1$treatment, "minusI"="untreated", "plusI"="treated")
temp1$sample <- recode(temp1$sample, "Q0"="0Q", "Q100"="100Q")


plot1 <- ggplot(temp1, 
       aes(x=position - Qposition + 34, y=mutation, color=treatment, group=interaction(rep, treatment, sample))) +
  facet_nested(paste0(AA, anticodon) ~ modification ) +
  geom_line() +
  # geom_vline(aes(xintercept=Qposition), linetype=2, alpha=0.3) +
  geom_vline(xintercept = c(34), linetype=2, alpha=0.3) +
  coord_cartesian(xlim = c(29,39), ylim = c(0, 0.4) ) +
  scale_x_continuous(breaks=c(26,28,30,32,34,36,38)) +
  ylab("Mutation fraction") +
  xlab("position") +
  theme(legend.position = "none",#c(0.8,0.7),
        legend.background = element_rect(color="black", fill="white", linetype="solid")) +
  scale_color_manual("IO4", values= c("treated"="red", "untreated"="black")) +
  theme(axis.title.x = element_blank(),
        axis.text.x = element_text(angle=90, vjust=0.5)) 

plot2 <- ggplot(temp1, 
       aes(x=position - Qposition + 34, y=deletion / pileup, color=treatment, group=interaction(rep, treatment, sample))) +
  facet_nested(paste0(AA, anticodon) ~ modification ) +
  geom_line() +
  # geom_vline(aes(xintercept=Qposition), linetype=2, alpha=0.3) +
  geom_vline(xintercept = c(34), linetype=2, alpha=0.3) +
  coord_cartesian(xlim = c(29,39), ylim = c(0, 0.4) ) +
  scale_x_continuous(breaks=c(26,28,30,32,34,36,38)) +
  ylab("Deletion fraction") +
  xlab("position") +
  theme(legend.position = "none",#c(0.8,0.7),
        legend.background = element_rect(color="black", fill="white", linetype="solid")) +
  scale_color_manual("IO4", values= c("treated"="red", "untreated"="black")) +
  theme(axis.title.x = element_blank(),
        axis.text.x = element_text(angle=90, vjust=0.5)) 

layout <- rbind(c(1,2))
figure <- grid.arrange(plot1, plot2,  layout_matrix = layout)

path="../Draft/Figures20220128/"
figure_name="fig_4c_human_turine_traces"
width=3
height=2.25
scale=1.5
dpi=600
# ggsave(paste0(path, figure_name,".svg"), 
#        plot = figure,
#        scale = scale,
#        dpi = dpi,
#        width = width, 
#        height = height)

ggsave(paste0(path, figure_name,".png"),
       plot = figure,
       scale = scale,
       dpi = dpi,
       width = width,
       height = height)

```


##Fig 4D - mnm5s2U34
```{r}
temp_most <- Q_base %>%
  filter(project=="Q") %>%
  filter(bin_start=="60",
         sample=="Q100",
         treatment=="plusI",
         pileup >=500) %>%
  group_by(AA, anticodon) %>%
  filter(position > 25, position < 40) %>%
  mutate(pileup_max = max(pileup)) %>%
  filter(pileup == pileup_max) %>%
  select(AA, anticodon, chr, gene) 

temp2 <- data.frame(AA=c("Arg", "Gln", "Glu"), Qposition = c(34,34,34))

temp1 <- Q_base %>%
  filter(project=="Q") %>%
  filter(gene %in% temp_most$gene) %>%
  filter((AA=="Arg" & anticodon=="TCT") | #Mutation
           (AA=="Glu" & anticodon =="TTC") |
           (AA=="Gln" & anticodon =="TTG"),
         bin_start=="60",
         sample == "Q0",
         pileup >= 100) %>%
  mutate(modification = "mcm5s2U34")  %>%
  full_join(., temp2, by=c("AA"))

temp1$treatment <- recode(temp1$treatment, "minusI"="untreated", "plusI"="treated")
temp1$sample <- recode(temp1$sample, "Q0"="0Q", "Q100"="100Q")


plot1 <- ggplot(temp1, 
       aes(x=position - Qposition + 34, y=mutation, color=treatment, group=interaction(rep, treatment, sample))) +
  facet_nested(paste0(AA, anticodon) ~ modification ) +
  geom_line() +
  # geom_vline(aes(xintercept=Qposition), linetype=2, alpha=0.3) +
  geom_vline(xintercept = c(34), linetype=2, alpha=0.3) +
  coord_cartesian(xlim = c(29,39), ylim = c(0, 0.8) ) +
  scale_x_continuous(breaks=c(26,28,30,32,34,36,38)) +
  ylab("Mutation fraction") +
  xlab("position") +
  theme(legend.position = "none",#c(0.8,0.7),
        legend.background = element_rect(color="black", fill="white", linetype="solid")) +
  scale_color_manual("IO4", values= c("treated"="red", "untreated"="black")) +
  theme(axis.title.x = element_blank(),
        axis.text.x = element_text(angle=90, vjust=0.5)) 

plot2 <- ggplot(temp1, 
       aes(x=position - Qposition + 34, y=deletion / pileup, color=treatment, group=interaction(rep, treatment, sample))) +
  facet_nested(paste0(AA, anticodon) ~ modification ) +
  geom_line() +
  # geom_vline(aes(xintercept=Qposition), linetype=2, alpha=0.3) +
  geom_vline(xintercept = c(34), linetype=2, alpha=0.3) +
  coord_cartesian(xlim = c(29,39), ylim = c(0, 0.8) ) +
  scale_x_continuous(breaks=c(26,28,30,32,34,36,38)) +
  ylab("Deletion fraction") +
  xlab("position") +
  theme(legend.position = "none",#c(0.8,0.7),
        legend.background = element_rect(color="black", fill="white", linetype="solid")) +
  scale_color_manual("IO4", values= c("treated"="red", "untreated"="black")) +
  theme(axis.title.x = element_blank(),
        axis.text.x = element_text(angle=90, vjust=0.5)) 

layout <- rbind(c(1,2))
figure <- grid.arrange(plot1, plot2,  layout_matrix = layout)

path="../Draft/Figures20220128/"
figure_name="fig_4d_human_mcm5s2U34_trace"
width=3
height=3
scale=1.5
dpi=600
# ggsave(paste0(path, figure_name,".svg"), 
#        plot = figure,
#        scale = scale,
#        dpi = dpi,
#        width = width, 
#        height = height)

ggsave(paste0(path, figure_name,".png"),
       plot = figure,
       scale = scale,
       dpi = dpi,
       width = width,
       height = height)



```



##Fig 4E - isodecoders mcm5s2u34
###Arg TCT
```{r}
#==========ArgTCT=============================


#To do RPM normalization, gott know how many reads in each sample
temp1 <- Q_count %>%
  filter(project=="Q",
         bin_start %nin% c("-1", "-2", "-3")) %>%
  group_by(treatment, rep, sample) %>%
  summarise(total_count = sum(count))
temp1 <-  Q_base %>%
  filter(bin_start %nin% c("-1","-2","-3")) %>%
  full_join(., temp1, by=c("treatment","rep","sample")) %>%
  filter(pileup >= 0)



#This one's a pain because two isodecoders are actually identical, so I should combine them
temp1 <- temp1 %>%
  filter(project=="Q") %>%
  # filter(gene %in% temp_most$gene) %>%
  filter(#(AA=="Arg" & position==34 & base=="T" & anticodon=="TCT") | #Mutation
           (AA=="Arg" & position==34 & base=="T" & anticodon =="TCT"),
           chr %in% c( "chr11.trna3","chr9.trna4"),
         ) %>%
  mutate(chr="chr11.trna3", 
         gene="Homo_sapiens_chr11.trna3-ArgTCT") %>% #rename and combine them
  group_by(file_name, gene, position, base, bin_start, bin_stop, sample,  project, rep,  treatment, source, chr, AA, anticodon) %>%
  summarise(pileup = sum(pileup), stop = mean(stop), mutation = mean(mutation), A=sum(A), C=sum(C), G=sum(G), T=sum(T), N=sum(N),
            deletion=sum(deletion), insertion=sum(insertion), total_count = mean(total_count)) %>%
  rbind(filter(temp1, project=="Q",
         (AA=="Arg" & position==34 & base=="T" & anticodon =="TCT"),
           chr %in% c("chr1.trna9","chr17.trna4") )) %>%
  filter(bin_start=="60",
         sample == "Q0",
         pileup >= 10) %>%
  mutate(modification = "mcm5s2U")
temp1$treatment <- recode(temp1$treatment, "minusI"="untreated", "plusI"="treated")
temp1$chr <- recode(temp1$chr, "chr1.trna9"="1","chr17.trna4"="3","chr11.trna3"="2")
temp1$sample <- recode(temp1$sample, "Q0"="0Q", "Q100"="100Q")

plot1  <- ggplot(temp1, 
       aes(x=paste0(chr), y=mutation, color=treatment)) +
  # facet_grid(rows=vars(sample)) +
  geom_point() +
  ylab("Mutation fraction") +
  coord_cartesian(ylim = c(0,0.6)) +
  scale_y_continuous(breaks=c(0,0.2,0.4,0.6)) +
  theme(legend.position = "none",#c(0.8,0.7),
        legend.background = element_rect(color="black", fill="white", linetype="solid")) +
  scale_color_manual("IO4", values= c("treated"="red", "untreated"="black")) +
  theme(axis.title.x = element_blank(),
        axis.text.x = element_text(angle=0, vjust=0.5))

# plot2  <- ggplot(temp1, 
#        aes(x=paste0(chr), y=pileup / total_count *1000000, color=treatment)) +
#   # facet_nested(~ modification ) +
#   geom_point() +
#   ylab("Abundance (RPM)") +
#   coord_cartesian(ylim=c(10,10000)) +
#   scale_y_log10(labels=trans_format('log10',math_format(10^.x))) +
#   theme(legend.position = "none",#c(0.8,0.7),
#         legend.background = element_rect(color="black", fill="white", linetype="solid")) +
#   scale_color_manual("IO4", values= c("treated"="red", "untreated"="black")) +
#   theme(axis.title.x = element_blank(),
#         axis.text.x = element_text(angle=0, vjust=0.5)) 

layout <- rbind(c(1))
figure <- grid.arrange(plot1,  layout_matrix = layout)

path="../Draft/Figures20220128/"
figure_name="fig_4e_human_mcm5s2U34_isodecoders-Arg"
width=1.5
height=1.5
scale=1.5
dpi=600
# ggsave(paste0(path, figure_name,".svg"), 
#        plot = figure,
#        scale = scale,
#        dpi = dpi,
#        width = width, 
#        height = height)

ggsave(paste0(path, figure_name,".png"),
       plot = figure,
       scale = scale,
       dpi = dpi,
       width = width,
       height = height)

```

###Gln TTG
```{r}
#================  Gln TTG ===================
#To do RPM normalization, gott know how many reads in each sample
temp1 <- Q_count %>%
  filter(project=="Q",
         bin_start %nin% c("-1", "-2", "-3")) %>%
  group_by(treatment, rep, sample) %>%
  summarise(total_count = sum(count))
temp1 <-  Q_base %>%
  filter(bin_start %nin% c("-1","-2","-3") ) %>%
  full_join(., temp1, by=c("treatment","rep","sample")) %>%
  filter(pileup >= 0)

temp1 <- temp1 %>%
  filter(project=="Q") %>%
  # filter(gene %in% temp_most$gene) %>%
  filter(#(AA=="Arg" & position==34 & base=="T" & anticodon=="TCT") | #Mutation
           (AA=="Gln" & position==34 & base=="T" & anticodon =="TTG"),
           chr %in% c("chr17.trna16", "chr6.trna130","chr6.trna64"),
           #(AA=="Gln" & position ==34 & base=="T" & anticodon =="TTG"),
         bin_start=="60",
         sample == "Q0",
         pileup >= 10
         ) %>%
  mutate(modification = "mcm5s2U")
temp1$treatment <- recode(temp1$treatment, "minusI"="untreated", "plusI"="treated")
temp1$chr <- recode(temp1$chr, "chr17.trna16"="2","chr6.trna130"="1","chr6.trna64"="3")
temp1$sample <- recode(temp1$sample, "Q0"="0Q", "Q100"="100Q")

plot1  <- ggplot(temp1, 
       aes(x=paste0(chr), y=mutation, color=treatment)) +
  # facet_grid(rows=vars(sample)) +
  geom_point() +
  ylab("Mutation fraction") +
  coord_cartesian(ylim = c(0,0.6)) +
  scale_y_continuous(breaks=c(0,0.2,0.4,0.6)) +
  theme(legend.position = "none",#c(0.8,0.7),
        legend.background = element_rect(color="black", fill="white", linetype="solid")) +
  scale_color_manual("IO4", values= c("treated"="red", "untreated"="black")) +
  theme(axis.title.x = element_blank(),
        axis.text.x = element_text(angle=0, vjust=0.5))

# plot2  <- ggplot(temp1, 
#        aes(x=paste0(chr), y=pileup / total_count *1000000, color=treatment)) +
#   # facet_nested(~ modification ) +
#   geom_point() +
#   ylab("Abundance (RPM)") +
#   coord_cartesian(ylim=c(10,10000)) +
#   scale_y_log10(labels=trans_format('log10',math_format(10^.x))) +
#   theme(legend.position = "none",#c(0.8,0.7),
#         legend.background = element_rect(color="black", fill="white", linetype="solid")) +
#   scale_color_manual("IO4", values= c("treated"="red", "untreated"="black")) +
#   theme(axis.title.x = element_blank(),
#         axis.text.x = element_text(angle=0, vjust=0.5)) 

layout <- rbind(c(1))
figure <- grid.arrange(plot1,  layout_matrix = layout)

path="../Draft/Figures20220128/"
figure_name="fig_4e_human_mcm5s2U34_isodecoders-Gln"
width=1.5
height=1.5
scale=1.5
dpi=600
# ggsave(paste0(path, figure_name,".svg"), 
#        plot = figure,
#        scale = scale,
#        dpi = dpi,
#        width = width, 
#        height = height)

ggsave(paste0(path, figure_name,".png"),
       plot = figure,
       scale = scale,
       dpi = dpi,
       width = width,
       height = height)

```


###Glu TTC
```{r}
#To do RPM normalization, gott know how many reads in each sample
temp1 <- Q_count %>%
  filter(project=="Q",
         bin_start %nin% c("-1", "-2", "-3")) %>%
  group_by(treatment, rep, sample) %>%
  summarise(total_count = sum(count))
temp1 <-  Q_base %>%
  filter(bin_start %nin% c("-1","-2","-3") ) %>%
  full_join(., temp1, by=c("treatment","rep","sample")) %>%
  filter(pileup >= 0)

temp1 <- temp1 %>%
  filter(project=="Q") %>%
  # filter(gene %in% temp_most$gene) %>%
  filter(#(AA=="Arg" & position==34 & base=="T" & anticodon=="TCT") | #Mutation
           (AA=="Glu" & position==34 & base=="T" & anticodon =="TTC"),
           chr %in% c("chr1.trna134", "chr1.trna5","chr13.trna3","chr13.trna5"),
           #(AA=="Gln" & position ==34 & base=="T" & anticodon =="TTG"),
         bin_start=="60",
         sample == "Q0",
         pileup >= 10
         ) %>%
  mutate(modification = "mcm5s2u34")
temp1$treatment <- recode(temp1$treatment, "minusI"="untreated", "plusI"="treated")
temp1$chr <- recode(temp1$chr, "chr13.trna5"="1","chr13.trna3"="2","chr1.trna134"="3", "chr1.trna5"="4")
temp1$sample <- recode(temp1$sample, "Q0"="0Q", "Q100"="100Q")

plot1  <- ggplot(temp1, 
       aes(x=paste0(chr), y=mutation, color=treatment)) +
  # facet_grid(rows=vars(sample)) +
  geom_point() +
  ylab("Mutation fraction") +
  coord_cartesian(ylim = c(0,0.6)) +
  scale_y_continuous(breaks=c(0,0.2,0.4,0.6)) +
  theme(legend.position = "none",#c(0.8,0.7),
        legend.background = element_rect(color="black", fill="white", linetype="solid")) +
  scale_color_manual("IO4", values= c("treated"="red", "untreated"="black")) +
  theme(axis.title.x = element_blank(),
        axis.text.x = element_text(angle=0, vjust=0.5))

# plot2  <- ggplot(temp1, 
#        aes(x=paste0(chr), y=pileup / total_count *1000000, color=treatment)) +
#   # facet_nested(~ modification ) +
#   geom_point() +
#   ylab("Abundance (RPM)") +
#   coord_cartesian(ylim=c(10,10000)) +
#   scale_y_log10(labels=trans_format('log10',math_format(10^.x))) +
#   theme(legend.position = "none",#c(0.8,0.7),
#         legend.background = element_rect(color="black", fill="white", linetype="solid")) +
#   scale_color_manual("IO4", values= c("treated"="red", "untreated"="black")) +
#   theme(axis.title.x = element_blank(),
#         axis.text.x = element_text(angle=0, vjust=0.5)) 

layout <- rbind(c(1))
figure <- grid.arrange(plot1,  layout_matrix = layout)

path="../Draft/Figures20220128/"
figure_name="fig_4e_human_mcm5s2U34_isodecoders-Glu"
width=1.5
height=1.5
scale=1.5
dpi=600
# ggsave(paste0(path, figure_name,".svg"), 
#        plot = figure,
#        scale = scale,
#        dpi = dpi,
#        width = width, 
#        height = height)

ggsave(paste0(path, figure_name,".png"),
       plot = figure,
       scale = scale,
       dpi = dpi,
       width = width,
       height = height)

```






#_
#Figure 5 - E.coli
##Fig 5B - cmnm5s2U34
```{r}
temp2 <- data.frame(amino_acid=c("Gln", "Glu"), Qposition = c(33,35))

temp1 <- Ecoli_base %>%
  filter(bin_start == "60",
         (anticodon %in% c("TTG", "TTC") ), #& position ==33 & base=="T"), #both
         pileup >= 100) %>%
  mutate(modification = "cmnm5s2U34") %>%
  full_join(., temp2, by=c("amino_acid"))



plot1 <- ggplot(temp1,
       aes(x=position - Qposition + 34, y=mutation, color=treatment)) +
  facet_nested(paste0(amino_acid, anticodon) ~ modification ) +
  geom_line() +
  # geom_vline(aes(xintercept=Qposition), linetype=2, alpha=0.3) +
  geom_vline(xintercept = c(34), linetype=2, alpha=0.3) +
  coord_cartesian(xlim = c(29,39), ylim = c(0, 0.4) ) +
  scale_x_continuous(breaks=c(26,28,30,32,34,36,38)) +
  ylab("Mutation fraction") +
  xlab("position") +
  theme(legend.position = "none",#c(0.8,0.7),
        legend.background = element_rect(color="black", fill="white", linetype="solid")) +
  scale_color_manual("IO4", values= c("treated"="red", "untreated"="black")) +
  theme(axis.title.x = element_blank(),
        axis.text.x = element_text(angle=90, vjust=0.5)) 

plot2 <- ggplot(temp1, 
       aes(x=position - Qposition + 34, y=deletion / pileup, color=treatment)) +
  facet_nested(paste0(amino_acid, anticodon) ~ modification ) +
  geom_line() +
  # geom_vline(aes(xintercept=Qposition), linetype=2, alpha=0.3) +
  geom_vline(xintercept = c(34), linetype=2, alpha=0.3) +
  coord_cartesian(xlim = c(29,39), ylim = c(0, 0.4) ) +
  scale_x_continuous(breaks=c(26,28,30,32,34,36,38)) +
  ylab("Deletion fraction") +
  xlab("position") +
  theme(legend.position = "none",#c(0.8,0.7),
        legend.background = element_rect(color="black", fill="white", linetype="solid")) +
  scale_color_manual("IO4", values= c("treated"="red", "untreated"="black")) +
  theme(axis.title.x = element_blank(),
        axis.text.x = element_text(angle=90, vjust=0.5)) 

layout <- rbind(c(1, 2))
figure <- grid.arrange(plot1, plot2,  layout_matrix = layout)

path="../Draft/Figures20220128/"
figure_name="fig_5b_Ecoli_cmnm5s2U34"
width=3
height=2.25
scale=1.5
dpi=600
# ggsave(paste0(path, figure_name,".svg"), 
#        plot = figure,
#        scale = scale,
#        dpi = dpi,
#        width = width, 
#        height = height)

ggsave(paste0(path, figure_name,".png"),
       plot = figure,
       scale = scale,
       dpi = dpi,
       width = width,
       height = height)

```



##Fig 5C - s2C32
```{r}
temp2 <- data.frame(anticodon=c("ACG", "CCG","CCT","TCT","GCT"), Qposition = c(33,33,32,33,33))

temp1 <- Ecoli_base %>%
  filter(bin_start == "60",
         (anticodon %in% c("ACG", "CCG","CCT","TCT","GCT") ), #& position ==33 & base=="T"), #both
         pileup >= 10) %>%
  mutate(modification = "s2C32") %>%
  full_join(., temp2, by=c("anticodon"))



plot1 <- ggplot(temp1,
       aes(x=position - Qposition + 32, y=mutation, color=treatment)) +
  facet_nested(paste0(amino_acid, anticodon) ~ modification ) +
  geom_line() +
  # geom_text(aes(label=base),  y=0.1) +
  # geom_vline(aes(xintercept=Qposition), linetype=2, alpha=0.3) +
  geom_vline(xintercept = c(32), linetype=2, alpha=0.3) +
  coord_cartesian(xlim = c(27,37), ylim = c(0, 0.7) ) +
  scale_x_continuous(breaks=c(26,28,30,32,34,36,38)) +
  ylab("Mutation fraction") +
  xlab("position") +
  theme(legend.position = "none",#c(0.8,0.7),
        legend.background = element_rect(color="black", fill="white", linetype="solid")) +
  scale_color_manual("IO4", values= c("treated"="red", "untreated"="black")) +
  theme(axis.title.x = element_blank(),
        axis.text.x = element_text(angle=90, vjust=0.5)) 

plot2 <- ggplot(temp1, 
       aes(x=position - Qposition + 32, y=deletion / pileup, color=treatment)) +
  facet_nested(paste0(amino_acid, anticodon) ~ modification ) +
  geom_line() +
  # geom_vline(aes(xintercept=Qposition), linetype=2, alpha=0.3) +
  geom_vline(xintercept = c(32), linetype=2, alpha=0.3) +
  coord_cartesian(xlim = c(27,37), ylim = c(0, 0.7) ) +
  scale_x_continuous(breaks=c(26,28,30,32,34,36,38)) +
  ylab("Deletion fraction") +
  xlab("position") +
  theme(legend.position = "none",#c(0.8,0.7),
        legend.background = element_rect(color="black", fill="white", linetype="solid")) +
  scale_color_manual("IO4", values= c("treated"="red", "untreated"="black")) +
  theme(axis.title.x = element_blank(),
        axis.text.x = element_text(angle=90, vjust=0.5)) 

layout <- rbind(c(1, 2))
figure <- grid.arrange(plot1, plot2,  layout_matrix = layout)

path="../Draft/Figures20220128/"
figure_name="fig_5c_Ecoli_s2C32"
width=3
height=5
scale=1.5
dpi=600
# ggsave(paste0(path, figure_name,".svg"), 
#        plot = figure,
#        scale = scale,
#        dpi = dpi,
#        width = width, 
#        height = height)

ggsave(paste0(path, figure_name,".png"),
       plot = figure,
       scale = scale,
       dpi = dpi,
       width = width,
       height = height)

```


##Fig 5D - s2U8
```{r}
temp2 <- data.frame(anticodon=c("GTG"), Qposition = c(8))

temp1 <- Ecoli_base %>%
  filter(bin_start == "60",
         (anticodon %in% c("GTG") ), #& position ==33 & base=="T"), #both
         pileup >= 10) %>%
  mutate(modification = "s4U8") %>%
  full_join(., temp2, by=c("anticodon"))


plot1 <- ggplot(temp1,
       aes(x=position - Qposition + 8, y=mutation, color=treatment)) +
  facet_nested(paste0(amino_acid, anticodon) ~ modification ) +
  geom_line() +
  # geom_text(aes(label=base),  y=0.1) +
  # geom_vline(aes(xintercept=Qposition), linetype=2, alpha=0.3) +
  geom_vline(xintercept = c(8), linetype=2, alpha=0.3) +
  coord_cartesian(xlim = c(3,13), ylim = c(0, 0.1) ) +
  scale_x_continuous(breaks=c(4,6,8,10,12)) +
  scale_y_continuous(breaks=c(0,0.05,0.10))  +
  ylab("Mutation fraction") +
  xlab("position") +
  theme(legend.position = "none",#c(0.8,0.7),
        legend.background = element_rect(color="black", fill="white", linetype="solid")) +
  scale_color_manual("IO4", values= c("treated"="red", "untreated"="black")) +
  theme(axis.title.x = element_blank(),
        axis.text.x = element_text(angle=90, vjust=0.5)) 

plot2 <- ggplot(temp1, 
       aes(x=position - Qposition + 8, y=deletion / pileup, color=treatment)) +
  facet_nested(paste0(amino_acid, anticodon) ~ modification ) +
  geom_line() +
  # geom_vline(aes(xintercept=Qposition), linetype=2, alpha=0.3) +
  geom_vline(xintercept = c(8), linetype=2, alpha=0.3) +
  coord_cartesian(xlim = c(3,13), ylim = c(0, 0.1) ) +
  scale_x_continuous(breaks=c(4,6,8,10,12)) +
  scale_y_continuous(breaks= c(0,0.05,0.10))  +
  ylab("Deletion fraction") +
  xlab("position") +
  theme(legend.position = "none",#c(0.8,0.7),
        legend.background = element_rect(color="black", fill="white", linetype="solid")) +
  scale_color_manual("IO4", values= c("treated"="red", "untreated"="black")) +
  theme(axis.title.x = element_blank(),
        axis.text.x = element_text(angle=90, vjust=0.5)) 

layout <- rbind(c(1, 2))
figure <- grid.arrange(plot1, plot2,  layout_matrix = layout)

path="../Draft/Figures20220128/"
figure_name="fig_5d_Ecoli_s2U8"
width=3
height=1.25
scale=1.5
dpi=600
# ggsave(paste0(path, figure_name,".svg"), 
#        plot = figure,
#        scale = scale,
#        dpi = dpi,
#        width = width, 
#        height = height)

ggsave(paste0(path, figure_name,".png"),
       plot = figure,
       scale = scale,
       dpi = dpi,
       width = width,
       height = height)

```


##Fig 5E - Stress cmnm5s2U34
```{r}

temp <- EcoliStress_base %>%
  filter(bin_start=="60") %>%
  filter( (AA=="Gln" & anticodon=="TTG" & position==33) | 
            (AA=="Glu" & anticodon=="TTC" & position==35)) %>%
  filter(DM=="minus")

temp <- temp %>%
  filter(treatment =="None") %>%
  group_by(AA, anticodon) %>%
  summarise(mean_of_control = mean(mutation)) %>%
  full_join(., temp, by=c("AA", "anticodon"))

temp$treatment <- factor(temp$treatment, levels=c("None", "DIP","H2O2","aMG"))
my_comparisons <- list( c("None", "DIP"),
                        c("None", "H2O2"),
                        c("None","aMG")
                        )
plot1 <- ggplot(filter(temp),
       aes(x=treatment, y= mutation - mean_of_control )) +
  geom_boxplot()  +
  geom_point()  +
  ylab("Difference from mean of 'None'") +
  # geom_line(aes(group=interaction(AA, anticodon, rep)), alpha=0.3) +
  coord_cartesian(ylim = c(-0.2, 0.3)) +
  # scale_y_log10() +
  stat_compare_means(comparisons = my_comparisons, size=4,
                     method="wilcox.test",
                     label="p.signif",
                     paired=F
                     ) 

layout <- rbind(c(1))
figure <- grid.arrange(plot1,  layout_matrix = layout)

path="../Draft/Figures20220128/"
figure_name="fig_5e_Ecoli_stress_cmnm5s2U34"
width=2
height=2.5
scale=1.5
dpi=600
# ggsave(paste0(path, figure_name,".svg"), 
#        plot = figure,
#        scale = scale,
#        dpi = dpi,
#        width = width, 
#        height = height)

ggsave(paste0(path, figure_name,".png"),
       plot = figure,
       scale = scale,
       dpi = dpi,
       width = width,
       height = height)

```


##Fig 5F - Stress s2U32
```{r}
temp <- EcoliStress_base %>%
  filter(bin_start=="60") %>%
  filter( (AA=="Arg" & anticodon=="ACG" & position==33) | 
            (AA=="Arg" & anticodon=="CCG" & position==33)|
            (AA=="Arg" & anticodon=="CCT" & position==32) |
            (AA=="Arg" & anticodon=="TCT" & position==32) |
           (AA=="Ser" & anticodon=="GCT" & position==33)) %>%
  filter(DM=="minus")

temp <- temp %>%
  filter(treatment =="None") %>%
  group_by(AA, anticodon) %>%
  summarise(mean_of_control = mean(mutation)) %>%
  full_join(., temp, by=c("AA", "anticodon"))

temp$treatment <- factor(temp$treatment, levels=c("None", "DIP","H2O2","aMG"))
my_comparisons <- list( c("None", "DIP"),
                        c("None", "H2O2"),
                        c("None","aMG")
                        )
plot1 <- ggplot(filter(temp),
       aes(x=treatment, y= mutation - mean_of_control )) +
  geom_boxplot()  +
  geom_point()  +
  coord_cartesian(ylim = c(-0.2, 0.3)) +
  ylab("Difference from mean of 'None'") +
  # geom_line(aes(group=interaction(AA, anticodon, rep)), ) +
  # scale_y_log10() +
  stat_compare_means(comparisons = my_comparisons, size=4,
                     method="wilcox.test",
                     label="p.signif",
                     paired=F
                     ) 

layout <- rbind(c(1))
figure <- grid.arrange(plot1,  layout_matrix = layout)

path="../Draft/Figures20220128/"
figure_name="fig_5f_Ecoli_stress_s2U34"
width=2
height=2.5
scale=1.5
dpi=600
# ggsave(paste0(path, figure_name,".svg"), 
#        plot = figure,
#        scale = scale,
#        dpi = dpi,
#        width = width, 
#        height = height)

ggsave(paste0(path, figure_name,".png"),
       plot = figure,
       scale = scale,
       dpi = dpi,
       width = width,
       height = height)

```




#_
#Figure S2 - isodecoders 100Q
##Fig s2a - tau-m5-s2-U
```{r}

temp_most <- Q_base %>%
  filter(project=="Q") %>%
  filter(bin_start=="60",
         sample=="Q100",
         treatment=="plusI",
         pileup >=500) %>%
  group_by(AA, anticodon) %>%
  filter(position > 25, position < 40) %>%
  mutate(pileup_max = max(pileup)) %>%
  filter(pileup == pileup_max) %>%
  select(AA, anticodon, chr, gene)

temp2 <- data.frame(AA=c("mtGln", "mtGlu", "mtLys"), Qposition = c(34,31,29))

temp1 <- Q_base %>%
  filter(project=="Q") %>%
  filter(gene %in% temp_most$gene) %>%
  filter((AA=="mtGlu" ) | #Deletion
           (AA=="mtGln" ) |
           (AA=="mtLys" ),
         bin_start=="60",
         sample == "Q100",
         pileup >= 100) %>%
  mutate(modification = "τm5s2U34") %>%
  full_join(., temp2, by=c("AA"))


temp1$treatment <- recode(temp1$treatment, "minusI"="untreated", "plusI"="treated")
temp1$sample <- recode(temp1$sample, "Q0"="0Q", "Q100"="100Q")


plot1 <- ggplot(temp1, 
       aes(x=position - Qposition + 34, y=mutation, color=treatment, group=interaction(rep, treatment, sample))) +
  facet_nested(paste0(AA, anticodon) ~ modification ) +
  geom_line() +
  # geom_vline(aes(xintercept=Qposition), linetype=2, alpha=0.3) +
  geom_vline(xintercept = c(34), linetype=2, alpha=0.3) +
  coord_cartesian(xlim = c(29,39), ylim = c(0, 0.4) ) +
  scale_x_continuous(breaks=c(26,28,30,32,34,36,38)) +
  ylab("Mutation fraction") +
  xlab("position") +
  theme(legend.position = "none",#c(0.8,0.7),
        legend.background = element_rect(color="black", fill="white", linetype="solid")) +
  scale_color_manual("IO4", values= c("treated"="red", "untreated"="black")) +
  theme(axis.title.x = element_blank(),
        axis.text.x = element_text(angle=90, vjust=0.5)) 

plot2 <- ggplot(temp1, 
       aes(x=position - Qposition + 34, y=deletion / pileup, color=treatment, group=interaction(rep, treatment, sample))) +
  facet_nested(paste0(AA, anticodon) ~ modification ) +
  geom_line() +
  # geom_vline(aes(xintercept=Qposition), linetype=2, alpha=0.3) +
  geom_vline(xintercept = c(34), linetype=2, alpha=0.3) +
  coord_cartesian(xlim = c(29,39), ylim = c(0, 0.4) ) +
  scale_x_continuous(breaks=c(26,28,30,32,34,36,38)) +
  ylab("Deletion fraction") +
  xlab("position") +
  theme(legend.position = "none",#c(0.8,0.7),
        legend.background = element_rect(color="black", fill="white", linetype="solid")) +
  scale_color_manual("IO4", values= c("treated"="red", "untreated"="black")) +
  theme(axis.title.x = element_blank(),
        axis.text.x = element_text(angle=90, vjust=0.5)) 

layout <- rbind(c(1, 2))
figure <- grid.arrange(plot1, plot2,  layout_matrix = layout)

path="../Draft/Figures20220128/"
figure_name="fig_s2a_human_tm5s2U34_trace_100Q"
width=3
height=3
scale=1.5
dpi=600
# ggsave(paste0(path, figure_name,".svg"), 
#        plot = figure,
#        scale = scale,
#        dpi = dpi,
#        width = width, 
#        height = height)

ggsave(paste0(path, figure_name,".png"),
       plot = figure,
       scale = scale,
       dpi = dpi,
       width = width,
       height = height)

```



##Fig s2b - mcm5s2U34
```{r}
temp_most <- Q_base %>%
  filter(project=="Q") %>%
  filter(bin_start=="60",
         sample=="Q100",
         treatment=="plusI",
         pileup >=500) %>%
  group_by(AA, anticodon) %>%
  filter(position > 25, position < 40) %>%
  mutate(pileup_max = max(pileup)) %>%
  filter(pileup == pileup_max) %>%
  select(AA, anticodon, chr, gene) 

temp2 <- data.frame(AA=c("Arg", "Gln", "Glu"), Qposition = c(34,34,34))

temp1 <- Q_base %>%
  filter(project=="Q") %>%
  filter(gene %in% temp_most$gene) %>%
  filter((AA=="Arg" & anticodon=="TCT") | #Mutation
           (AA=="Glu" & anticodon =="TTC") |
           (AA=="Gln" & anticodon =="TTG"),
         bin_start=="60",
         sample == "Q100",
         pileup >= 100) %>%
  mutate(modification = "mcm5s2u34")  %>%
  full_join(., temp2, by=c("AA"))

temp1$treatment <- recode(temp1$treatment, "minusI"="untreated", "plusI"="treated")
temp1$sample <- recode(temp1$sample, "Q0"="0Q", "Q100"="100Q")


plot1 <- ggplot(temp1, 
       aes(x=position - Qposition + 34, y=mutation, color=treatment, group=interaction(rep, treatment, sample))) +
  facet_nested(paste0(AA, anticodon) ~ modification ) +
  geom_line() +
  # geom_vline(aes(xintercept=Qposition), linetype=2, alpha=0.3) +
  geom_vline(xintercept = c(34), linetype=2, alpha=0.3) +
  coord_cartesian(xlim = c(29,39), ylim = c(0, 0.8) ) +
  scale_x_continuous(breaks=c(26,28,30,32,34,36,38)) +
  ylab("Mutation fraction") +
  xlab("position") +
  theme(legend.position = "none",#c(0.8,0.7),
        legend.background = element_rect(color="black", fill="white", linetype="solid")) +
  scale_color_manual("IO4", values= c("treated"="red", "untreated"="black")) +
  theme(axis.title.x = element_blank(),
        axis.text.x = element_text(angle=90, vjust=0.5)) 

plot2 <- ggplot(temp1, 
       aes(x=position - Qposition + 34, y=deletion / pileup, color=treatment, group=interaction(rep, treatment, sample))) +
  facet_nested(paste0(AA, anticodon) ~ modification ) +
  geom_line() +
  # geom_vline(aes(xintercept=Qposition), linetype=2, alpha=0.3) +
  geom_vline(xintercept = c(34), linetype=2, alpha=0.3) +
  coord_cartesian(xlim = c(29,39), ylim = c(0, 0.8) ) +
  scale_x_continuous(breaks=c(26,28,30,32,34,36,38)) +
  ylab("Deletion fraction") +
  xlab("position") +
  theme(legend.position = "none",#c(0.8,0.7),
        legend.background = element_rect(color="black", fill="white", linetype="solid")) +
  scale_color_manual("IO4", values= c("treated"="red", "untreated"="black")) +
  theme(axis.title.x = element_blank(),
        axis.text.x = element_text(angle=90, vjust=0.5)) 

layout <- rbind(c(1,2))
figure <- grid.arrange(plot1, plot2,  layout_matrix = layout)

path="../Draft/Figures20220128/"
figure_name="fig_s2b_human_mcm5s2U34_100Q"
width=3
height=3
scale=1.5
dpi=600
# ggsave(paste0(path, figure_name,".svg"), 
#        plot = figure,
#        scale = scale,
#        dpi = dpi,
#        width = width, 
#        height = height)

ggsave(paste0(path, figure_name,".png"),
       plot = figure,
       scale = scale,
       dpi = dpi,
       width = width,
       height = height)
```




##Fig s2C - isodecoders mcm5s2u34
###Arg TCT
```{r}
#==========ArgTCT=============================


#To do RPM normalization, gott know how many reads in each sample
temp1 <- Q_count %>%
  filter(project=="Q",
         bin_start %nin% c("-1", "-2", "-3")) %>%
  group_by(treatment, rep, sample) %>%
  summarise(total_count = sum(count))
temp1 <-  Q_base %>%
  filter(bin_start %nin% c("-1","-2","-3")) %>%
  full_join(., temp1, by=c("treatment","rep","sample")) %>%
  filter(pileup >= 0)



#This one's a pain because two isodecoders are actually identical, so I should combine them
temp1 <- temp1 %>%
  filter(project=="Q") %>%
  # filter(gene %in% temp_most$gene) %>%
  filter(#(AA=="Arg" & position==34 & base=="T" & anticodon=="TCT") | #Mutation
           (AA=="Arg" & position==34 & base=="T" & anticodon =="TCT"),
           chr %in% c( "chr11.trna3","chr9.trna4"),
         ) %>%
  mutate(chr="chr11.trna3", 
         gene="Homo_sapiens_chr11.trna3-ArgTCT") %>% #rename and combine them
  group_by(file_name, gene, position, base, bin_start, bin_stop, sample,  project, rep,  treatment, source, chr, AA, anticodon) %>%
  summarise(pileup = sum(pileup), stop = mean(stop), mutation = mean(mutation), A=sum(A), C=sum(C), G=sum(G), T=sum(T), N=sum(N),
            deletion=sum(deletion), insertion=sum(insertion), total_count = mean(total_count)) %>%
  rbind(filter(temp1, project=="Q",
         (AA=="Arg" & position==34 & base=="T" & anticodon =="TCT"),
           chr %in% c("chr1.trna9","chr17.trna4") )) %>%
  filter(bin_start=="60",
         sample == "Q100",
         pileup >= 10) %>%
  mutate(modification = "mcm5s2U")
temp1$treatment <- recode(temp1$treatment, "minusI"="untreated", "plusI"="treated")
temp1$chr <- recode(temp1$chr, "chr1.trna9"="1","chr17.trna4"="3","chr11.trna3"="2")
temp1$sample <- recode(temp1$sample, "Q0"="0Q", "Q100"="100Q")

plot1  <- ggplot(temp1, 
       aes(x=paste0(chr), y=mutation, color=treatment)) +
  # facet_grid(rows=vars(sample)) +
  geom_point() +
  ylab("Mutation fraction") +
  coord_cartesian(ylim = c(0,0.6)) +
  scale_y_continuous(breaks=c(0,0.2,0.4,0.6)) +
  theme(legend.position = "none",#c(0.8,0.7),
        legend.background = element_rect(color="black", fill="white", linetype="solid")) +
  scale_color_manual("IO4", values= c("treated"="red", "untreated"="black")) +
  theme(axis.title.x = element_blank(),
        axis.text.x = element_text(angle=0, vjust=0.5))

# plot2  <- ggplot(temp1, 
#        aes(x=paste0(chr), y=pileup / total_count *1000000, color=treatment)) +
#   # facet_nested(~ modification ) +
#   geom_point() +
#   ylab("Abundance (RPM)") +
#   coord_cartesian(ylim=c(10,10000)) +
#   scale_y_log10(labels=trans_format('log10',math_format(10^.x))) +
#   theme(legend.position = "none",#c(0.8,0.7),
#         legend.background = element_rect(color="black", fill="white", linetype="solid")) +
#   scale_color_manual("IO4", values= c("treated"="red", "untreated"="black")) +
#   theme(axis.title.x = element_blank(),
#         axis.text.x = element_text(angle=0, vjust=0.5)) 

layout <- rbind(c(1))
figure <- grid.arrange(plot1,  layout_matrix = layout)

path="../Draft/Figures20220128/"
figure_name="fig_s2c_human_mcm5s2U34_isodecoders-Arg"
width=1.5
height=1.5
scale=1.5
dpi=600
# ggsave(paste0(path, figure_name,".svg"), 
#        plot = figure,
#        scale = scale,
#        dpi = dpi,
#        width = width, 
#        height = height)

ggsave(paste0(path, figure_name,".png"),
       plot = figure,
       scale = scale,
       dpi = dpi,
       width = width,
       height = height)

```

###Gln TTG
```{r}
#================  Gln TTG ===================
#To do RPM normalization, gott know how many reads in each sample
temp1 <- Q_count %>%
  filter(project=="Q",
         bin_start %nin% c("-1", "-2", "-3")) %>%
  group_by(treatment, rep, sample) %>%
  summarise(total_count = sum(count))
temp1 <-  Q_base %>%
  filter(bin_start %nin% c("-1","-2","-3") ) %>%
  full_join(., temp1, by=c("treatment","rep","sample")) %>%
  filter(pileup >= 0)

temp1 <- temp1 %>%
  filter(project=="Q") %>%
  # filter(gene %in% temp_most$gene) %>%
  filter(#(AA=="Arg" & position==34 & base=="T" & anticodon=="TCT") | #Mutation
           (AA=="Gln" & position==34 & base=="T" & anticodon =="TTG"),
           chr %in% c("chr17.trna16", "chr6.trna130","chr6.trna64"),
           #(AA=="Gln" & position ==34 & base=="T" & anticodon =="TTG"),
         bin_start=="60",
         sample == "Q100",
         pileup >= 10
         ) %>%
  mutate(modification = "mcm5s2U")
temp1$treatment <- recode(temp1$treatment, "minusI"="untreated", "plusI"="treated")
temp1$chr <- recode(temp1$chr, "chr17.trna16"="2","chr6.trna130"="1","chr6.trna64"="3")
temp1$sample <- recode(temp1$sample, "Q0"="0Q", "Q100"="100Q")

plot1  <- ggplot(temp1, 
       aes(x=paste0(chr), y=mutation, color=treatment)) +
  # facet_grid(rows=vars(sample)) +
  geom_point() +
  ylab("Mutation fraction") +
  coord_cartesian(ylim = c(0,0.6)) +
  scale_y_continuous(breaks=c(0,0.2,0.4,0.6)) +
  theme(legend.position = "none",#c(0.8,0.7),
        legend.background = element_rect(color="black", fill="white", linetype="solid")) +
  scale_color_manual("IO4", values= c("treated"="red", "untreated"="black")) +
  theme(axis.title.x = element_blank(),
        axis.text.x = element_text(angle=0, vjust=0.5))

# plot2  <- ggplot(temp1, 
#        aes(x=paste0(chr), y=pileup / total_count *1000000, color=treatment)) +
#   # facet_nested(~ modification ) +
#   geom_point() +
#   ylab("Abundance (RPM)") +
#   coord_cartesian(ylim=c(10,10000)) +
#   scale_y_log10(labels=trans_format('log10',math_format(10^.x))) +
#   theme(legend.position = "none",#c(0.8,0.7),
#         legend.background = element_rect(color="black", fill="white", linetype="solid")) +
#   scale_color_manual("IO4", values= c("treated"="red", "untreated"="black")) +
#   theme(axis.title.x = element_blank(),
#         axis.text.x = element_text(angle=0, vjust=0.5)) 

layout <- rbind(c(1))
figure <- grid.arrange(plot1,  layout_matrix = layout)

path="../Draft/Figures20220128/"
figure_name="fig_s2c_human_mcm5s2U34_isodecoders-Gln"
width=1.5
height=1.5
scale=1.5
dpi=600
# ggsave(paste0(path, figure_name,".svg"), 
#        plot = figure,
#        scale = scale,
#        dpi = dpi,
#        width = width, 
#        height = height)

ggsave(paste0(path, figure_name,".png"),
       plot = figure,
       scale = scale,
       dpi = dpi,
       width = width,
       height = height)

```


###Glu TTC
```{r}
#To do RPM normalization, gott know how many reads in each sample
temp1 <- Q_count %>%
  filter(project=="Q",
         bin_start %nin% c("-1", "-2", "-3")) %>%
  group_by(treatment, rep, sample) %>%
  summarise(total_count = sum(count))
temp1 <-  Q_base %>%
  filter(bin_start %nin% c("-1","-2","-3") ) %>%
  full_join(., temp1, by=c("treatment","rep","sample")) %>%
  filter(pileup >= 0)

temp1 <- temp1 %>%
  filter(project=="Q") %>%
  # filter(gene %in% temp_most$gene) %>%
  filter(#(AA=="Arg" & position==34 & base=="T" & anticodon=="TCT") | #Mutation
           (AA=="Glu" & position==34 & base=="T" & anticodon =="TTC"),
           chr %in% c("chr1.trna134", "chr1.trna5","chr13.trna3","chr13.trna5"),
           #(AA=="Gln" & position ==34 & base=="T" & anticodon =="TTG"),
         bin_start=="60",
         sample == "Q100",
         pileup >= 10
         ) %>%
  mutate(modification = "mcm5s2u34")
temp1$treatment <- recode(temp1$treatment, "minusI"="untreated", "plusI"="treated")
temp1$chr <- recode(temp1$chr, "chr13.trna5"="1","chr13.trna3"="2","chr1.trna134"="3", "chr1.trna5"="4")
temp1$sample <- recode(temp1$sample, "Q0"="0Q", "Q100"="100Q")

plot1  <- ggplot(temp1, 
       aes(x=paste0(chr), y=mutation, color=treatment)) +
  # facet_grid(rows=vars(sample)) +
  geom_point() +
  ylab("Mutation fraction") +
  coord_cartesian(ylim = c(0,0.6)) +
  scale_y_continuous(breaks=c(0,0.2,0.4,0.6)) +
  theme(legend.position = "none",#c(0.8,0.7),
        legend.background = element_rect(color="black", fill="white", linetype="solid")) +
  scale_color_manual("IO4", values= c("treated"="red", "untreated"="black")) +
  theme(axis.title.x = element_blank(),
        axis.text.x = element_text(angle=0, vjust=0.5))

# plot2  <- ggplot(temp1, 
#        aes(x=paste0(chr), y=pileup / total_count *1000000, color=treatment)) +
#   # facet_nested(~ modification ) +
#   geom_point() +
#   ylab("Abundance (RPM)") +
#   coord_cartesian(ylim=c(10,10000)) +
#   scale_y_log10(labels=trans_format('log10',math_format(10^.x))) +
#   theme(legend.position = "none",#c(0.8,0.7),
#         legend.background = element_rect(color="black", fill="white", linetype="solid")) +
#   scale_color_manual("IO4", values= c("treated"="red", "untreated"="black")) +
#   theme(axis.title.x = element_blank(),
#         axis.text.x = element_text(angle=0, vjust=0.5)) 

layout <- rbind(c(1))
figure <- grid.arrange(plot1,  layout_matrix = layout)

path="../Draft/Figures20220128/"
figure_name="fig_s2c_human_mcm5s2U34_isodecoders-Glu"
width=1.5
height=1.5
scale=1.5
dpi=600
# ggsave(paste0(path, figure_name,".svg"), 
#        plot = figure,
#        scale = scale,
#        dpi = dpi,
#        width = width, 
#        height = height)

ggsave(paste0(path, figure_name,".png"),
       plot = figure,
       scale = scale,
       dpi = dpi,
       width = width,
       height = height)

```








#_
#Figure new s2 
##Fig s2A Asn isodecoders abundance
```{r}
temp <- Q_base %>%
  filter(project=="Q") %>%
  filter(AA=="Asn", source=="cytosolic",
         chr %in% c("chr1.trna103","chr1.trna107","chr1.trna136","chr1.trna26","chr1.trna47"),
         bin_start=="60",
         sample=="Q100",
         pileup >= 100)

#To do RPM normalization, gott know how many reads in each sample
temp1 <- Q_count %>%
  filter(project=="Q",
         bin_start %nin% c("-1", "-2", "-3")) %>%
  group_by(treatment, rep, sample) %>%
  summarise(total_count = sum(count))
temp <-  temp %>%
  full_join(., temp1, by=c("treatment","rep","sample")) %>%
  filter(pileup >= 0)
temp$treatment <- recode(temp$treatment, "minusI"="untreated", "plusI"="treated")
temp$chr <- recode(temp$chr, "chr1.trna103"="5","chr1.trna107"="2","chr1.trna136"="4","chr1.trna26"="1","chr1.trna47"="3")

# plot1 <- ggplot(filter(temp, position%in% c(34,35), base=="G",
#               # (chr=="chr1.trna69" & position==34)|(chr=="chr12.trna5" & position==34)|(chr=="chr6.trna144" & position==34),
#               ), 
#        aes(x=paste0(chr), y=deletion/pileup, color=treatment, group= interaction(treatment, rep, sample, gene))) +
#   geom_point() +
#   scale_color_manual("IO4", values= c("treated"="red", "untreated"="black")) +
#   scale_y_continuous(breaks=c(0,0.05, 0.1, 0.15)) +
#   coord_cartesian(ylim = c(0,0.15)) +
#   ylab("Deletion fraction") +
#   theme(axis.text.x = element_text(angle=0, vjust=0.5, size=10),
#         axis.title.x = element_blank(),
#         legend.position = "none")


plot2 <- ggplot(filter(temp, position%in% c(34,35), base=="G",
              # (chr=="chr1.trna69" & position==34)|(chr=="chr12.trna5" & position==34)|(chr=="chr6.trna144" & position==34),
              ),
       aes(x=paste0(chr), y=pileup/total_count*1000000, color=treatment, group= interaction(treatment, rep, sample, gene))) +
  geom_point() +
  scale_color_manual("IO4", values= c("treated"="red", "untreated"="black")) +
  ylab("Abundance (RPM)") +
  coord_cartesian(ylim=c(100,100000)) +
  scale_y_log10(labels=trans_format('log10',math_format(10^.x))) +
  theme(axis.text.x = element_text(angle=0, vjust=0.5, size=10),
        axis.title.x = element_blank(),
        legend.position = "none")

layout <- rbind(c(1))
figure <- grid.arrange(plot2,  layout_matrix = layout)

path="../Draft/Figures20220128/"
figure_name="fig_s2X_Asn_isodecoders"
width=1.75
height=1.5
scale=1.5
dpi=600
# ggsave(paste0(path, figure_name,".svg"), 
#        plot = figure,
#        scale = scale,
#        dpi = dpi,
#        width = width, 
#        height = height)

ggsave(paste0(path, figure_name,".png"),
       plot = figure,
       scale = scale,
       dpi = dpi,
       width = width,
       height = height)


```












#_
#_
#_
#_
#OLD Figure 4 - deletion

##Fig 4B traces Arg, Gln. Glu
```{r}
temp_most <- Q_base %>%
  filter(project=="Q") %>%
  filter(bin_start=="60",
         sample=="Q100",
         treatment=="plusI",
         pileup >=500) %>%
  group_by(AA, anticodon) %>%
  filter(position > 25, position < 40) %>%
  mutate(pileup_max = max(pileup)) %>%
  filter(pileup == pileup_max) %>%
  select(AA, anticodon, chr, gene)

temp3 <- Q_base %>%
  filter(project=="Q") %>%
  filter(gene %in% temp_most$gene) %>%
  filter((AA=="Arg" & anticodon=="TCT") | #Mutation
           (AA=="Glu" & anticodon =="TTC") |
           (AA=="Gln" & anticodon =="TTG"),
         bin_start=="60",
         #sample == "Q100",
         pileup >= 100) %>%
  mutate(modification = "mcm5s2u34")
temp3$treatment <- recode(temp3$treatment, "minusI"="untreated", "plusI"="treated")
temp3$sample <- recode(temp3$sample, "Q0"="0Q", "Q100"="100Q")


plot1 <- ggplot(temp3, 
       aes(x=position, y=deletion / pileup, color=treatment, group=interaction(rep, treatment, sample))) +
  # facet_grid(rows=vars(paste0(AA, anticodon)),
  #            cols=vars(modification)) +
  facet_nested(paste0(AA, anticodon) ~ modification + sample ) +
  geom_line() +
  coord_cartesian(xlim = c(29,39)) +
  scale_x_continuous(breaks=c(30,32,34,36,38)) +
  ylab("Deletion rate") +
  theme(legend.position = "none",#c(0.8,0.7),
        legend.background = element_rect(color="black", fill="white", linetype="solid")) +
  scale_color_manual("IO4", values= c("treated"="red", "untreated"="black")) +
  theme(axis.title.x = element_blank(),
        axis.text.x = element_text(angle=90, vjust=0.5))

layout <- rbind(c(1))
figure <- grid.arrange(plot1,  layout_matrix = layout)

path="../Draft/Figures20220117//"
figure_name="fig_4b_human_mcm5s2U34_trace_deletion"
width=2.25
height=3
scale=1.5
dpi=600
# ggsave(paste0(path, figure_name,".svg"), 
#        plot = figure,
#        scale = scale,
#        dpi = dpi,
#        width = width, 
#        height = height)

ggsave(paste0(path, figure_name,".png"),
       plot = figure,
       scale = scale,
       dpi = dpi,
       width = width,
       height = height)

```


##Fig 4C traces Lys
```{r}
temp_most <- Q_base %>%
  filter(project=="Q") %>%
  filter(bin_start=="60",
         sample=="Q100",
         treatment=="plusI",
         pileup >=500) %>%
  group_by(AA, anticodon) %>%
  filter(position > 25, position < 40) %>%
  mutate(pileup_max = max(pileup)) %>%
  filter(pileup == pileup_max) %>%
  select(AA, anticodon, chr, gene)

temp4 <- Q_base %>%
  filter(project=="Q") %>%
  filter(gene %in% temp_most$gene) %>%
  filter((AA=="Lys" & anticodon=="TTT"),
         bin_start=="60",
         #sample == "Q100",
         pileup >= 100
         ) %>%
  mutate(modification = "mnm5s2U34")
temp4$treatment <- recode(temp4$treatment, "minusI"="untreated", "plusI"="treated")
temp4$sample <- recode(temp4$sample, "Q0"="0Q", "Q100"="100Q")


plot1 <- ggplot(temp4, 
       aes(x=position, y=deletion / pileup, color=treatment, group=interaction(rep, treatment, sample))) +
  facet_nested(paste0(AA, anticodon) ~ modification + sample ) +
  geom_line() +
  coord_cartesian(xlim = c(29,39), ylim = c(0, 0.3) ) +
  scale_x_continuous(breaks=c(30,32,34,36,38)) +
  ylab("Deletion rate") +
  theme(legend.position = "none",#c(0.8,0.7),
        legend.background = element_rect(color="black", fill="white", linetype="solid")) +
  scale_color_manual("IO4", values= c("treated"="red", "untreated"="black")) +
  theme(axis.title.x = element_blank(),
        axis.text.x = element_text(angle=90, vjust=0.5)) 

layout <- rbind(c(1))
figure <- grid.arrange(plot1,  layout_matrix = layout)

path="../Draft/Figures20220117//"
figure_name="fig_4c_human_mnm5s2U34_trace_deletion"
width=2.25
height=1.5
scale=1.5
dpi=600
# ggsave(paste0(path, figure_name,".svg"), 
#        plot = figure,
#        scale = scale,
#        dpi = dpi,
#        width = width, 
#        height = height)

ggsave(paste0(path, figure_name,".png"),
       plot = figure,
       scale = scale,
       dpi = dpi,
       width = width,
       height = height)

```



##Fig 4D traces mtGln mtGlu mtLys
```{r}
temp_most <- Q_base %>%
  filter(project=="Q") %>%
  filter(bin_start=="60",
         sample=="Q100",
         treatment=="plusI",
         pileup >=500) %>%
  group_by(AA, anticodon) %>%
  filter(position > 25, position < 40) %>%
  mutate(pileup_max = max(pileup)) %>%
  filter(pileup == pileup_max) %>%
  select(AA, anticodon, chr, gene)

temp1 <- Q_base %>%
  filter(project=="Q") %>%
  filter(gene %in% temp_most$gene) %>%
  filter((AA=="mtGlu" ) | #Deletion
           (AA=="mtGln" ) |
           (AA=="mtLys" ),
         bin_start=="60",
         # sample == "Q100",
         pileup >= 100) %>%
  mutate(modification = "τm5s2U34")
temp1$treatment <- recode(temp1$treatment, "minusI"="untreated", "plusI"="treated")
temp1$sample <- recode(temp1$sample, "Q0"="0Q", "Q100"="100Q")


plot1 <- ggplot(temp1, 
       aes(x=position, y=deletion / pileup, color=treatment, group=interaction(rep, treatment, sample))) +
  facet_nested(paste0(AA, anticodon) ~ modification + sample ) +
  geom_line() +
  coord_cartesian(xlim = c(25,35), ylim = c(0, 0.4) ) +
  scale_x_continuous(breaks=c(26,28,30,32,34,36,38)) +
  ylab("Deletion rate") +
  theme(legend.position = "none",#c(0.8,0.7),
        legend.background = element_rect(color="black", fill="white", linetype="solid")) +
  scale_color_manual("IO4", values= c("treated"="red", "untreated"="black")) +
  theme(axis.title.x = element_blank(),
        axis.text.x = element_text(angle=90, vjust=0.5)) 

layout <- rbind(c(1))
figure <- grid.arrange(plot1,  layout_matrix = layout)

path="../Draft/Figures20220117//"
figure_name="fig_4d_human_tm5s2U34_trace_deletion"
width=2.25
height=3
scale=1.5
dpi=600
# ggsave(paste0(path, figure_name,".svg"), 
#        plot = figure,
#        scale = scale,
#        dpi = dpi,
#        width = width, 
#        height = height)

ggsave(paste0(path, figure_name,".png"),
       plot = figure,
       scale = scale,
       dpi = dpi,
       width = width,
       height = height)


```


##Fig 4CX - taurin, not thiol
```{r}
temp_most <- Q_base %>%
  filter(project=="Q") %>%
  filter(bin_start=="60",
         sample=="Q100",
         treatment=="plusI",
         pileup >=500) %>%
  group_by(AA, anticodon) %>%
  filter(position > 25, position < 40) %>%
  mutate(pileup_max = max(pileup)) %>%
  filter(pileup == pileup_max) %>%
  select(AA, anticodon, chr, gene)

temp1 <- Q_base %>%
  filter(project=="Q") %>%
  filter(gene %in% temp_most$gene) %>%
  filter((AA=="mtTrp" ) | #Deletion
           (AA=="mtLeu" & anticodon == "TAA" ),
         bin_start=="60",
         # sample == "Q100",
         pileup >= 100) %>%
  mutate(modification = "τm5U34")
temp1$treatment <- recode(temp1$treatment, "minusI"="untreated", "plusI"="treated")
temp1$sample <- recode(temp1$sample, "Q0"="0Q", "Q100"="100Q")

#Weekend version
# plot1 <- ggplot(temp1, 
#        aes(x=position, y=deletion / pileup, color=treatment, group=interaction(rep, treatment, sample))) +
#   facet_nested(paste0(AA, anticodon) ~ modification + sample ) +
#   geom_line() +
#   coord_cartesian(xlim = c(25,39), ylim = c(0, 0.3) ) +
#   scale_x_continuous(breaks=c(26,28,30,32,34,36,38)) +
#   ylab("Deletion rate") +
#   geom_vline(xintercept = c(36, 33), linetype=2, alpha=0.3) +
#   # geom_text(aes(label=base), y=-0.01)
#   theme(legend.position = "none",#c(0.8,0.7),
#         legend.background = element_rect(color="black", fill="white", linetype="solid")) +
#   scale_color_manual("IO4", values= c("treated"="red", "untreated"="black")) +
#   theme(axis.title.x = element_blank(),
#         axis.text.x = element_text(angle=90, vjust=0.5)) 

plot1 <- ggplot(filter(temp1, sample=="0Q"),
       aes(x=position, y=deletion / pileup, color=treatment, group=interaction(rep, treatment, sample))) +
  facet_nested(paste0(AA, anticodon) ~ modification + sample ) +
  geom_line() +
  coord_cartesian(xlim = c(25,39), ylim = c(0, 0.3) ) +
  scale_x_continuous(breaks=c(26,28,30,32,34,36,38)) +
  ylab("Deletion rate") +
  geom_vline(xintercept = c(36, 33), linetype=2, alpha=0.3) +
  # geom_text(aes(label=base), y=-0.01)
  theme(legend.position = "none",#c(0.8,0.7),
        legend.background = element_rect(color="black", fill="white", linetype="solid")) +
  scale_color_manual("IO4", values= c("treated"="red", "untreated"="black")) +
  theme(axis.title.x = element_blank(),
        axis.text.x = element_text(angle=90, vjust=0.5)) 

plot2 <- ggplot(filter(temp1, sample=="0Q"),
       aes(x=position, y=mutation, color=treatment, group=interaction(rep, treatment, sample))) +
  facet_nested(paste0(AA, anticodon) ~ modification + sample ) +
  geom_line() +
  coord_cartesian(xlim = c(25,39), ylim = c(0, 0.3) ) +
  scale_x_continuous(breaks=c(26,28,30,32,34,36,38)) +
  ylab("Mutation rate") +
  geom_vline(xintercept = c(36, 33), linetype=2, alpha=0.3) +
  # geom_text(aes(label=base), y=-0.01)
  theme(legend.position = "none",#c(0.8,0.7),
        legend.background = element_rect(color="black", fill="white", linetype="solid")) +
  scale_color_manual("IO4", values= c("treated"="red", "untreated"="black")) +
  theme(axis.title.x = element_blank(),
        axis.text.x = element_text(angle=90, vjust=0.5)) 

layout <- rbind(c(1, 2))
figure <- grid.arrange(plot1, plot2,  layout_matrix = layout)

path="../Draft/Figures20220117/"
figure_name="fig_4X_human_turine_traces_trace_deletion"
width=4
height=3
scale=1.5
dpi=600
# ggsave(paste0(path, figure_name,".svg"), 
#        plot = figure,
#        scale = scale,
#        dpi = dpi,
#        width = width, 
#        height = height)

ggsave(paste0(path, figure_name,".png"),
       plot = figure,
       scale = scale,
       dpi = dpi,
       width = width,
       height = height)


```


##Fig 4E Ecoli Gln
```{r}

temp1 <- Ecoli_base %>%
  filter(bin_start == "60",
         (anticodon=="TTG" ), #& position ==33 & base=="T"), #both
         pileup >= 100) %>%
  mutate(modification = "cmnm5s2U34")


plot1 <- ggplot(temp1, 
       aes(x=position, y=deletion / pileup, color=treatment)) +
  facet_nested( paste0(amino_acid, anticodon) ~ modification ) +
  geom_line() +
  coord_cartesian(xlim = c(25,39), ylim = c(0, 0.5) ) +
  scale_x_continuous(breaks=c(26,28,30,32,34,36,38)) +
  ylab("Deletion rate") +
  geom_vline(xintercept = c(33), linetype=2, alpha=0.3) +
  theme(legend.position = "none",#c(0.8,0.7),
        legend.background = element_rect(color="black", fill="white", linetype="solid")) +
  scale_color_manual(values= c("treated"="red", "untreated"="black")) +
  theme(axis.title.x = element_blank(),
        axis.text.x = element_text(angle=90, vjust=0.5)) 

layout <- rbind(c(1))
figure <- grid.arrange(plot1,  layout_matrix = layout)

path="../Draft/Figures20220117//"
figure_name="fig_4e_Ecoli_cmnm5s2U34_trace_deletion"
width=1.5
height=1.5
scale=1.5
dpi=600
# ggsave(paste0(path, figure_name,".svg"), 
#        plot = figure,
#        scale = scale,
#        dpi = dpi,
#        width = width, 
#        height = height)

ggsave(paste0(path, figure_name,".png"),
       plot = figure,
       scale = scale,
       dpi = dpi,
       width = width,
       height = height)

```




##Fig 4F Ecoli Glu Lys
```{r}

temp2 <- Ecoli_base %>%
  filter(bin_start == "60",
         (anticodon=="TTC" ) | #both
           (anticodon=="TTT" ), #deletion
         pileup >= 100) %>%
  mutate(modification = "mnm5s2U34")


plot1 <- ggplot(temp2, 
       aes(x=position, y=deletion / pileup, color=treatment)) +
  facet_nested( paste0(amino_acid, anticodon) ~ modification ) +
  geom_line() +
  coord_cartesian(xlim = c(25,39), ylim = c(0, 0.15) ) +
  scale_x_continuous(breaks=c(26,28,30,32,34,36,38)) +
  ylab("Deletion rate") +
  geom_vline(xintercept = c(33, 35), linetype=2, alpha=0.3) +
  theme(legend.position = "none",#c(0.8,0.7),
        legend.background = element_rect(color="black", fill="white", linetype="solid")) +
  scale_color_manual(values= c("treated"="red", "untreated"="black")) +
  theme(axis.title.x = element_blank(),
        axis.text.x = element_text(angle=90, vjust=0.5)) 

layout <- rbind(c(1))
figure <- grid.arrange(plot1,  layout_matrix = layout)

path="../Draft/Figures20220117//"
figure_name="fig_4f_Ecoli_mnm5s2U34_trace_deletion"
width=1.5
height=2
scale=1.5
dpi=600
# ggsave(paste0(path, figure_name,".svg"), 
#        plot = figure,
#        scale = scale,
#        dpi = dpi,
#        width = width, 
#        height = height)

ggsave(paste0(path, figure_name,".png"),
       plot = figure,
       scale = scale,
       dpi = dpi,
       width = width,
       height = height)

```





##Fig 4G Ecoli Arg Ser
```{r}

temp3 <- Ecoli_base %>%
  filter(bin_start == "60",
         (anticodon=="GCT") |
           (anticodon=="ACG") |
           (anticodon=="CCG") |
           (anticodon=="CCT") |
           (anticodon=="TCT"), #mutation
         pileup >= 50) %>%
  mutate(modification = "s2C32")


plot1 <- ggplot(temp3, 
       aes(x=position, y=deletion / pileup, color=treatment)) +
  facet_nested( paste0(amino_acid, anticodon) ~ modification ) +
  geom_line() +
  coord_cartesian(xlim = c(25,39), ylim = c(0, 0.08) ) +
  scale_x_continuous(breaks=c(26,28,30,32,34,36,38)) +
  ylab("Deletion rate") +
  geom_vline(xintercept = c(33, 32), linetype=2, alpha=0.3) +
  theme(legend.position = "none",#c(0.8,0.7),
        legend.background = element_rect(color="black", fill="white", linetype="solid")) +
  scale_color_manual(values= c("treated"="red", "untreated"="black")) +
  theme(axis.title.x = element_blank(),
        axis.text.x = element_text(angle=90, vjust=0.5)) 

layout <- rbind(c(1))
figure <- grid.arrange(plot1,  layout_matrix = layout)

path="../Draft/Figures20220117//"
figure_name="fig_4g_Ecoli_s2C32_trace_deletion"
width=1.5
height=4
scale=1.5
dpi=600
# ggsave(paste0(path, figure_name,".svg"), 
#        plot = figure,
#        scale = scale,
#        dpi = dpi,
#        width = width, 
#        height = height)

ggsave(paste0(path, figure_name,".png"),
       plot = figure,
       scale = scale,
       dpi = dpi,
       width = width,
       height = height)

```


##Ecoli S4U
```{r}

temp <- Ecoli_base %>%
  filter(bin_start == "60",
         amino_acid=="His",
         # anticodon=="CGA",
         pileup >= 1000) %>%
  mutate(modification = "s4U")


plot1 <- ggplot(temp, 
       aes(x=position, y=deletion / pileup, color=treatment)) +
  facet_nested( paste0(amino_acid, anticodon) ~ modification ) +
  geom_line() +
  coord_cartesian(xlim = c(3,13), ylim = c(0, 0.08) ) +
  scale_x_continuous(breaks=c(26,28,30,32,34,36,38)) +
  ylab("Deletion rate") +
  geom_vline(xintercept = c(33, 32), linetype=2, alpha=0.3) +
  theme(legend.position = "none",#c(0.8,0.7),
        legend.background = element_rect(color="black", fill="white", linetype="solid")) +
  scale_color_manual(values= c("treated"="red", "untreated"="black")) +
  theme(axis.title.x = element_blank(),
        axis.text.x = element_text(angle=90, vjust=0.5)) 

layout <- rbind(c(1))
figure <- grid.arrange(plot1,  layout_matrix = layout)

path="../Draft/Figures20220117//"
figure_name="fig_4h_Ecoli_s4U_trace_deletion"
width=1.5
height=1.5
scale=1.5
dpi=600
# ggsave(paste0(path, figure_name,".svg"), 
#        plot = figure,
#        scale = scale,
#        dpi = dpi,
#        width = width, 
#        height = height)

ggsave(paste0(path, figure_name,".png"),
       plot = figure,
       scale = scale,
       dpi = dpi,
       width = width,
       height = height)

```






#Figure 4 - mutation

##Fig 4B traces Arg, Gln. Glu
```{r}
temp_most <- Q_base %>%
  filter(project=="Q") %>%
  filter(bin_start=="60",
         sample=="Q100",
         treatment=="plusI",
         pileup >=500) %>%
  group_by(AA, anticodon) %>%
  filter(position > 25, position < 40) %>%
  mutate(pileup_max = max(pileup)) %>%
  filter(pileup == pileup_max) %>%
  select(AA, anticodon, chr, gene)

temp3 <- Q_base %>%
  filter(project=="Q") %>%
  filter(gene %in% temp_most$gene) %>%
  filter((AA=="Arg" & anticodon=="TCT") | #Mutation
           (AA=="Glu" & anticodon =="TTC") |
           (AA=="Gln" & anticodon =="TTG"),
         bin_start=="60",
         #sample == "Q100",
         pileup >= 100) %>%
  mutate(modification = "mcm5s2u34")
temp3$treatment <- recode(temp3$treatment, "minusI"="untreated", "plusI"="treated")
temp3$sample <- recode(temp3$sample, "Q0"="0Q", "Q100"="100Q")


plot1 <- ggplot(temp3, 
       aes(x=position, y=mutation, color=treatment, group=interaction(rep, treatment, sample))) +
  # facet_grid(rows=vars(paste0(AA, anticodon)),
  #            cols=vars(modification)) +
  facet_nested(paste0(AA, anticodon) ~ modification + sample ) +
  geom_line() +
  coord_cartesian(xlim = c(29,39)) +
  scale_x_continuous(breaks=c(30,32,34,36,38)) +
  ylab("Mutation rate") +
  theme(legend.position = "none",#c(0.8,0.7),
        legend.background = element_rect(color="black", fill="white", linetype="solid")) +
  scale_color_manual("IO4", values= c("treated"="red", "untreated"="black")) +
  theme(axis.title.x = element_blank(),
        axis.text.x = element_text(angle=90, vjust=0.5))

layout <- rbind(c(1))
figure <- grid.arrange(plot1,  layout_matrix = layout)

path="../Draft/Figures20220117//"
figure_name="fig_4b_human_mcm5s2U34_trace_mutation"
width=2.25
height=3
scale=1.5
dpi=600
# ggsave(paste0(path, figure_name,".svg"), 
#        plot = figure,
#        scale = scale,
#        dpi = dpi,
#        width = width, 
#        height = height)

ggsave(paste0(path, figure_name,".png"),
       plot = figure,
       scale = scale,
       dpi = dpi,
       width = width,
       height = height)

```


##Fig 4C traces Lys
```{r}
temp_most <- Q_base %>%
  filter(project=="Q") %>%
  filter(bin_start=="60",
         sample=="Q100",
         treatment=="plusI",
         pileup >=500) %>%
  group_by(AA, anticodon) %>%
  filter(position > 25, position < 40) %>%
  mutate(pileup_max = max(pileup)) %>%
  filter(pileup == pileup_max) %>%
  select(AA, anticodon, chr, gene)

temp4 <- Q_base %>%
  filter(project=="Q") %>%
  filter(gene %in% temp_most$gene) %>%
  filter((AA=="Lys" & anticodon=="TTT"),
         bin_start=="60",
         #sample == "Q100",
         pileup >= 100
         ) %>%
  mutate(modification = "mnm5s2U34")
temp4$treatment <- recode(temp4$treatment, "minusI"="untreated", "plusI"="treated")
temp4$sample <- recode(temp4$sample, "Q0"="0Q", "Q100"="100Q")


plot1 <- ggplot(temp4, 
       aes(x=position, y=mutation, color=treatment, group=interaction(rep, treatment, sample))) +
  facet_nested(paste0(AA, anticodon) ~ modification + sample ) +
  geom_line() +
  coord_cartesian(xlim = c(29,39), ylim = c(0, 0.2) ) +
  scale_x_continuous(breaks=c(30,32,34,36,38)) +
  ylab("Mutation rate") +
  theme(legend.position = "none",#c(0.8,0.7),
        legend.background = element_rect(color="black", fill="white", linetype="solid")) +
  scale_color_manual("IO4", values= c("treated"="red", "untreated"="black")) +
  theme(axis.title.x = element_blank(),
        axis.text.x = element_text(angle=90, vjust=0.5)) 

layout <- rbind(c(1))
figure <- grid.arrange(plot1,  layout_matrix = layout)

path="../Draft/Figures20220117//"
figure_name="fig_4c_human_mnm5s2U34_trace_mutation"
width=2.25
height=1.5
scale=1.5
dpi=600
# ggsave(paste0(path, figure_name,".svg"), 
#        plot = figure,
#        scale = scale,
#        dpi = dpi,
#        width = width, 
#        height = height)

ggsave(paste0(path, figure_name,".png"),
       plot = figure,
       scale = scale,
       dpi = dpi,
       width = width,
       height = height)

```



##Fig 4D traces mtGln mtGlu mtLys
```{r}
temp_most <- Q_base %>%
  filter(project=="Q") %>%
  filter(bin_start=="60",
         sample=="Q100",
         treatment=="plusI",
         pileup >=500) %>%
  group_by(AA, anticodon) %>%
  filter(position > 25, position < 40) %>%
  mutate(pileup_max = max(pileup)) %>%
  filter(pileup == pileup_max) %>%
  select(AA, anticodon, chr, gene)

temp1 <- Q_base %>%
  filter(project=="Q") %>%
  filter(gene %in% temp_most$gene) %>%
  filter((AA=="mtGlu" ) | #Deletion
           (AA=="mtGln" ) |
           (AA=="mtLys" ),
         bin_start=="60",
         # sample == "Q100",
         pileup >= 100) %>%
  mutate(modification = "τm5s2U34")
temp1$treatment <- recode(temp1$treatment, "minusI"="untreated", "plusI"="treated")
temp1$sample <- recode(temp1$sample, "Q0"="0Q", "Q100"="100Q")


plot1 <- ggplot(temp1, 
       aes(x=position, y=mutation, color=treatment, group=interaction(rep, treatment, sample))) +
  facet_nested(paste0(AA, anticodon) ~ modification + sample ) +
  geom_line() +
  coord_cartesian(xlim = c(25,35), ylim = c(0, 0.5) ) +
  scale_x_continuous(breaks=c(26,28,30,32,34,36,38)) +
  ylab("Mutation rate") +
  theme(legend.position = "none",#c(0.8,0.7),
        legend.background = element_rect(color="black", fill="white", linetype="solid")) +
  scale_color_manual("IO4", values= c("treated"="red", "untreated"="black")) +
  theme(axis.title.x = element_blank(),
        axis.text.x = element_text(angle=90, vjust=0.5)) 

layout <- rbind(c(1))
figure <- grid.arrange(plot1,  layout_matrix = layout)

path="../Draft/Figures20220117//"
figure_name="fig_4d_human_tm5s2U34_trace_mutation"
width=2.25
height=3
scale=1.5
dpi=600
# ggsave(paste0(path, figure_name,".svg"), 
#        plot = figure,
#        scale = scale,
#        dpi = dpi,
#        width = width, 
#        height = height)

ggsave(paste0(path, figure_name,".png"),
       plot = figure,
       scale = scale,
       dpi = dpi,
       width = width,
       height = height)


```


##Fig 4CX - taurin, not thiol
```{r}
temp_most <- Q_base %>%
  filter(project=="Q") %>%
  filter(bin_start=="60",
         sample=="Q100",
         treatment=="plusI",
         pileup >=500) %>%
  group_by(AA, anticodon) %>%
  filter(position > 25, position < 40) %>%
  mutate(pileup_max = max(pileup)) %>%
  filter(pileup == pileup_max) %>%
  select(AA, anticodon, chr, gene)

temp1 <- Q_base %>%
  filter(project=="Q") %>%
  filter(gene %in% temp_most$gene) %>%
  filter((AA=="mtTrp" ) | #Deletion
           (AA=="mtLeu" & anticodon == "TAA" ),
         bin_start=="60",
         # sample == "Q100",
         pileup >= 100) %>%
  mutate(modification = "τm5U34")
temp1$treatment <- recode(temp1$treatment, "minusI"="untreated", "plusI"="treated")
temp1$sample <- recode(temp1$sample, "Q0"="0Q", "Q100"="100Q")


plot1 <- ggplot(temp1, 
       aes(x=position, y=mutation, color=treatment, group=interaction(rep, treatment, sample))) +
  facet_nested(paste0(AA, anticodon) ~ modification + sample ) +
  geom_line() +
  coord_cartesian(xlim = c(25,39), ylim = c(0, 0.5) ) +
  scale_x_continuous(breaks=c(26,28,30,32,34,36,38)) +
  ylab("Mutation rate") +
  geom_vline(xintercept = c(36, 33), linetype=2, alpha=0.3) +
  # geom_text(aes(label=base), y=-0.01)
  theme(legend.position = "none",#c(0.8,0.7),
        legend.background = element_rect(color="black", fill="white", linetype="solid")) +
  scale_color_manual("IO4", values= c("treated"="red", "untreated"="black")) +
  theme(axis.title.x = element_blank(),
        axis.text.x = element_text(angle=90, vjust=0.5)) 

layout <- rbind(c(1))
figure <- grid.arrange(plot1,  layout_matrix = layout)

path="../Draft/Figures20220117//"
figure_name="fig_4X_human_turine_traces_trace_mutation"
width=2.25
height=3
scale=1.5
dpi=600
# ggsave(paste0(path, figure_name,".svg"), 
#        plot = figure,
#        scale = scale,
#        dpi = dpi,
#        width = width, 
#        height = height)

ggsave(paste0(path, figure_name,".png"),
       plot = figure,
       scale = scale,
       dpi = dpi,
       width = width,
       height = height)


```


##Fig 4E Ecoli Gln
```{r}

temp1 <- Ecoli_base %>%
  filter(bin_start == "60",
         (anticodon=="TTG" ), #& position ==33 & base=="T"), #both
         pileup >= 100) %>%
  mutate(modification = "cmnm5s2U34")


plot1 <- ggplot(temp1, 
       aes(x=position, y=mutation, color=treatment)) +
  facet_nested( paste0(amino_acid, anticodon) ~ modification ) +
  geom_line() +
  coord_cartesian(xlim = c(25,39), ylim = c(0, 0.4) ) +
  scale_x_continuous(breaks=c(26,28,30,32,34,36,38)) +
  ylab("Mutation rate") +
  geom_vline(xintercept = c(33), linetype=2, alpha=0.3) +
  theme(legend.position = "none",#c(0.8,0.7),
        legend.background = element_rect(color="black", fill="white", linetype="solid")) +
  scale_color_manual(values= c("treated"="red", "untreated"="black")) +
  theme(axis.title.x = element_blank(),
        axis.text.x = element_text(angle=90, vjust=0.5)) 

layout <- rbind(c(1))
figure <- grid.arrange(plot1,  layout_matrix = layout)

path="../Draft/Figures20220117//"
figure_name="fig_4e_Ecoli_cmnm5s2U34_trace_mutation"
width=1.5
height=1.5
scale=1.5
dpi=600
# ggsave(paste0(path, figure_name,".svg"), 
#        plot = figure,
#        scale = scale,
#        dpi = dpi,
#        width = width, 
#        height = height)

ggsave(paste0(path, figure_name,".png"),
       plot = figure,
       scale = scale,
       dpi = dpi,
       width = width,
       height = height)

```




##Fig 4F Ecoli Glu Lys
```{r}

temp2 <- Ecoli_base %>%
  filter(bin_start == "60",
         (anticodon=="TTC" ) | #both
           (anticodon=="TTT" ), #deletion
         pileup >= 100) %>%
  mutate(modification = "mnm5s2U34")


plot1 <- ggplot(temp2, 
       aes(x=position, y=mutation, color=treatment)) +
  facet_nested( paste0(amino_acid, anticodon) ~ modification ) +
  geom_line() +
  coord_cartesian(xlim = c(25,39), ylim = c(0, 0.15) ) +
  scale_x_continuous(breaks=c(26,28,30,32,34,36,38)) +
  ylab("Mutation rate") +
  geom_vline(xintercept = c(33, 35), linetype=2, alpha=0.3) +
  theme(legend.position = "none",#c(0.8,0.7),
        legend.background = element_rect(color="black", fill="white", linetype="solid")) +
  scale_color_manual(values= c("treated"="red", "untreated"="black")) +
  theme(axis.title.x = element_blank(),
        axis.text.x = element_text(angle=90, vjust=0.5)) 

layout <- rbind(c(1))
figure <- grid.arrange(plot1,  layout_matrix = layout)

path="../Draft/Figures20220117//"
figure_name="fig_4f_Ecoli_mnm5s2U34_trace_mutation"
width=1.5
height=2
scale=1.5
dpi=600
# ggsave(paste0(path, figure_name,".svg"), 
#        plot = figure,
#        scale = scale,
#        dpi = dpi,
#        width = width, 
#        height = height)

ggsave(paste0(path, figure_name,".png"),
       plot = figure,
       scale = scale,
       dpi = dpi,
       width = width,
       height = height)

```





##Fig 4G Ecoli Arg Ser
```{r}

temp3 <- Ecoli_base %>%
  filter(bin_start == "60",
         (anticodon=="GCT") |
           (anticodon=="ACG") |
           (anticodon=="CCG") |
           (anticodon=="CCT") |
           (anticodon=="TCT"), #mutation
         pileup >= 10) %>%
  mutate(modification = "s2C32")


plot1 <- ggplot(temp3, 
       aes(x=position, y=mutation, color=treatment)) +
  facet_nested( paste0(amino_acid, anticodon) ~ modification ) +
  geom_line() +
  coord_cartesian(xlim = c(25,39), ylim = c(0, 0.8) ) +
  scale_x_continuous(breaks=c(26,28,30,32,34,36,38)) +
  ylab("Mutation rate") +
  geom_vline(xintercept = c(33, 32), linetype=2, alpha=0.3) +
  theme(legend.position = "none",#c(0.8,0.7),
        legend.background = element_rect(color="black", fill="white", linetype="solid")) +
  scale_color_manual(values= c("treated"="red", "untreated"="black")) +
  theme(axis.title.x = element_blank(),
        axis.text.x = element_text(angle=90, vjust=0.5)) 

layout <- rbind(c(1))
figure <- grid.arrange(plot1,  layout_matrix = layout)

path="../Draft/Figures20220117//"
figure_name="fig_4g_Ecoli_s2C32_trace_mutation"
width=1.5
height=4
scale=1.5
dpi=600
# ggsave(paste0(path, figure_name,".svg"), 
#        plot = figure,
#        scale = scale,
#        dpi = dpi,
#        width = width, 
#        height = height)

ggsave(paste0(path, figure_name,".png"),
       plot = figure,
       scale = scale,
       dpi = dpi,
       width = width,
       height = height)

```


##Ecoli S4U
```{r}

temp <- Ecoli_base %>%
  filter(bin_start == "60",
         amino_acid=="His",
         # anticodon=="CGA",
         pileup >= 1000) %>%
  mutate(modification = "s4U")


plot1 <- ggplot(temp, 
       aes(x=position, y=mutation, color=treatment)) +
  facet_nested( paste0(amino_acid, anticodon) ~ modification ) +
  geom_line() +
  coord_cartesian(xlim = c(3,13), ylim = c(0, 0.08) ) +
  scale_x_continuous(breaks=c(26,28,30,32,34,36,38)) +
  ylab("Deletion rate") +
  geom_vline(xintercept = c(33, 32), linetype=2, alpha=0.3) +
  theme(legend.position = "none",#c(0.8,0.7),
        legend.background = element_rect(color="black", fill="white", linetype="solid")) +
  scale_color_manual(values= c("treated"="red", "untreated"="black")) +
  theme(axis.title.x = element_blank(),
        axis.text.x = element_text(angle=90, vjust=0.5)) 

layout <- rbind(c(1))
figure <- grid.arrange(plot1,  layout_matrix = layout)

path="../Draft/Figures20220117//"
figure_name="fig_4h_Ecoli_s4U_trace_mutation"
width=1.5
height=1.5
scale=1.5
dpi=600
# ggsave(paste0(path, figure_name,".svg"), 
#        plot = figure,
#        scale = scale,
#        dpi = dpi,
#        width = width, 
#        height = height)

ggsave(paste0(path, figure_name,".png"),
       plot = figure,
       scale = scale,
       dpi = dpi,
       width = width,
       height = height)

```





















```{r}
temp <- Q_base %>%
  filter(project=="Q") %>%
  filter(AA=="mtSer", #source!="cytosolic",
         # anticodon=="TCT",
         # chr == "chr1.trna69",
         bin_start=="60",
         sample == "Q100",
         pileup >= 100) %>%
  group_by(treatment, rep, sample, gene) %>%
  mutate(norm_pileup = pileup / max(pileup)) #%>%
  # filter(gene %in% temp_most$gene)
temp$treatment <- recode(temp$treatment, "minusI"="untreated", "plusI"="treated")


ggplot(filter(temp, 
              # chr == "chr1.trna69",
              ),
       aes(x=position, y=stop, color=treatment, group = interaction(treatment, rep, sample, gene))) +
  geom_line() +
  coord_cartesian(ylim = c(-0.015,1)) +
  geom_text(aes(label=base), y=-0.01, color="black") +
  geom_vline(xintercept = c(33), linetype=2, alpha=0.3) +
  scale_color_manual("IO4", values= c("treated"="red", "untreated"="black")) +
  # ylab("Deletion\nrate") +
  xlab("Position") +
  facet_grid(rows=vars( paste0(AA, anticodon, chr)) ) +
  theme(legend.position = c(0.8,0.7),
        legend.background = element_rect(color="black", fill="white", linetype="solid"))


temp_most <- Q_base %>%
  filter(project=="Q") %>%
  filter(bin_start=="60",
         sample=="Q100",
         treatment=="plusI",
         pileup >=500) %>%
  group_by(AA, anticodon) %>%
  filter(position > 25, position < 40) %>%
  mutate(pileup_max = max(pileup)) %>%
  filter(pileup == pileup_max) %>%
  select(AA, anticodon, chr, gene)

temp1 <- Q_base %>%
  filter(project=="Q") %>%
  filter(gene %in% temp_most$gene) %>%
  filter((AA=="mtGlu" & position==28 & base=="T") | #Deletion
           (AA=="mtGln" & position==32 & base=="T") |
           (AA=="mtLys" & position ==28 & base=="T"),
         bin_start=="60",
         sample == "Q100",
         pileup >= 100) %>%
  mutate(modification = "τm5s2U34")
temp1$treatment <- recode(temp1$treatment, "minusI"="untreated", "plusI"="treated")


temp2 <- Q_base %>%
  filter(project=="Q") %>%
  filter(gene %in% temp_most$gene) %>%
  filter((AA=="mtTrp" & position==36 & base=="A") | #Stop *Off by one because of how stop is calculated
           (AA=="mtTyr" & position==33 & base=="A") |
           (AA=="mtPhe" & position==38 & base=="A") |
           (AA=="mtSer" & position==33 & base=="A" & anticodon=="TGA"),
         bin_start=="60",
         sample == "Q100",
         pileup >= 100) %>%
  mutate(modification = "ms2i6A")
temp2$treatment <- recode(temp2$treatment, "minusI"="untreated", "plusI"="treated")

# temp3 <- Q_base %>%
#   filter(project=="Q") %>%
#   filter((AA=="mtAsn" & position==37 & base=="A") |
#            (AA=="mtThr" & position==35 & base=="A") |
#            (AA=="mtLys" & position ==28 & base=="T"),
#          bin_start=="60",
#          sample == "Q100",
#          pileup >= 100) %>%
#   mutate(modification = "t6A")
# temp3$treatment <- recode(temp3$treatment, "minusI"="untreated", "plusI"="treated")

temp3 <- Q_base %>%
  filter(project=="Q") %>%
  filter(gene %in% temp_most$gene) %>%
  filter((AA=="Arg" & position==34 & base=="T" & anticodon=="TCT") | #Mutation
           (AA=="Glu" & position==34 & base=="T" & anticodon =="TTC") |
           (AA=="Gln" & position ==34 & base=="T" & anticodon =="TTG"),
         bin_start=="60",
         sample == "Q100",
         pileup >= 100) %>%
  mutate(modification = "mcm5s2u34")
temp3$treatment <- recode(temp3$treatment, "minusI"="untreated", "plusI"="treated")

temp4 <- Q_base %>%
  filter(project=="Q") %>%
  filter(gene %in% temp_most$gene) %>%
  filter((AA=="Lys" & position==33 & base=="T" & anticodon=="TTT"),
         bin_start=="60",
         sample == "Q100",
         pileup >= 100) %>%
  mutate(modification = "mnm5s2U34")
temp4$treatment <- recode(temp4$treatment, "minusI"="untreated", "plusI"="treated")





plot1 <- ggplot(temp1, 
       aes(x=paste0(AA, anticodon), y=deletion/pileup, color=treatment)) +
  facet_grid(cols=vars(modification)) +
  geom_point() +
  ylab("Deletion rate") +
  theme(legend.position = "none",#c(0.8,0.7),
        legend.background = element_rect(color="black", fill="white", linetype="solid")) +
  scale_color_manual("IO4", values= c("treated"="red", "untreated"="black")) +
  theme(axis.title.x = element_blank(),
        axis.text.x = element_text(angle=90, vjust=0.5))


plot2 <- ggplot(temp2, 
       aes(x=paste0(AA, anticodon), y=stop, color=treatment)) +
  facet_grid(cols=vars(modification)) +
  geom_point() +
  ylab("Stop rate") +
  theme(legend.position = "none",#c(0.8,0.7),
        legend.background = element_rect(color="black", fill="white", linetype="solid")) +
  scale_color_manual("IO4", values= c("treated"="red", "untreated"="black")) +
  theme(axis.title.x = element_blank(),
        axis.text.x = element_text(angle=90, vjust=0.5))

plot3 <- ggplot(temp3, 
       aes(x=paste0(AA, anticodon), y=mutation, color=treatment)) +
  facet_grid(cols=vars(modification)) +
  geom_point() +
  ylab("Mutation rate") +
  theme(legend.position = "none",#c(0.8,0.7),
        legend.background = element_rect(color="black", fill="white", linetype="solid")) +
  scale_color_manual("IO4", values= c("treated"="red", "untreated"="black")) +
  theme(axis.title.x = element_blank(),
        axis.text.x = element_text(angle=90, vjust=0.5))

plot4 <- ggplot(temp4, 
       aes(x=paste0(AA, anticodon), y=deletion/pileup, color=treatment)) +
  facet_grid(cols=vars(modification)) +
  geom_point() +
  ylab("Deletion rate") +
  theme(legend.position = "none",#c(0.8,0.7),
        legend.background = element_rect(color="black", fill="white", linetype="solid")) +
  scale_color_manual("IO4", values= c("treated"="red", "untreated"="black")) +
  theme(axis.title.x = element_blank(),
        axis.text.x = element_text(angle=90, vjust=0.5))



```




#_
#Figure  5 - insodecoders
##Thiol isodecoders
###Glu
####Mutation
```{r}

temp3 <- Q_base %>%
  filter(project=="Q") %>%
  # filter(gene %in% temp_most$gene) %>%
  filter(#(AA=="Arg" & position==34 & base=="T" & anticodon=="TCT") | #Mutation
           (AA=="Glu" & position==34 & base=="T" & anticodon =="TTC"),
           chr %in% c("chr1.trna134", "chr1.trna5","chr13.trna3","chr13.trna5"),
           #(AA=="Gln" & position ==34 & base=="T" & anticodon =="TTG"),
         bin_start=="60",
         #sample == "Q100",
         pileup >= 10
         ) %>%
  mutate(modification = "mcm5s2u34")
temp3$treatment <- recode(temp3$treatment, "minusI"="untreated", "plusI"="treated")


plot1  <- ggplot(temp3, 
       aes(x=paste0(AA, anticodon, chr), y=mutation, color=treatment)) +
  facet_nested(~ modification + sample) +
  geom_point() +
  ylab("Mutation rate") +
  theme(legend.position = "none",#c(0.8,0.7),
        legend.background = element_rect(color="black", fill="white", linetype="solid")) +
  scale_color_manual("IO4", values= c("treated"="red", "untreated"="black")) +
  theme(axis.title.x = element_blank(),
        axis.text.x = element_text(angle=90, vjust=0.5))

layout <- rbind(c(1))
figure <- grid.arrange(plot1,  layout_matrix = layout)

path="../Draft/Figures20220117/"
figure_name="fig_5A_Glu_thiol_isodecoder_mutation"
width=1.5
height=2.5
scale=1.5
dpi=600
# ggsave(paste0(path, figure_name,".svg"), 
#        plot = figure,
#        scale = scale,
#        dpi = dpi,
#        width = width, 
#        height = height)

ggsave(paste0(path, figure_name,".png"),
       plot = figure,
       scale = scale,
       dpi = dpi,
       width = width,
       height = height)
```


####Abundance
```{r}

temp3 <- Q_base %>%
  filter(project=="Q") %>%
  # filter(gene %in% temp_most$gene) %>%
  filter(#(AA=="Arg" & position==34 & base=="T" & anticodon=="TCT") | #Mutation
           (AA=="Glu" & position==34 & base=="T" & anticodon =="TTC"),
           chr %in% c("chr1.trna134", "chr1.trna5","chr13.trna3","chr13.trna5"),
           #(AA=="Gln" & position ==34 & base=="T" & anticodon =="TTG"),
         bin_start=="60",
         #sample == "Q100",
         pileup >= 10
         ) %>%
  mutate(modification = "mcm5s2u34")
temp3$treatment <- recode(temp3$treatment, "minusI"="untreated", "plusI"="treated")


plot1  <- ggplot(filter(temp3), 
       aes(x=paste0(AA, anticodon, chr), y=pileup, color=treatment)) +
  facet_nested(~ modification + sample) +
  geom_point() +
  ylab("Abundance ") +
  theme(legend.position = "none",#c(0.8,0.7),
        legend.background = element_rect(color="black", fill="white", linetype="solid")) +
  scale_color_manual("IO4", values= c("treated"="red", "untreated"="black")) +
  theme(axis.title.x = element_blank(),
        axis.text.x = element_text(angle=90, vjust=0.5)) +
  scale_y_log10()

layout <- rbind(c(1))
figure <- grid.arrange(plot1,  layout_matrix = layout)

path="../Draft/Figures20220117/"
figure_name="fig_5A_Glu_thiol_isodecoder_abundance"
width=1.5
height=2.5
scale=1.5
dpi=600
# ggsave(paste0(path, figure_name,".svg"), 
#        plot = figure,
#        scale = scale,
#        dpi = dpi,
#        width = width, 
#        height = height)

ggsave(paste0(path, figure_name,".png"),
       plot = figure,
       scale = scale,
       dpi = dpi,
       width = width,
       height = height)
```

###ArgTCT
####Mutation
```{r}

temp3 <- Q_base %>%
  filter(project=="Q") %>%
  # filter(gene %in% temp_most$gene) %>%
  filter(#(AA=="Arg" & position==34 & base=="T" & anticodon=="TCT") | #Mutation
           (AA=="Arg" & position==34 & base=="T" & anticodon =="TCT"),
           chr %in% c("chr1.trna9", "chr11.trna3","chr17.trna4","chr9.trna4"),
           #(AA=="Gln" & position ==34 & base=="T" & anticodon =="TTG"),
         bin_start=="60",
         #sample == "Q100",
         pileup >= 10
         ) %>%
  mutate(modification = "mcm5s2U")
temp3$treatment <- recode(temp3$treatment, "minusI"="untreated", "plusI"="treated")


plot1  <- ggplot(temp3, 
       aes(x=paste0(AA, anticodon, chr), y=mutation, color=treatment)) +
  facet_nested(~ modification + sample) +
  geom_point() +
  ylab("Mutation rate") +
  theme(legend.position = "none",#c(0.8,0.7),
        legend.background = element_rect(color="black", fill="white", linetype="solid")) +
  scale_color_manual("IO4", values= c("treated"="red", "untreated"="black")) +
  theme(axis.title.x = element_blank(),
        axis.text.x = element_text(angle=90, vjust=0.5))

layout <- rbind(c(1))
figure <- grid.arrange(plot1,  layout_matrix = layout)

path="../Draft/Figures20220117/"
figure_name="fig_5B_Arg_thiol_isodecoder"
width=1.5
height=2.5
scale=1.5
dpi=600
# ggsave(paste0(path, figure_name,".svg"), 
#        plot = figure,
#        scale = scale,
#        dpi = dpi,
#        width = width, 
#        height = height)

ggsave(paste0(path, figure_name,".png"),
       plot = figure,
       scale = scale,
       dpi = dpi,
       width = width,
       height = height)

```

####Abundance
```{r}

temp3 <- Q_base %>%
  filter(project=="Q") %>%
  # filter(gene %in% temp_most$gene) %>%
  filter(#(AA=="Arg" & position==34 & base=="T" & anticodon=="TCT") | #Mutation
           (AA=="Arg" & position==34 & base=="T" & anticodon =="TCT"),
           chr %in% c("chr1.trna9", "chr11.trna3","chr17.trna4","chr9.trna4"),
           #(AA=="Gln" & position ==34 & base=="T" & anticodon =="TTG"),
         bin_start=="60",
         #sample == "Q100",
         pileup >= 10
         ) %>%
  mutate(modification = "mcm5s2U")
temp3$treatment <- recode(temp3$treatment, "minusI"="untreated", "plusI"="treated")


plot1  <- ggplot(temp3, 
       aes(x=paste0(AA, anticodon, chr), y=pileup, color=treatment)) +
  facet_nested(~ modification + sample) +
  geom_point() +
  ylab("Abundance rate") +
  theme(legend.position = "none",#c(0.8,0.7),
        legend.background = element_rect(color="black", fill="white", linetype="solid")) +
  scale_color_manual("IO4", values= c("treated"="red", "untreated"="black")) +
  theme(axis.title.x = element_blank(),
        axis.text.x = element_text(angle=90, vjust=0.5)) +
  scale_y_log10()

layout <- rbind(c(1))
figure <- grid.arrange(plot1,  layout_matrix = layout)

path="../Draft/Figures20220117/"
figure_name="fig_5B_Arg_thiol_isodecoder_abundance"
width=1.5
height=2.5
scale=1.5
dpi=600
# ggsave(paste0(path, figure_name,".svg"), 
#        plot = figure,
#        scale = scale,
#        dpi = dpi,
#        width = width, 
#        height = height)

ggsave(paste0(path, figure_name,".png"),
       plot = figure,
       scale = scale,
       dpi = dpi,
       width = width,
       height = height)

```



###GlnTTG
####Mutation
```{r}

temp3 <- Q_base %>%
  filter(project=="Q") %>%
  # filter(gene %in% temp_most$gene) %>%
  filter(#(AA=="Arg" & position==34 & base=="T" & anticodon=="TCT") | #Mutation
           (AA=="Gln" & position==34 & base=="T" & anticodon =="TTG"),
           chr %in% c("chr17.trna16", "chr6.trna130","chr6.trna64"),
           #(AA=="Gln" & position ==34 & base=="T" & anticodon =="TTG"),
         bin_start=="60",
         #sample == "Q100",
         pileup >= 10
         ) %>%
  mutate(modification = "mcm5s2U")
temp3$treatment <- recode(temp3$treatment, "minusI"="untreated", "plusI"="treated")


plot1  <- ggplot(temp3, 
       aes(x=paste0(AA, anticodon, chr), y=mutation, color=treatment)) +
  facet_nested(~ modification + sample) +
  geom_point() +
  ylab("Mutation rate") +
  theme(legend.position = "none",#c(0.8,0.7),
        legend.background = element_rect(color="black", fill="white", linetype="solid")) +
  scale_color_manual("IO4", values= c("treated"="red", "untreated"="black")) +
  theme(axis.title.x = element_blank(),
        axis.text.x = element_text(angle=90, vjust=0.5))

layout <- rbind(c(1))
figure <- grid.arrange(plot1,  layout_matrix = layout)

path="../Draft/Figures20220117/"
figure_name="fig_5C_Gln_thiol_isodecoder_mutaiton"
width=1.5
height=2.5
scale=1.5
dpi=600
# ggsave(paste0(path, figure_name,".svg"), 
#        plot = figure,
#        scale = scale,
#        dpi = dpi,
#        width = width, 
#        height = height)

ggsave(paste0(path, figure_name,".png"),
       plot = figure,
       scale = scale,
       dpi = dpi,
       width = width,
       height = height)

```

####Abundance
```{r}

temp3 <- Q_base %>%
  filter(project=="Q") %>%
  # filter(gene %in% temp_most$gene) %>%
  filter(#(AA=="Arg" & position==34 & base=="T" & anticodon=="TCT") | #Mutation
           (AA=="Gln" & position==34 & base=="T" & anticodon =="TTG"),
           chr %in% c("chr17.trna16", "chr6.trna130","chr6.trna64"),
           #(AA=="Gln" & position ==34 & base=="T" & anticodon =="TTG"),
         bin_start=="60",
         #sample == "Q100",
         pileup >= 10
         ) %>%
  mutate(modification = "mcm5s2U")
temp3$treatment <- recode(temp3$treatment, "minusI"="untreated", "plusI"="treated")


plot1  <- ggplot(temp3, 
       aes(x=paste0(AA, anticodon, chr), y=pileup, color=treatment)) +
  facet_nested(~ modification + sample) +
  geom_point() +
  ylab("Abundance") +
  theme(legend.position = "none",#c(0.8,0.7),
        legend.background = element_rect(color="black", fill="white", linetype="solid")) +
  scale_color_manual("IO4", values= c("treated"="red", "untreated"="black")) +
  theme(axis.title.x = element_blank(),
        axis.text.x = element_text(angle=90, vjust=0.5)) +
  scale_y_log10() +
  coord_cartesian(ylim = c(100,10000))

layout <- rbind(c(1))
figure <- grid.arrange(plot1,  layout_matrix = layout)

path="../Draft/Figures20220117/"
figure_name="fig_5C_Gln_thiol_isodecoder_abundance"
width=1.5
height=2.5
scale=1.5
dpi=600
# ggsave(paste0(path, figure_name,".svg"), 
#        plot = figure,
#        scale = scale,
#        dpi = dpi,
#        width = width, 
#        height = height)

ggsave(paste0(path, figure_name,".png"),
       plot = figure,
       scale = scale,
       dpi = dpi,
       width = width,
       height = height)

```



###LysTTT
####Mutation
```{r}

temp3 <- Q_base %>%
  filter(project=="Q") %>%
  # filter(gene %in% temp_most$gene) %>%
  filter(#(AA=="Arg" & position==34 & base=="T" & anticodon=="TCT") | #Mutation
           (AA=="Lys" & position==34 & base=="T" & anticodon =="TTT"),
           # chr %in% c("chr17.trna16", "chr6.trna130","chr6.trna64"),
           #(AA=="Gln" & position ==34 & base=="T" & anticodon =="TTG"),
         bin_start=="60",
         #sample == "Q100",
         pileup >= 10
         ) %>%
  mutate(modification = "mnm5s2U")
temp3$treatment <- recode(temp3$treatment, "minusI"="untreated", "plusI"="treated")


plot1  <- ggplot(temp3, 
       aes(x=paste0(AA, anticodon, chr), y=mutation, color=treatment)) +
  facet_nested(~ modification + sample) +
  geom_point() +
  ylab("Mutation rate") +
  theme(legend.position = "none",#c(0.8,0.7),
        legend.background = element_rect(color="black", fill="white", linetype="solid")) +
  scale_color_manual("IO4", values= c("treated"="red", "untreated"="black")) +
  theme(axis.title.x = element_blank(),
        axis.text.x = element_text(angle=90, vjust=0.5))

layout <- rbind(c(1))
figure <- grid.arrange(plot1,  layout_matrix = layout)

path="../Draft/Figures20220117/"
figure_name="fig_5D_Lys_thiol_isodecoder_mutaiton"
width=1.5
height=3.5
scale=1.5
dpi=600
# ggsave(paste0(path, figure_name,".svg"), 
#        plot = figure,
#        scale = scale,
#        dpi = dpi,
#        width = width, 
#        height = height)

ggsave(paste0(path, figure_name,".png"),
       plot = figure,
       scale = scale,
       dpi = dpi,
       width = width,
       height = height)

```


####Deletion
```{r}

temp3 <- Q_base %>%
  filter(project=="Q") %>%
  # filter(gene %in% temp_most$gene) %>%
  filter(#(AA=="Arg" & position==34 & base=="T" & anticodon=="TCT") | #Mutation
           (AA=="Lys" & position==34 & base=="T" & anticodon =="TTT"),
           # chr %in% c("chr17.trna16", "chr6.trna130","chr6.trna64"),
           #(AA=="Gln" & position ==34 & base=="T" & anticodon =="TTG"),
         bin_start=="60",
         #sample == "Q100",
         pileup >= 10
         ) %>%
  mutate(modification = "mnm5s2U")
temp3$treatment <- recode(temp3$treatment, "minusI"="untreated", "plusI"="treated")


plot1  <- ggplot(temp3, 
       aes(x=paste0(AA, anticodon, chr), y=deletion / pileup, color=treatment)) +
  facet_nested(~ modification + sample) +
  geom_point() +
  ylab("Mutation rate") +
  theme(legend.position = "none",#c(0.8,0.7),
        legend.background = element_rect(color="black", fill="white", linetype="solid")) +
  scale_color_manual("IO4", values= c("treated"="red", "untreated"="black")) +
  theme(axis.title.x = element_blank(),
        axis.text.x = element_text(angle=90, vjust=0.5))

layout <- rbind(c(1))
figure <- grid.arrange(plot1,  layout_matrix = layout)

path="../Draft/Figures20220117/"
figure_name="fig_5D_Lys_thiol_isodecoder_deletion"
width=1.5
height=3.5
scale=1.5
dpi=600
# ggsave(paste0(path, figure_name,".svg"), 
#        plot = figure,
#        scale = scale,
#        dpi = dpi,
#        width = width, 
#        height = height)

ggsave(paste0(path, figure_name,".png"),
       plot = figure,
       scale = scale,
       dpi = dpi,
       width = width,
       height = height)

```

####Abundance
```{r}

temp3 <- Q_base %>%
  filter(project=="Q") %>%
  # filter(gene %in% temp_most$gene) %>%
  filter(#(AA=="Arg" & position==34 & base=="T" & anticodon=="TCT") | #Mutation
           (AA=="Lys" & position==34 & base=="T" & anticodon =="TTT"),
           # chr %in% c("chr17.trna16", "chr6.trna130","chr6.trna64"),
           #(AA=="Gln" & position ==34 & base=="T" & anticodon =="TTG"),
         bin_start=="60",
         #sample == "Q100",
         pileup >= 10
         ) %>%
  mutate(modification = "mnm5s2U")
temp3$treatment <- recode(temp3$treatment, "minusI"="untreated", "plusI"="treated")


plot1  <- ggplot(temp3, 
       aes(x=paste0(AA, anticodon, chr), y=pileup, color=treatment)) +
  facet_nested(~ modification + sample) +
  geom_point() +
  ylab("Abundance") +
  theme(legend.position = "none",#c(0.8,0.7),
        legend.background = element_rect(color="black", fill="white", linetype="solid")) +
  scale_color_manual("IO4", values= c("treated"="red", "untreated"="black")) +
  theme(axis.title.x = element_blank(),
        axis.text.x = element_text(angle=90, vjust=0.5)) +
  scale_y_log10() +
  coord_cartesian(ylim = c(100,10000))

layout <- rbind(c(1))
figure <- grid.arrange(plot1,  layout_matrix = layout)

path="../Draft/Figures20220117/"
figure_name="fig_5D_Lys_thiol_isodecoder_abundance"
width=1.5
height=3.5
scale=1.5
dpi=600
# ggsave(paste0(path, figure_name,".svg"), 
#        plot = figure,
#        scale = scale,
#        dpi = dpi,
#        width = width, 
#        height = height)

ggsave(paste0(path, figure_name,".png"),
       plot = figure,
       scale = scale,
       dpi = dpi,
       width = width,
       height = height)

```


#_
#Figure 6 E. coli
##Gln and Glu next to eachother
###mutation
```{r}
temp1 <- Ecoli_base %>%
  filter(bin_start == "60",
         (anticodon=="TTG" ), #& position ==33 & base=="T"), #both
         pileup >= 100) %>%
  mutate(modification = "cmnm5s2U34")


temp2 <- Ecoli_base %>%
  filter(bin_start == "60",
         (anticodon=="TTC" ), #deletion
         pileup >= 100) %>%
  mutate(modification = "cmnm5s2U34")

temp <- rbind(temp1, temp2)



plot1 <- ggplot(temp, 
       aes(x=position, y=mutation, color=treatment)) +
  facet_nested( paste0(amino_acid, anticodon) ~ modification ) +
  geom_line() +
  coord_cartesian(xlim = c(25,39), ylim = c(0, 0.4) ) +
  scale_x_continuous(breaks=c(26,28,30,32,34,36,38)) +
  ylab("Mutation rate") +
  geom_vline(xintercept = c(33), linetype=2, alpha=0.3) +
  theme(legend.position = "none",#c(0.8,0.7),
        legend.background = element_rect(color="black", fill="white", linetype="solid")) +
  scale_color_manual(values= c("treated"="red", "untreated"="black")) +
  theme(axis.title.x = element_blank(),
        axis.text.x = element_text(angle=90, vjust=0.5)) 

layout <- rbind(c(1))
figure <- grid.arrange(plot1,  layout_matrix = layout)

path="../Draft/Figures20220117//"
figure_name="fig_5X_Ecoli_GlnGlu_mutation"
width=2.5
height=2.5
scale=1.5
dpi=600
# ggsave(paste0(path, figure_name,".svg"), 
#        plot = figure,
#        scale = scale,
#        dpi = dpi,
#        width = width, 
#        height = height)

ggsave(paste0(path, figure_name,".png"),
       plot = figure,
       scale = scale,
       dpi = dpi,
       width = width,
       height = height)
```

###Deletion
```{r}
temp1 <- Ecoli_base %>%
  filter(bin_start == "60",
         (anticodon=="TTG" ), #& position ==33 & base=="T"), #both
         pileup >= 100) %>%
  mutate(modification = "cmnm5s2U34")


temp2 <- Ecoli_base %>%
  filter(bin_start == "60",
         (anticodon=="TTC" ), #deletion
         pileup >= 100) %>%
  mutate(modification = "cmnm5s2U34")

temp <- rbind(temp1, temp2)



plot1 <- ggplot(temp, 
       aes(x=position, y=deletion / pileup, color=treatment)) +
  facet_nested( paste0(amino_acid, anticodon) ~ modification ) +
  geom_line() +
  coord_cartesian(xlim = c(25,39), ylim = c(0, 0.4) ) +
  scale_x_continuous(breaks=c(26,28,30,32,34,36,38)) +
  ylab("Deletion rate") +
  geom_vline(xintercept = c(33), linetype=2, alpha=0.3) +
  theme(legend.position = "none",#c(0.8,0.7),
        legend.background = element_rect(color="black", fill="white", linetype="solid")) +
  scale_color_manual(values= c("treated"="red", "untreated"="black")) +
  theme(axis.title.x = element_blank(),
        axis.text.x = element_text(angle=90, vjust=0.5)) 

layout <- rbind(c(1))
figure <- grid.arrange(plot1,  layout_matrix = layout)

path="../Draft/Figures20220117//"
figure_name="fig_5X_Ecoli_GlnGlu_deletion"
width=2.5
height=2.5
scale=1.5
dpi=600
# ggsave(paste0(path, figure_name,".svg"), 
#        plot = figure,
#        scale = scale,
#        dpi = dpi,
#        width = width, 
#        height = height)

ggsave(paste0(path, figure_name,".png"),
       plot = figure,
       scale = scale,
       dpi = dpi,
       width = width,
       height = height)
```







#_
#_

















#_
#Old
##Figure 1 - Proof of concept with His
###Fig 1B: His plieup, mutation, stop, deletion, insertion
```{r}
temp <- Q_base %>%
  filter(project=="Q") %>%
  filter(AA=="His", source=="cytosolic",
         chr == "chr1.trna111",
         bin_start=="60",
         sample=="Q0",
         pileup >=500) 

#To do RPM normalization, gott know how many reads in each sample
temp1 <- Q_count %>%
  filter(project=="Q",
         bin_start %in% c("-1", "-2", "-3")) %>%
  group_by(treatment, rep, sample) %>%
  summarise(total_count = sum(count))

temp <-  temp %>%
  full_join(., temp1, by=c("treatment","rep","sample"))

temp$treatment <- recode(temp$treatment, "minusI"="untreated", "plusI"="treated")


plot1 <- ggplot(filter(temp, 
              ),
       aes(x=position, y= pileup / total_count *1000000, color=treatment, group = interaction(treatment, rep, sample, gene))) +
  geom_line() +
  # coord_cartesian(ylim = c(-0.015,0.1)) +
  # geom_text(aes(label=base), y=5200, color="black", size=2) +
  scale_color_manual("IO4", values= c("treated"="red", "untreated"="black")) +
  # scale_y_continuous(breaks=c(5000,15000, 25000)) +
  ylab("RPM\n") +
  geom_vline(xintercept = c(34), linetype=2, alpha=0.3)  +
  theme(legend.position = "top") +
  theme(axis.title.x = element_blank()) 

plot2 <- ggplot(filter(temp, 
              ),
       aes(x=position, y= mutation, color=treatment, group = interaction(treatment, rep, sample, gene))) +
  geom_line() +
  coord_cartesian(ylim = c(-0.015,0.05)) +
  # geom_text(aes(label=base), y=-0.01, color="black") +
  scale_color_manual("IO4", values= c("treated"="red", "untreated"="black")) +
  geom_vline(xintercept = c(34), linetype=2, alpha=0.3) +
  ylab("Mutation\nrate") +
  theme(legend.position = "None") +
  theme(axis.title.x = element_blank())

plot3 <- ggplot(filter(temp, 
              ),
       aes(x=position, y= deletion / pileup, color=treatment, group = interaction(treatment, rep, sample, gene))) +
  geom_line() +
  coord_cartesian(ylim = c(-0.015,0.1)) +
  # geom_text(aes(label=base), y=-0.01, color="black") +
  scale_color_manual("IO4", values= c("treated"="red", "untreated"="black")) +
  geom_vline(xintercept = c(34), linetype=2, alpha=0.3) +
  ylab("Deletion\nrate") +
  theme(legend.position = "None") +
  theme(axis.title.x = element_blank())

plot4 <- ggplot(filter(temp, 
              ),
       aes(x=position, y= insertion / pileup, color=treatment, group = interaction(treatment, rep, sample, gene))) +
  geom_line() +
  coord_cartesian(ylim = c(-0.015,0.02)) +
  # geom_text(aes(label=base), y=-0.01, color="black") +
  scale_color_manual("IO4", values= c("treated"="red", "untreated"="black")) +
  geom_vline(xintercept = c(34), linetype=2, alpha=0.3) +
  ylab("Insertion\nrate") +
  theme(legend.position = "None") +
  theme(axis.title.x = element_blank()) 

plot5 <- ggplot(filter(temp, 
              ),
       aes(x=position, y= stop, color=treatment, group = interaction(treatment, rep, sample, gene))) +
  geom_line() +
  coord_cartesian(ylim = c(-0.015,0.1)) +
  # geom_text(aes(label=base), y=-0.01, color="black") +
  scale_color_manual("IO4", values= c("treated"="red", "untreated"="black")) +
  geom_vline(xintercept = c(34), linetype=2, alpha=0.3) +
  ylab("Stop\nrate") +
  theme(legend.position = "None") +
  theme(axis.title.x = element_blank())




layout <- rbind(c(1),c(2),c(3),c(4),c(5))
myplot <- grid.arrange(plot1,plot2,plot3,plot4,plot5,  layout_matrix = layout)


figure <- arrangeGrob(myplot, bottom = textGrob("Position",
         gp=gpar(col="black", fontsize=16, fontfamily="Arial")))

path="../Draft/Figures20211230/"
figure_name="fig_1b_His_features"
width=2.5
height=5
scale=1.5
dpi=600
# ggsave(paste0(path, figure_name,".svg"), 
#        plot = figure,
#        scale = scale,
#        dpi = dpi,
#        width = width, 
#        height = height)

ggsave(paste0(path, figure_name,".png"),
       plot = figure,
       scale = scale,
       dpi = dpi,
       width = width,
       height = height)

```


###Fig 1D: 0Q 100Q
```{r}
temp <- Q_base %>%
  filter(project=="Q") %>%
  filter(AA=="His", source=="cytosolic",
         chr == "chr1.trna111",
         bin_start=="60",
         treatment=="plusI",
         pileup >=500)

temp$treatment <- recode(temp$treatment, "minusI"="untreated", "plusI"="treated")
temp$sample <- recode(temp$sample, "Q0"="0Q", "Q100"="100Q")

plot1 <- ggplot(filter(temp, 
              ),
       aes(x=position, y= deletion / pileup, color=sample, group = interaction(treatment, rep, sample, gene))) +
  geom_line() +
  coord_cartesian(ylim = c(-0.015,0.1)) +
  # geom_text(aes(label=base), y=-0.01, color="black") +
  geom_vline(xintercept = c(34), linetype=2, alpha=0.3) +
  scale_color_manual(values = c("0Q"="blue", "100Q"="red")) +
  labs(color="Sample") +
  ylab("Deletion rate") +
  theme(#legend.position = c(0.87,0.8),
        legend.position = "right",
        #legend.background = element_rect(color="black")
        )

layout <- rbind(c(1))
figure <- grid.arrange(plot1,  layout_matrix = layout)

path="../Draft/Figures20211227/"
figure_name="fig_1d_His_0Q_100Q"
width=3
height=1.75
scale=1.5
dpi=600
# ggsave(paste0(path, figure_name,".svg"), 
#        plot = figure,
#        scale = scale,
#        dpi = dpi,
#        width = width, 
#        height = height)

ggsave(paste0(path, figure_name,".png"),
       plot = figure,
       scale = scale,
       dpi = dpi,
       width = width,
       height = height)

```


###Fig 1E: Calibration curve
```{r}
temp <- Qcal_base %>%
  filter(AA=="His", #source=="cytosolic",
         chr == "chr1.trna111",
         bin_start=="60",
         pileup >=500,
         position==34) %>%
  mutate(Qlevel = sample)

temp$Qlevel <- recode(temp$Qlevel, "Q0"=0, "Q10"=10, "Q20"=20, "Q30"=30, "Q40"=40, 
                      "Q50"=50, "Q60"=60, "Q70"=70, "Q80"=80, "Q90"=90, "Q100"=100)
 


 
cor(temp$Qlevel, temp$deletion/ temp$pileup)**2

plot1 <- ggplot(filter(temp, position==34), aes(x=Qlevel, y=deletion / pileup)) +
  geom_point() +
  geom_line(stat="smooth", method="lm", linetype=2, se=F, alpha=0.5) +
  ylab("Deletion rate") +
  xlab("Fraction Q modified") +
  annotate("text",x=20, y=0.035, label=paste0("r^2 = ", "0.895"))



layout <- rbind(c(1))
figure <- grid.arrange(plot1,  layout_matrix = layout)

path="../Draft/Figures20211230/"
figure_name="fig_1e_calibration_curve"
width=2.5
height=1.75
scale=1.5
dpi=600
# ggsave(paste0(path, figure_name,".svg"), 
#        plot = figure,
#        scale = scale,
#        dpi = dpi,
#        width = width, 
#        height = height)

ggsave(paste0(path, figure_name,".png"),
       plot = figure,
       scale = scale,
       dpi = dpi,
       width = width,
       height = height)
```

####Normalized calibration
```{r}
temp <- Qcal_base %>%
  filter(pileup >= 10000,
         bin_start=="60") %>%
  mutate(Qlevel = sample) %>%
  filter(AA %in% c("Asp","Asn","His","Tyr"),
         base == "G",
         position %in% c(34, 35)
         ) %>%
  group_by(AA, anticodon, chr) %>%
  mutate(normalized_deletion = (deletion / pileup) / max( (deletion / pileup) ) )
         
         
temp$Qlevel <- recode(temp$Qlevel, "Q0"=0, "Q10"=10, "Q20"=20, "Q30"=30, "Q40"=40, 
                      "Q50"=50, "Q60"=60, "Q70"=70, "Q80"=80, "Q90"=90, "Q100"=100)
      

ggplot(filter(temp, #AA!="Asp"
              ), aes(x=Qlevel, y=normalized_deletion)) +
  geom_point() +
  geom_line(stat="smooth", method="lm", linetype=2, se=F, alpha=0.5) +
  # ylab("Deletion rate") +
  xlab("Fraction Q modified") +
  # scale_y_log10() +
  facet_wrap(~paste0(AA, anticodon))
  # annotate("text",x=20, y=0.035, label=paste0("r^2 = ", "0.895"))
       
       
```

####Raw 
```{r}
temp <- Qcal_base %>%
  filter(pileup >= 10000,
         bin_start=="60") %>%
  mutate(Qlevel = sample) %>%
  filter(AA %in% c("Asp","Asn","His","Tyr"),
         base == "G",
         position %in% c(34, 35)
         ) %>%
  group_by(AA, anticodon, chr) %>%
  mutate(normalized_deletion = (deletion / pileup) / max( (deletion / pileup) ) )
         
         
temp$Qlevel <- recode(temp$Qlevel, "Q0"=0, "Q10"=10, "Q20"=20, "Q30"=30, "Q40"=40, 
                      "Q50"=50, "Q60"=60, "Q70"=70, "Q80"=80, "Q90"=90, "Q100"=100)
      

ggplot(filter(temp, #AA!="Asp"
              ), aes(x=Qlevel, y=deletion  / pileup)) +
  geom_point() +
  geom_line(stat="smooth", method="lm", linetype=2, se=F, alpha=0.5) +
  # ylab("Deletion rate") +
  xlab("Fraction Q modified") +
  # scale_y_log10() +
  facet_wrap(~paste0(AA, anticodon))
  # annotate("text",x=20, y=0.035, label=paste0("r^2 = ", "0.895"))
       
       
```

####mt
```{r}
temp <- Qcal_base %>%
  filter(pileup >= 1000,
         bin_start=="60") %>%
  mutate(Qlevel = sample) %>%
  filter(#AA %in% c("Asp","Asn","His","Tyr"),
         base == "G",
         #position %in% c(34, 35)
         (AA=="mtHis" & position==31)|(AA=="mtAsp" & position==31)|(AA=="mtAsn"&position==34)|(AA=="mtTyr"&position==30)
         ) %>%
  group_by(AA, anticodon, chr) %>%
  mutate(normalized_deletion = (deletion / pileup) / max( (deletion / pileup) ) )
         
         
temp$Qlevel <- recode(temp$Qlevel, "Q0"=0, "Q10"=10, "Q20"=20, "Q30"=30, "Q40"=40, 
                      "Q50"=50, "Q60"=60, "Q70"=70, "Q80"=80, "Q90"=90, "Q100"=100)
      

ggplot(filter(temp, #AA!="Asp"
              ), aes(x=Qlevel, y=deletion / pileup)) +
  geom_point() +
  geom_line(stat="smooth", method="lm", linetype=2, se=F, alpha=0.5) +
  # ylab("Deletion rate") +
  xlab("Fraction Q modified") +
  # scale_y_log10() +
  facet_wrap(~paste0(AA, anticodon))
  # annotate("text",x=20, y=0.035, label=paste0("r^2 = ", "0.895"))
       
       
```




#_
##Figure 2 - all the tRNAs
###Fig 2A: Asp
```{r}
temp <- Q_base %>%
  filter(project=="Q") %>%
  filter(AA=="Asp", source=="cytosolic",
         # chr == "chr1.trna69",
         bin_start=="60",
         sample == "Q0",
         pileup >= 100)
temp$treatment <- recode(temp$treatment, "minusI"="untreated", "plusI"="treated")


plot1 <- ggplot(filter(temp, 
              chr == "chr1.trna69",
              ),
       aes(x=position, y=deletion/pileup, color=treatment, group = interaction(treatment, rep, sample, gene))) +
  geom_line() +
  coord_cartesian(ylim = c(-0.015,0.05)) +
  # geom_text(aes(label=base), y=-0.01, color="black") +
  geom_vline(xintercept = c(34), linetype=2, alpha=0.3) +
  scale_color_manual("IO4", values= c("treated"="red", "untreated"="black")) +
  ylab("Deletion rate") +
  xlab("Position") +
  facet_grid(cols=vars( paste0(AA, anticodon, chr, " - ", sample)) ) +
  theme(legend.position = c(0.77,0.7),
        legend.background = element_rect(color="black", fill="white", linetype="solid"))

layout <- rbind(c(1))
figure <- grid.arrange(plot1,  layout_matrix = layout)

path="../Draft/Figures20211230/"
figure_name="fig_2a_Asp"
width=2.25
height=1.75
scale=1.5
dpi=600
# ggsave(paste0(path, figure_name,".svg"), 
#        plot = figure,
#        scale = scale,
#        dpi = dpi,
#        width = width, 
#        height = height)

ggsave(paste0(path, figure_name,".png"),
       plot = figure,
       scale = scale,
       dpi = dpi,
       width = width,
       height = height)
```


###Fig 2B: Asn
```{r}
temp <- Q_base %>%
  filter(project=="Q") %>%
  filter(AA=="Asn", source=="cytosolic",
         # chr == "chr1.trna26",
         bin_start=="60",
         sample=="Q0",
         pileup >= 100)

temp$treatment <- recode(temp$treatment, "minusI"="untreated", "plusI"="treated")
plot1 <- ggplot(filter(temp, 
              chr=="chr1.trna26"
              # chr=="chr1.trna50"
              ),
       aes(x=position, y=deletion/pileup, color=treatment, group = interaction(treatment, rep, sample, gene))) +
  geom_line() +
  coord_cartesian(ylim = c(-0.015,0.15)) +
  # geom_text(aes(label=base), y=-0.01, color="black") +
  geom_vline(xintercept = c(35), linetype=2, alpha=0.3) +
  scale_color_manual("IO4", values= c("treated"="red", "untreated"="black")) +
  ylab("Deletion rate") +
  xlab("Position") +
  facet_grid(cols=vars( paste0(AA, anticodon, chr)) ) +
  theme(#legend.position = c(0.8,0.7),
        legend.position = "none",
        legend.background = element_rect(color="black", fill="white", linetype="solid"))

layout <- rbind(c(1))
figure <- grid.arrange(plot1,  layout_matrix = layout)

path="../Draft/Figures20211230/"
figure_name="fig_2b_Asn"
width=2.25
height=1.75
scale=1.5
dpi=600
# ggsave(paste0(path, figure_name,".svg"), 
#        plot = figure,
#        scale = scale,
#        dpi = dpi,
#        width = width, 
#        height = height)

ggsave(paste0(path, figure_name,".png"),
       plot = figure,
       scale = scale,
       dpi = dpi,
       width = width,
       height = height)
```



###Fig 2C: Tyr
```{r}
temp <- Q_base %>%
  filter(project=="Q") %>%
  filter(AA=="Tyr", source=="cytosolic",
         chr == "chr14.trna16",
         bin_start=="60",
         sample == "Q0",
         pileup >= 100)

temp$treatment <- recode(temp$treatment, "minusI"="untreated", "plusI"="treated")
plot1 <- ggplot(filter(temp, 
                chr == "chr14.trna16"
              ),
       aes(x=position, y=deletion/pileup, color=treatment, group = interaction(treatment, rep, sample, gene))) +
  geom_line() +
  coord_cartesian(ylim = c(-0.015,0.1)) +
  # geom_text(aes(label=base), y=-0.01, color="black") +
  geom_vline(xintercept = c(34), linetype=2, alpha=0.3) +
  scale_color_manual("IO4", values= c("treated"="red", "untreated"="black")) +
  ylab("Deletion rate") +
  xlab("Position") +
  facet_grid(cols=vars( paste0(AA, anticodon, chr)) ) +
  theme(#legend.position = c(0.8,0.7),
        legend.position = "none",
        legend.background = element_rect(color="black", fill="white", linetype="solid"))

layout <- rbind(c(1))
figure <- grid.arrange(plot1,  layout_matrix = layout)

path="../Draft/Figures20211230/"
figure_name="fig_2c_Tyr"
width=2.25
height=1.75
scale=1.5
dpi=600
# ggsave(paste0(path, figure_name,".svg"), 
#        plot = figure,
#        scale = scale,
#        dpi = dpi,
#        width = width, 
#        height = height)

ggsave(paste0(path, figure_name,".png"),
       plot = figure,
       scale = scale,
       dpi = dpi,
       width = width,
       height = height)

```



###Fig 2D: mtHis
```{r}
temp <- Q_base %>%
  filter(project=="Q") %>%
  filter(AA=="mtHis", #source=="cytosolic",
         # chr == "chr14.trna16",
         bin_start=="-2",
         sample=="Q0",
         pileup >= 500)

temp$treatment <- recode(temp$treatment, "minusI"="untreated", "plusI"="treated")

plot1 <- ggplot(filter(temp, 
              ),
       aes(x=position, y=deletion/pileup, color=treatment, group = interaction(treatment, rep, sample, gene))) +
  geom_line() +
  coord_cartesian(ylim = c(-0.015,0.15)) +
  # geom_text(aes(label=base), y=-0.01, color="black") +
  geom_vline(xintercept = c(31), linetype=2, alpha=0.3) +
  scale_color_manual("IO4", values= c("treated"="red", "untreated"="black")) +
  ylab("Deletion rate") +
  xlab("Position") +
  facet_grid(cols=vars( paste0(AA, anticodon, chr)) ) +
  theme(#legend.position = c(0.8,0.7),
        legend.position = "none",
        legend.background = element_rect(color="black", fill="white", linetype="solid"))

layout <- rbind(c(1))
figure <- grid.arrange(plot1,  layout_matrix = layout)

path="../Draft/Figures20211230/"
figure_name="fig_2d_mtHis"
width=2.25
height=1.75
scale=1.5
dpi=600
# ggsave(paste0(path, figure_name,".svg"), 
#        plot = figure,
#        scale = scale,
#        dpi = dpi,
#        width = width, 
#        height = height)

ggsave(paste0(path, figure_name,".png"),
       plot = figure,
       scale = scale,
       dpi = dpi,
       width = width,
       height = height)
```

###Fig 2E: mtAsp
```{r}
temp <- Q_base %>%
  filter(project=="Q") %>%
  filter(AA=="mtAsp", #source=="cytosolic",
         # chr == "chr14.trna16",
         bin_start=="-2",
         sample=="Q0",
         pileup >= 500)

temp$treatment <- recode(temp$treatment, "minusI"="untreated", "plusI"="treated")

plot1 <- ggplot(filter(temp, 
              ),
       aes(x=position, y=deletion/pileup, color=treatment, group = interaction(treatment, rep, sample, gene))) +
  geom_line() +
  coord_cartesian(ylim = c(-0.015,0.1)) +
  # geom_text(aes(label=base), y=-0.01, color="black") +
  geom_vline(xintercept = c(31), linetype=2, alpha=0.3) +
  scale_color_manual("IO4", values= c("treated"="red", "untreated"="black")) +
  ylab("Deletion rate") +
  xlab("Position") +
  facet_grid(cols=vars( paste0(AA, anticodon, chr)) ) +
  theme(#legend.position = c(0.8,0.7),
        legend.position = "none",
        legend.background = element_rect(color="black", fill="white", linetype="solid"))

layout <- rbind(c(1))
figure <- grid.arrange(plot1,  layout_matrix = layout)

path="../Draft/Figures20211230/"
figure_name="fig_2e_mtAsp"
width=2.25
height=1.75
scale=1.5
dpi=600
# ggsave(paste0(path, figure_name,".svg"), 
#        plot = figure,
#        scale = scale,
#        dpi = dpi,
#        width = width, 
#        height = height)

ggsave(paste0(path, figure_name,".png"),
       plot = figure,
       scale = scale,
       dpi = dpi,
       width = width,
       height = height)
```

###Fig 2F: mtAsn
```{r}
temp <- Q_base %>%
  filter(project=="Q") %>%
  filter(AA=="mtAsn", #source=="cytosolic",
         # chr == "chr14.trna16",
         bin_start=="-2",
         sample=="Q0",
         pileup >= 500)

temp$treatment <- recode(temp$treatment, "minusI"="untreated", "plusI"="treated")

plot1 <- ggplot(filter(temp, 
              ),
       aes(x=position, y=deletion/pileup, color=treatment, group = interaction(treatment, rep, sample, gene))) +
  geom_line() +
  coord_cartesian(ylim = c(-0.015,0.25)) +
  # geom_text(aes(label=base), y=-0.01, color="black") +
  geom_vline(xintercept = c(34), linetype=2, alpha=0.3) +
  scale_color_manual("IO4", values= c("treated"="red", "untreated"="black")) +
  ylab("Deletion rate") +
  xlab("Position") +
  facet_grid(cols=vars( paste0(AA, anticodon, chr)) ) +
  theme(#legend.position = c(0.8,0.7),
        legend.position = "none",
        legend.background = element_rect(color="black", fill="white", linetype="solid"))

layout <- rbind(c(1))
figure <- grid.arrange(plot1,  layout_matrix = layout)

path="../Draft/Figures20211230/"
figure_name="fig_2f_mtAsn"
width=2.25
height=1.75
scale=1.5
dpi=600
# ggsave(paste0(path, figure_name,".svg"), 
#        plot = figure,
#        scale = scale,
#        dpi = dpi,
#        width = width, 
#        height = height)

ggsave(paste0(path, figure_name,".png"),
       plot = figure,
       scale = scale,
       dpi = dpi,
       width = width,
       height = height)
```


###Fig 2G: mtTyr
```{r}
temp <- Q_base %>%
  filter(project=="Q") %>%
  filter(AA=="mtTyr", #source=="cytosolic",
         # chr == "chr14.trna16",
         bin_start=="-2",
         sample=="Q0",
         pileup >= 500)

temp$treatment <- recode(temp$treatment, "minusI"="untreated", "plusI"="treated")

plot1 <- ggplot(filter(temp, 
              ),
       aes(x=position, y=deletion/pileup, color=treatment, group = interaction(treatment, rep, sample, gene))) +
  geom_line() +
  coord_cartesian(ylim = c(-0.015,0.2)) +
  # geom_text(aes(label=base), y=-0.01, color="black") +
  geom_vline(xintercept = c(30), linetype=2, alpha=0.3) +
  scale_color_manual("IO4", values= c("treated"="red", "untreated"="black")) +
  ylab("Deletion rate") +
  xlab("Position") +
  facet_grid(cols=vars( paste0(AA, anticodon, chr)) ) +
  theme(#legend.position = c(0.8,0.7),
        legend.position = "none",
        legend.background = element_rect(color="black", fill="white", linetype="solid"))

layout <- rbind(c(1))
figure <- grid.arrange(plot1,  layout_matrix = layout)

path="../Draft/Figures20211230/"
figure_name="fig_2g_mtTyr"
width=2.25
height=1.75
scale=1.5
dpi=600
# ggsave(paste0(path, figure_name,".svg"), 
#        plot = figure,
#        scale = scale,
#        dpi = dpi,
#        width = width, 
#        height = height)

ggsave(paste0(path, figure_name,".png"),
       plot = figure,
       scale = scale,
       dpi = dpi,
       width = width,
       height = height)

```




#_
##Supp Fig 1: isodecoder abundance

###Fig s1a: Asp isodecoders
```{r}
temp <- Q_base %>%
  filter(project=="Q") %>%
  filter(AA=="Asp", source=="cytosolic",
         # chr == "chr1.trna69",
         bin_start=="60",
         sample == "Q100",
         pileup >= 100)
temp$treatment <- recode(temp$treatment, "minusI"="untreated", "plusI"="treated")

plot1 <- ggplot(filter(temp, position==34, base=="G",
              (chr=="chr1.trna69" & position==34)|(chr=="chr12.trna5" & position==34)|(chr=="chr6.trna144" & position==34),
              base=="G",
              # sample=="Q100"
              ), 
       aes(x=paste0(AA, anticodon,"\n", chr), y=deletion/pileup, color=treatment, group= interaction(treatment, rep, sample, gene))) +
  geom_point() +
  scale_color_manual("IO4", values= c("treated"="red", "untreated"="black")) +
  ylab("Deletion rate") +
  theme(axis.text.x = element_text(angle=90, vjust=0.5),
        axis.title.x = element_blank(),
        legend.position = "none") 
  # facet_grid(cols=vars(sample))

layout <- rbind(c(1))
figure <- grid.arrange(plot1,  layout_matrix = layout)

path="../Draft/Figures20211230/"
figure_name="fig_s1a_Asp_isodecoders"
width=2
height=1.75
scale=1.5
dpi=600
# ggsave(paste0(path, figure_name,".svg"), 
#        plot = figure,
#        scale = scale,
#        dpi = dpi,
#        width = width, 
#        height = height)

ggsave(paste0(path, figure_name,".png"),
       plot = figure,
       scale = scale,
       dpi = dpi,
       width = width,
       height = height)

```

###Fig s1b: Asp isodecoders
```{r}
temp <- Q_base %>%
  filter(project=="Q") %>%
  filter(AA=="Asp", source=="cytosolic",
         # chr == "chr1.trna69",
         bin_start=="60",
         sample == "Q100",
         pileup >= 100) 

#To do RPM normalization, gott know how many reads in each sample
temp1 <- Q_count %>%
  filter(project=="Q",
         bin_start %in% c("-1", "-2", "-3")) %>%
  group_by(treatment, rep, sample) %>%
  summarise(total_count = sum(count))
temp <-  temp %>%
  full_join(., temp1, by=c("treatment","rep","sample"))

temp$treatment <- recode(temp$treatment, "minusI"="untreated", "plusI"="treated")


plot1 <- ggplot(filter(temp, position==34, base=="G",
              (chr=="chr1.trna69" & position==34)|(chr=="chr12.trna5" & position==34)|(chr=="chr6.trna144" & position==34),
              base=="G",
              sample=="Q100"), 
       aes(x=paste0(AA, anticodon,"\n", chr), y=pileup/total_count*1000000, color=treatment, group= interaction(treatment, rep, sample, gene))) +
  geom_point() +
  scale_color_manual("IO4", values= c("treated"="red", "untreated"="black")) +
  ylab("Abundance (RPM)") +
  scale_y_log10() +
  theme(axis.text.x = element_text(angle=90, vjust=0.5),
        axis.title.x = element_blank(),
        legend.position = "none")

layout <- rbind(c(1))
figure <- grid.arrange(plot1,  layout_matrix = layout)

path="../Draft/Figures20211227/"
figure_name="fig_s1b_Asp_abundance"
width=2
height=1.75
scale=1.5
dpi=600
# ggsave(paste0(path, figure_name,".svg"), 
#        plot = figure,
#        scale = scale,
#        dpi = dpi,
#        width = width, 
#        height = height)

ggsave(paste0(path, figure_name,".png"),
       plot = figure,
       scale = scale,
       dpi = dpi,
       width = width,
       height = height)

```

###Fig s1c: Asn isodecoders
```{r}
temp <- Q_base %>%
  filter(project=="Q") %>%
  filter(AA=="Asn", source=="cytosolic",
         # chr == "chr1.trna26",
         bin_start=="60",
         sample=="Q100",
         pileup >= 100)
temp$treatment <- recode(temp$treatment, "minusI"="untreated", "plusI"="treated")

plot1 <- ggplot(filter(temp, position%in% c(34,35), base=="G",
              # (chr=="chr1.trna69" & position==34)|(chr=="chr12.trna5" & position==34)|(chr=="chr6.trna144" & position==34),
              ), 
       aes(x=paste0(AA, anticodon, "\n",chr), y=deletion/pileup, color=treatment, group= interaction(treatment, rep, sample, gene))) +
  geom_point() +
  scale_color_manual("IO4", values= c("treated"="red", "untreated"="black")) +
  ylab("Deletion rate") +
  theme(axis.text.x = element_text(angle=90, vjust=0.5, size=7),
        axis.title.x = element_blank(),
        legend.position = "none")

layout <- rbind(c(1))
figure <- grid.arrange(plot1,  layout_matrix = layout)

path="../Draft/Figures20211227/"
figure_name="fig_s1c_Asn_isodecoders"
width=2
height=1.75
scale=1.5
dpi=600
# ggsave(paste0(path, figure_name,".svg"), 
#        plot = figure,
#        scale = scale,
#        dpi = dpi,
#        width = width, 
#        height = height)

ggsave(paste0(path, figure_name,".png"),
       plot = figure,
       scale = scale,
       dpi = dpi,
       width = width,
       height = height)

```

###Fig s1d: Asn isodecoders
```{r}
temp <- Q_base %>%
  filter(project=="Q") %>%
  filter(AA=="Asn", source=="cytosolic",
         # chr == "chr1.trna26",
         bin_start=="60",
         sample=="Q100",
         pileup >= 100)

#To do RPM normalization, gott know how many reads in each sample
temp1 <- Q_count %>%
  filter(project=="Q",
         bin_start %in% c("-1", "-2", "-3")) %>%
  group_by(treatment, rep, sample) %>%
  summarise(total_count = sum(count))
temp <-  temp %>%
  full_join(., temp1, by=c("treatment","rep","sample"))

temp$treatment <- recode(temp$treatment, "minusI"="untreated", "plusI"="treated")


plot1 <- ggplot(filter(temp, position %in% c(34,35), base=="G",
              # (chr=="chr1.trna69" & position==34)|(chr=="chr12.trna5" & position==34)|(chr=="chr6.trna144" & position==34),
              base=="G",
              sample=="Q100"), 
       aes(x=paste0(AA, anticodon,"\n", chr), y=pileup/total_count*1000000, color=treatment, group= interaction(treatment, rep, sample, gene))) +
  geom_point() +
  scale_color_manual("IO4", values= c("treated"="red", "untreated"="black")) +
  ylab("Abundance (RPM)") +
  scale_y_log10() +
  theme(axis.text.x = element_text(angle=90, vjust=0.5, size=7),
        axis.title.x = element_blank(),
        legend.position = "none")

layout <- rbind(c(1))
figure <- grid.arrange(plot1,  layout_matrix = layout)

path="../Draft/Figures20211227/"
figure_name="fig_s1d_Asn_abundance"
width=2
height=1.75
scale=1.5
dpi=600
# ggsave(paste0(path, figure_name,".svg"), 
#        plot = figure,
#        scale = scale,
#        dpi = dpi,
#        width = width, 
#        height = height)

ggsave(paste0(path, figure_name,".png"),
       plot = figure,
       scale = scale,
       dpi = dpi,
       width = width,
       height = height)

```

###Fig s1e Tyr isodecoders
```{r}
temp <- Q_base %>%
  filter(project=="Q") %>%
  filter(AA=="Tyr", source=="cytosolic",
         # chr == "chr1.trna69",
         bin_start=="60",
         sample == "Q100",
         pileup >= 100)
temp$treatment <- recode(temp$treatment, "minusI"="untreated", "plusI"="treated")

plot1 <- ggplot(filter(temp, position %in% c(34,35), base=="G",
              # (chr=="chr1.trna69" & position==34)|(chr=="chr12.trna5" & position==34)|(chr=="chr6.trna144" & position==34),
              sample=="Q100"), 
       aes(x=paste0(AA, anticodon, "\n",chr), y=deletion/pileup, color=treatment, group= interaction(treatment, rep, sample, gene))) +
  geom_point() +
  scale_color_manual("IO4", values= c("treated"="red", "untreated"="black")) +
  ylab("Deletion rate") +
  theme(axis.text.x = element_text(angle=90, vjust=0.5),
        axis.title.x = element_blank(),
        legend.position = "none")


layout <- rbind(c(1))
figure <- grid.arrange(plot1,  layout_matrix = layout)

path="../Draft/Figures20211227/"
figure_name="fig_s1e_Tyr_isodecoder"
width=4
height=1.75
scale=1.5
dpi=600
# ggsave(paste0(path, figure_name,".svg"), 
#        plot = figure,
#        scale = scale,
#        dpi = dpi,
#        width = width, 
#        height = height)

ggsave(paste0(path, figure_name,".png"),
       plot = figure,
       scale = scale,
       dpi = dpi,
       width = width,
       height = height)
```

###Fig s1f: Tyr isodecoders
```{r}
temp <- Q_base %>%
  filter(project=="Q") %>%
  filter(AA=="Tyr", source=="cytosolic",
         # chr == "chr1.trna26",
         bin_start=="60",
         sample=="Q100",
         pileup >= 100)

#To do RPM normalization, gott know how many reads in each sample
temp1 <- Q_count %>%
  filter(project=="Q",
         bin_start %in% c("-1", "-2", "-3")) %>%
  group_by(treatment, rep, sample) %>%
  summarise(total_count = sum(count))
temp <-  temp %>%
  full_join(., temp1, by=c("treatment","rep","sample"))

temp$treatment <- recode(temp$treatment, "minusI"="untreated", "plusI"="treated")


plot1 <- ggplot(filter(temp, position %in% c(34,35), base=="G",
              # (chr=="chr1.trna69" & position==34)|(chr=="chr12.trna5" & position==34)|(chr=="chr6.trna144" & position==34),
              base=="G",
              sample=="Q100"), 
       aes(x=paste0(AA, anticodon,"\n", chr), y=pileup/total_count*1000000, color=treatment, group= interaction(treatment, rep, sample, gene))) +
  geom_point() +
  scale_color_manual("IO4", values= c("treated"="red", "untreated"="black")) +
  ylab("Abundance (RPM)") +
  scale_y_log10() +
  theme(axis.text.x = element_text(angle=90, vjust=0.5),
        axis.title.x = element_blank(),
        legend.position = "none")

layout <- rbind(c(1))
figure <- grid.arrange(plot1,  layout_matrix = layout)

path="../Draft/Figures20211227/"
figure_name="fig_s1f_Tyr_abundance"
width=4
height=1.75
scale=1.5
dpi=600
# ggsave(paste0(path, figure_name,".svg"), 
#        plot = figure,
#        scale = scale,
#        dpi = dpi,
#        width = width, 
#        height = height)

ggsave(paste0(path, figure_name,".png"),
       plot = figure,
       scale = scale,
       dpi = dpi,
       width = width,
       height = height)

```

###Fig s1g: His isodecoders
```{r}
temp <- Q_base %>%
  filter(project=="Q") %>%
  filter(AA=="His", source=="cytosolic",
         # chr == "chr1.trna69",
         bin_start=="60",
         sample == "Q100",
         pileup >= 100)
temp$treatment <- recode(temp$treatment, "minusI"="untreated", "plusI"="treated")

plot1 <- ggplot(filter(temp, position %in% c(34, 35), base=="G",
              # (chr=="chr1.trna69" & position==34)|(chr=="chr12.trna5" & position==34)|(chr=="chr6.trna144" & position==34),
              sample=="Q100"), 
       aes(x=paste0(AA, anticodon, "\n",chr), y=deletion/pileup, color=treatment, group= interaction(treatment, rep, sample, gene))) +
  geom_point() +
  scale_color_manual("IO4", values= c("treated"="red", "untreated"="black")) +
  ylab("Deletion rate") +
  xlab("Isodecoder") +
  theme(axis.text.x = element_text(angle=90, vjust=0.5),
        axis.title.x = element_blank(),
        legend.position = "none")


layout <- rbind(c(1))
figure <- grid.arrange(plot1,  layout_matrix = layout)

path="../Draft/Figures20211227/"
figure_name="fig_s1g_His_isodecoder"
width=2
height=1.75
scale=1.5
dpi=600
# ggsave(paste0(path, figure_name,".svg"), 
#        plot = figure,
#        scale = scale,
#        dpi = dpi,
#        width = width, 
#        height = height)

ggsave(paste0(path, figure_name,".png"),
       plot = figure,
       scale = scale,
       dpi = dpi,
       width = width,
       height = height)

```


###Fig s1h: Tyr isodecoders
```{r}
temp <- Q_base %>%
  filter(project=="Q") %>%
  filter(AA=="His", source=="cytosolic",
         # chr == "chr1.trna26",
         bin_start=="60",
         sample=="Q100",
         pileup >= 100)

#To do RPM normalization, gott know how many reads in each sample
temp1 <- Q_count %>%
  filter(project=="Q",
         bin_start %in% c("-1", "-2", "-3")) %>%
  group_by(treatment, rep, sample) %>%
  summarise(total_count = sum(count))
temp <-  temp %>%
  full_join(., temp1, by=c("treatment","rep","sample"))

temp$treatment <- recode(temp$treatment, "minusI"="untreated", "plusI"="treated")


plot1 <- ggplot(filter(temp, position %in% c(34,35), base=="G",
              # (chr=="chr1.trna69" & position==34)|(chr=="chr12.trna5" & position==34)|(chr=="chr6.trna144" & position==34),
              base=="G",
              sample=="Q100"), 
       aes(x=paste0(AA, anticodon,"\n", chr), y=pileup/total_count*1000000, color=treatment, group= interaction(treatment, rep, sample, gene))) +
  geom_point() +
  scale_color_manual("IO4", values= c("treated"="red", "untreated"="black")) +
  ylab("Abundance (RPM)") +
  scale_y_log10() +
  theme(axis.text.x = element_text(angle=90, vjust=0.5),
        axis.title.x =element_blank(),
        legend.position = "none")

layout <- rbind(c(1))
figure <- grid.arrange(plot1,  layout_matrix = layout)

path="../Draft/Figures20211227/"
figure_name="fig_s1h_His_abundance"
width=2
height=1.75
scale=1.5
dpi=600
# ggsave(paste0(path, figure_name,".svg"), 
#        plot = figure,
#        scale = scale,
#        dpi = dpi,
#        width = width, 
#        height = height)

ggsave(paste0(path, figure_name,".png"),
       plot = figure,
       scale = scale,
       dpi = dpi,
       width = width,
       height = height)

```








#_
##Figure 3 - E. coli too
###Fig 3A: His
```{r}

temp <- Ecoli_base %>%
  filter(bin_start == "60",
         amino_acid=="His",
         pileup >= 100)

plot1 <- ggplot(temp, aes(x=position, y=deletion / pileup, color=treatment, group=interaction(amino_acid, anticodon, n1,n2, treatment))) +
  geom_line() +
  geom_vline(xintercept = 34, linetype=2, alpha=0.3) +
  facet_grid(cols=vars(paste0(amino_acid, anticodon, "-",n1, "-", n2))) +
  # geom_text(aes(label=base), y=-0.01, color="black") +
  coord_cartesian(ylim = c(-0.015,0.1)) +
  theme(legend.position = c(0.75,0.7),
        legend.background = element_rect(color="black", fill="white", linetype="solid")) +
  scale_color_manual("IO4", values= c("treated"="red", "untreated"="black")) +
  ylab("Deletion rate")


layout <- rbind(c(1))
figure <- grid.arrange(plot1,  layout_matrix = layout)

path="../Draft/Figures20211227/"
figure_name="fig_3a_Ecoli_His"
width=2.25
height=1.75
scale=1.5
dpi=600
# ggsave(paste0(path, figure_name,".svg"), 
#        plot = figure,
#        scale = scale,
#        dpi = dpi,
#        width = width, 
#        height = height)

ggsave(paste0(path, figure_name,".png"),
       plot = figure,
       scale = scale,
       dpi = dpi,
       width = width,
       height = height)

```

###Fig 3B: Asp
```{r}

temp <- Ecoli_base %>%
  filter(bin_start == "60",
         amino_acid=="Asp",
         pileup >= 100)

plot1 <- ggplot(temp, aes(x=position, y=deletion / pileup, color=treatment, group=interaction(amino_acid, anticodon, n1,n2, treatment))) +
  geom_line() +
  geom_vline(xintercept = 35, linetype=2, alpha=0.3) +
  facet_grid(cols=vars(paste0(amino_acid, anticodon, "-",n1, "-", n2))) +
  # geom_text(aes(label=base), y=-0.01, color="black") +
  coord_cartesian(ylim = c(-0.015,0.05)) +
  theme(legend.position = "none",
        legend.background = element_rect(color="black", fill="white", linetype="solid")) +
  scale_color_manual("IO4", values= c("treated"="red", "untreated"="black")) +
  ylab("Deletion rate")



layout <- rbind(c(1))
figure <- grid.arrange(plot1,  layout_matrix = layout)

path="../Draft/Figures20211227/"
figure_name="fig_3b_Ecoli_Asp"
width=2.25
height=1.75
scale=1.5
dpi=600
# ggsave(paste0(path, figure_name,".svg"), 
#        plot = figure,
#        scale = scale,
#        dpi = dpi,
#        width = width, 
#        height = height)

ggsave(paste0(path, figure_name,".png"),
       plot = figure,
       scale = scale,
       dpi = dpi,
       width = width,
       height = height)

```

###Fig 3C: Asn
```{r}

temp <- Ecoli_base %>%
  filter(bin_start == "60",
         amino_acid=="Asn",
         pileup >= 100)

plot1 <- ggplot(temp, aes(x=position, y=deletion / pileup, color=treatment, group=interaction(amino_acid, anticodon, n1,n2, treatment))) +
  geom_line() +
  geom_vline(xintercept = 34, linetype=2, alpha=0.3) +
  facet_grid(cols=vars(paste0(amino_acid, anticodon, "-",n1, "-", n2))) +
  # geom_text(aes(label=base), y=-0.01, color="black") +
  coord_cartesian(ylim = c(-0.015,0.05)) +
  theme(legend.position = "none",
        legend.background = element_rect(color="black", fill="white", linetype="solid")) +
  scale_color_manual("IO4", values= c("treated"="red", "untreated"="black")) +
  ylab("Deletion rate")



layout <- rbind(c(1))
figure <- grid.arrange(plot1,  layout_matrix = layout)

path="../Draft/Figures20211227/"
figure_name="fig_3c_Ecoli_Asn"
width=2.25
height=1.75
scale=1.5
dpi=600
# ggsave(paste0(path, figure_name,".svg"), 
#        plot = figure,
#        scale = scale,
#        dpi = dpi,
#        width = width, 
#        height = height)

ggsave(paste0(path, figure_name,".png"),
       plot = figure,
       scale = scale,
       dpi = dpi,
       width = width,
       height = height)

```

###Fig 3D: Tyr
```{r}

temp <- Ecoli_base %>%
  filter(bin_start == "60",
         amino_acid=="Tyr",
         n1=="1",
         pileup >= 100)

plot1 <- ggplot(filter(temp,
                       # base=="G"
                       ), 
                aes(x=position, y=deletion / pileup, color=treatment, group=interaction(amino_acid, anticodon, n1,n2, treatment))) +
  geom_line() +
  geom_vline(xintercept = 35, linetype=2, alpha=0.3) +
  facet_grid(cols=vars(paste0(amino_acid, anticodon, "-",n1, "-", n2))) +
  # geom_text(aes(label=base), y=-0.01, color="black") +
  coord_cartesian(ylim = c(-0.015,0.05)) +
  theme(legend.position = "none", #c(0.8,0.8),
        legend.background = element_rect(color="black", fill="white", linetype="solid")) +
  scale_color_manual("IO4", values= c("treated"="red", "untreated"="black")) +
  ylab("Deletion rate")


layout <- rbind(c(1))
figure <- grid.arrange(plot1,  layout_matrix = layout)

path="../Draft/Figures20211227/"
figure_name="fig_3d_Ecoli_Tyr1"
width=2.25
height=1.75
scale=1.5
dpi=600
# ggsave(paste0(path, figure_name,".svg"), 
#        plot = figure,
#        scale = scale,
#        dpi = dpi,
#        width = width, 
#        height = height)

ggsave(paste0(path, figure_name,".png"),
       plot = figure,
       scale = scale,
       dpi = dpi,
       width = width,
       height = height)

```

###Fig 3E: Tyr2
```{r}

temp <- Ecoli_base %>%
  filter(bin_start == "60",
         amino_acid=="Tyr",
         n1=="2",
         pileup >= 100)

plot1 <- ggplot(temp, aes(x=position, y=deletion / pileup, color=treatment, group=interaction(amino_acid, anticodon, n1,n2, treatment))) +
  geom_line() +
  geom_vline(xintercept = 35, linetype=2, alpha=0.3) +
  facet_grid(cols=vars(paste0(amino_acid, anticodon, "-",n1, "-", n2))) +
  # geom_text(aes(label=base), y=-0.01, color="black") +
  coord_cartesian(ylim = c(-0.015,0.05)) +
  theme(legend.position = "none",#c(0.8,0.8),
        legend.background = element_rect(color="black", fill="white", linetype="solid")) +
  scale_color_manual("IO4", values= c("treated"="red", "untreated"="black")) +
  ylab("Deletion rate")



layout <- rbind(c(1))
figure <- grid.arrange(plot1,  layout_matrix = layout)

path="../Draft/Figures20211227/"
figure_name="fig_3e_Ecoli_Tyr2"
width=2.25
height=1.75
scale=1.5
dpi=600
# ggsave(paste0(path, figure_name,".svg"), 
#        plot = figure,
#        scale = scale,
#        dpi = dpi,
#        width = width, 
#        height = height)

ggsave(paste0(path, figure_name,".png"),
       plot = figure,
       scale = scale,
       dpi = dpi,
       width = width,
       height = height)

```



#_
##Figure 4 - other modifiations

###Human
```{r}

temp <- Q_base %>%
  filter(project=="Q") %>%
  filter(AA=="mtSer", #source!="cytosolic",
         # anticodon=="TCT",
         # chr == "chr1.trna69",
         bin_start=="60",
         sample == "Q100",
         pileup >= 100) %>%
  group_by(treatment, rep, sample, gene) %>%
  mutate(norm_pileup = pileup / max(pileup)) #%>%
  # filter(gene %in% temp_most$gene)
temp$treatment <- recode(temp$treatment, "minusI"="untreated", "plusI"="treated")


ggplot(filter(temp, 
              # chr == "chr1.trna69",
              ),
       aes(x=position, y=stop, color=treatment, group = interaction(treatment, rep, sample, gene))) +
  geom_line() +
  coord_cartesian(ylim = c(-0.015,1)) +
  geom_text(aes(label=base), y=-0.01, color="black") +
  geom_vline(xintercept = c(33), linetype=2, alpha=0.3) +
  scale_color_manual("IO4", values= c("treated"="red", "untreated"="black")) +
  # ylab("Deletion\nrate") +
  xlab("Position") +
  facet_grid(rows=vars( paste0(AA, anticodon, chr)) ) +
  theme(legend.position = c(0.8,0.7),
        legend.background = element_rect(color="black", fill="white", linetype="solid"))


temp_most <- Q_base %>%
  filter(project=="Q") %>%
  filter(bin_start=="60",
         sample=="Q100",
         treatment=="plusI",
         pileup >=500) %>%
  group_by(AA, anticodon) %>%
  filter(position > 25, position < 40) %>%
  mutate(pileup_max = max(pileup)) %>%
  filter(pileup == pileup_max) %>%
  select(AA, anticodon, chr, gene)

temp1 <- Q_base %>%
  filter(project=="Q") %>%
  filter(gene %in% temp_most$gene) %>%
  filter((AA=="mtGlu" & position==28 & base=="T") | #Deletion
           (AA=="mtGln" & position==32 & base=="T") |
           (AA=="mtLys" & position ==28 & base=="T"),
         bin_start=="60",
         sample == "Q100",
         pileup >= 100) %>%
  mutate(modification = "τm5s2U34")
temp1$treatment <- recode(temp1$treatment, "minusI"="untreated", "plusI"="treated")


temp2 <- Q_base %>%
  filter(project=="Q") %>%
  filter(gene %in% temp_most$gene) %>%
  filter((AA=="mtTrp" & position==36 & base=="A") | #Stop *Off by one because of how stop is calculated
           (AA=="mtTyr" & position==33 & base=="A") |
           (AA=="mtPhe" & position==38 & base=="A") |
           (AA=="mtSer" & position==33 & base=="A" & anticodon=="TGA"),
         bin_start=="60",
         sample == "Q100",
         pileup >= 100) %>%
  mutate(modification = "ms2i6A")
temp2$treatment <- recode(temp2$treatment, "minusI"="untreated", "plusI"="treated")

# temp3 <- Q_base %>%
#   filter(project=="Q") %>%
#   filter((AA=="mtAsn" & position==37 & base=="A") |
#            (AA=="mtThr" & position==35 & base=="A") |
#            (AA=="mtLys" & position ==28 & base=="T"),
#          bin_start=="60",
#          sample == "Q100",
#          pileup >= 100) %>%
#   mutate(modification = "t6A")
# temp3$treatment <- recode(temp3$treatment, "minusI"="untreated", "plusI"="treated")

temp3 <- Q_base %>%
  filter(project=="Q") %>%
  filter(gene %in% temp_most$gene) %>%
  filter((AA=="Arg" & position==34 & base=="T" & anticodon=="TCT") | #Mutation
           (AA=="Glu" & position==34 & base=="T" & anticodon =="TTC") |
           (AA=="Gln" & position ==34 & base=="T" & anticodon =="TTG"),
         bin_start=="60",
         sample == "Q100",
         pileup >= 100) %>%
  mutate(modification = "mcm5s2u34")
temp3$treatment <- recode(temp3$treatment, "minusI"="untreated", "plusI"="treated")

temp4 <- Q_base %>%
  filter(project=="Q") %>%
  filter(gene %in% temp_most$gene) %>%
  filter((AA=="Lys" & position==33 & base=="T" & anticodon=="TTT"),
         bin_start=="60",
         sample == "Q100",
         pileup >= 100) %>%
  mutate(modification = "mnm5s2U34")
temp4$treatment <- recode(temp4$treatment, "minusI"="untreated", "plusI"="treated")





plot1 <- ggplot(temp1, 
       aes(x=paste0(AA, anticodon), y=deletion/pileup, color=treatment)) +
  facet_grid(cols=vars(modification)) +
  geom_point() +
  ylab("Deletion rate") +
  theme(legend.position = "none",#c(0.8,0.7),
        legend.background = element_rect(color="black", fill="white", linetype="solid")) +
  scale_color_manual("IO4", values= c("treated"="red", "untreated"="black")) +
  theme(axis.title.x = element_blank(),
        axis.text.x = element_text(angle=90, vjust=0.5))


plot2 <- ggplot(temp2, 
       aes(x=paste0(AA, anticodon), y=stop, color=treatment)) +
  facet_grid(cols=vars(modification)) +
  geom_point() +
  ylab("Stop rate") +
  theme(legend.position = "none",#c(0.8,0.7),
        legend.background = element_rect(color="black", fill="white", linetype="solid")) +
  scale_color_manual("IO4", values= c("treated"="red", "untreated"="black")) +
  theme(axis.title.x = element_blank(),
        axis.text.x = element_text(angle=90, vjust=0.5))

plot3 <- ggplot(temp3, 
       aes(x=paste0(AA, anticodon), y=mutation, color=treatment)) +
  facet_grid(cols=vars(modification)) +
  geom_point() +
  ylab("Mutation rate") +
  theme(legend.position = "none",#c(0.8,0.7),
        legend.background = element_rect(color="black", fill="white", linetype="solid")) +
  scale_color_manual("IO4", values= c("treated"="red", "untreated"="black")) +
  theme(axis.title.x = element_blank(),
        axis.text.x = element_text(angle=90, vjust=0.5))

plot4 <- ggplot(temp4, 
       aes(x=paste0(AA, anticodon), y=deletion/pileup, color=treatment)) +
  facet_grid(cols=vars(modification)) +
  geom_point() +
  ylab("Deletion rate") +
  theme(legend.position = "none",#c(0.8,0.7),
        legend.background = element_rect(color="black", fill="white", linetype="solid")) +
  scale_color_manual("IO4", values= c("treated"="red", "untreated"="black")) +
  theme(axis.title.x = element_blank(),
        axis.text.x = element_text(angle=90, vjust=0.5))


figure_legend <- get_legend(plot1+theme(legend.position = "right",
                                       legend.background = element_rect(color="black", fill="white", linetype="solid")) )

layout <- rbind(c(1,1,2,2,3,3,4,4,4,5,5))
figure <- grid.arrange(plot1, plot4, plot3, plot2, figure_legend,  layout_matrix = layout)

path="../Draft/Figures20211227/"
figure_name="fig_4a_human_others"
width=6
height=2
scale=1.5
dpi=600
# ggsave(paste0(path, figure_name,".svg"), 
#        plot = figure,
#        scale = scale,
#        dpi = dpi,
#        width = width, 
#        height = height)

ggsave(paste0(path, figure_name,".png"),
       plot = figure,
       scale = scale,
       dpi = dpi,
       width = width,
       height = height)


```


###E. coli
```{r}
#E.coli
#V34 Ecoli
temp <- Ecoli_base %>%
  filter(bin_start == "60",
         # anticodon=="TGA",
         amino_acid=="Phe",
         pileup >= 100)

ggplot(temp, aes(x=position, y=stop , color=treatment, group=interaction(amino_acid, anticodon, n1,n2, treatment))) +
  geom_line() +
  geom_vline(xintercept = 37, linetype=2, alpha=0.3) +
  facet_grid(cols=vars(paste0(amino_acid, anticodon, "-",n1, "-", n2))) +
  geom_text(aes(label=base), y=-0.01, color="black") +
  coord_cartesian(ylim = c(-0.015,0.9),
                  xlim=c(25, 40)) +
  theme(legend.position = c(0.1,0.7),
        legend.background = element_rect(color="black", fill="white", linetype="solid")) +
  scale_color_manual("IO4", values= c("treated"="red", "untreated"="black"))
  # ylab("Deletion\nrate")
# 



temp1 <- Ecoli_base %>%
  filter(bin_start == "60",
         (anticodon=="TTG" & position ==33 & base=="T"), #both
         pileup >= 100) %>%
  mutate(modification = "cmnm5s2U34")

temp2 <- Ecoli_base %>%
  filter(bin_start == "60",
         (anticodon=="TTC" & position ==35 & base=="T") | #both
           (anticodon=="TTT" & position ==33 & base=="T"), #deletion
         pileup >= 100) %>%
  mutate(modification = "mnm5s2U34")

temp3 <- Ecoli_base %>%
  filter(bin_start == "60",
         (anticodon=="GCT" & position ==33 & base=="C") |
           (anticodon=="ACG" & position ==33 & base=="C") |
           (anticodon=="CCG" & position ==33 & base=="C") |
           (anticodon=="CCT" & position ==32 & base=="C") |
           (anticodon=="TCT" & position ==33 & base=="C"), #mutation
         pileup >= 100) %>%
  mutate(modification = "s2C32")

temp4 <- Ecoli_base %>%
  filter(bin_start == "60",
         (anticodon=="GCA" & position ==36 & base=="A") |
           (anticodon=="GAA" & position ==37 & base=="A") |
           (anticodon=="CAA" & position ==38 & base=="A") |
           (anticodon=="TAA" & position ==38 & base=="A") |
           (anticodon=="CGA" & position ==38 & base=="A") |
           (anticodon=="TGA" & position ==38 & base=="A") |
           (anticodon=="CCA" & position ==37 & base=="A") |
           (anticodon=="GTA" & position ==38 & base=="A"), #mutation
         pileup >= 100) %>%
  mutate(modification = "ms2i6A")






plot1 <- ggplot(temp1, 
       aes(x=paste0(amino_acid, anticodon,"-", n1,"-", n2), y=mutation, color=treatment)) +
  facet_grid(cols=vars(modification)) +
  geom_point() +
  ylab("Mutation rate") +
  theme(legend.position = "none",#c(0.8,0.7),
        legend.background = element_rect(color="black", fill="white", linetype="solid")) +
  scale_color_manual("IO4", values= c("treated"="red", "untreated"="black")) +
  theme(axis.title.x = element_blank(),
        axis.text.x = element_text(angle=90, vjust=0.5))

plot2 <- ggplot(temp2, 
       aes(x=paste0(amino_acid, anticodon,"-", n1,"-", n2), y=deletion/pileup, color=treatment)) +
  facet_grid(cols=vars(modification)) +
  geom_point() +
  ylab("Deletion rate") +
  theme(legend.position = "none",#c(0.8,0.7),
        legend.background = element_rect(color="black", fill="white", linetype="solid")) +
  scale_color_manual("IO4", values= c("treated"="red", "untreated"="black")) +
  theme(axis.title.x = element_blank(),
        axis.text.x = element_text(angle=90, vjust=0.5))

plot3 <- ggplot(temp3, 
       aes(x=paste0(amino_acid, anticodon,"-", n1,"-", n2), y=mutation, color=treatment)) +
  facet_grid(cols=vars(modification)) +
  geom_point() +
  ylab("Mutation rate") +
  theme(legend.position = "none",#c(0.8,0.7),
        legend.background = element_rect(color="black", fill="white", linetype="solid")) +
  scale_color_manual("IO4", values= c("treated"="red", "untreated"="black")) +
  theme(axis.title.x = element_blank(),
        axis.text.x = element_text(angle=90, vjust=0.5))

plot4 <- ggplot(temp4, 
       aes(x=paste0(amino_acid, anticodon,"-", n1,"-", n2), y=stop, color=treatment)) +
  facet_grid(cols=vars(modification)) +
  geom_point() +
  ylab("Stop rate") +
  theme(legend.position = "none",#c(0.8,0.7),
        legend.background = element_rect(color="black", fill="white", linetype="solid")) +
  scale_color_manual("IO4", values= c("treated"="red", "untreated"="black")) +
  theme(axis.title.x = element_blank(),
        axis.text.x = element_text(angle=90, vjust=0.5))

figure_legend <- get_legend(plot1+theme(legend.position = "right",
                                       legend.background = element_rect(color="black", fill="white", linetype="solid")) )

layout <- rbind(c(1,1,2,2,3,3,4,4,4,5,5))
figure <- grid.arrange(plot1, plot2, plot3, plot4, figure_legend,  layout_matrix = layout)

path="../Draft/Figures20211227/"
figure_name="fig_4b_Ecoli_others"
width=6
height=2
scale=1.5
dpi=600
# ggsave(paste0(path, figure_name,".svg"), 
#        plot = figure,
#        scale = scale,
#        dpi = dpi,
#        width = width, 
#        height = height)

ggsave(paste0(path, figure_name,".png"),
       plot = figure,
       scale = scale,
       dpi = dpi,
       width = width,
       height = height)


```

#_
##Supp Fig 2: heat maps
###Human
####Deletion
```{r}
temp <- Q_base %>%
  filter(project=="Q") %>%
  filter(bin_start=="60",
         sample=="Q100",
         pileup >=500) %>%
  group_by(AA, anticodon) %>%
  filter(position > 25, position < 40) %>%
  mutate(pileup_max = max(pileup)) %>%
  filter(pileup == pileup_max) %>%
  select(AA, anticodon, chr, gene)
  


temp <- Q_base %>%
  filter(gene %in% temp$gene) %>% #take the most abundant for each anticodon
  filter(project=="Q") %>%
  filter(#source=="cytosolic",
         #chr == "chr1.trna111",
         bin_start=="60",
         sample=="Q100",
         pileup >=500) %>%
  group_by(AA, anticodon, chr, gene, treatment, sample, position, source, base) %>%
  summarise(mean_deletion = mean(deletion / pileup)) %>%
  pivot_wider(names_from = c("treatment"), values_from = c("mean_deletion"))


plot1 <- ggplot(filter(temp),
       aes(x=paste0(AA, anticodon, chr), y=position, fill=plusI - minusI)) +
  geom_tile(data=filter(temp, plusI - minusI >  0.05), fill="red4") +
  geom_tile(data=filter(temp, plusI - minusI < -0.05), fill="blue4") +
  geom_tile(data=temp) +
  scale_fill_gradient2(low="blue", mid="grey70", midpoint=0, high="red", na.value="transparent", 
                       limits=c(-0.05,0.05),
                       breaks=c(-0.05, 0, 0.05)) +
  theme(axis.text.x = element_text(angle=90, hjust=1, vjust=0.5),
        legend.position = "right",
        axis.title.x = element_blank()) +
  scale_y_continuous(breaks=c(10,22,26,34,37,58)) +
  labs(fill = "Difference\n(treated - untreated)") +
  ggtitle("Deletion rate")

# ggplot(filter(temp, AA=="mtLys"),
#        aes(x=position, y=minusI)) +
#   geom_line() +
#   facet_grid(rows=vars(gene)) +
#   geom_text(y=-0.0, aes(label=base))

```


####Stop
####Deletion
```{r}
temp <- Q_base %>%
  filter(project=="Q") %>%
  filter(bin_start=="60",
         sample=="Q100",
         pileup >=500) %>%
  group_by(AA, anticodon) %>%
  filter(position > 25, position < 40) %>%
  mutate(pileup_max = max(pileup)) %>%
  filter(pileup == pileup_max) %>%
  select(AA, anticodon, chr, gene)
  


temp <- Q_base %>%
  filter(gene %in% temp$gene) %>% #take the most abundant for each anticodon
  filter(project=="Q") %>%
  filter(source=="cytosolic",
         #chr == "chr1.trna111",
         bin_start=="60",
         sample=="Q100",
         pileup >=500) %>%
  group_by(AA, anticodon, chr, gene, treatment, sample, position, source, base) %>%
  summarise(mean_stop = mean(stop)) %>%
  pivot_wider(names_from = c("treatment"), values_from = c("mean_stop"))


ggplot(filter(temp),
       aes(x=paste0(AA, anticodon, chr), y=position, fill=plusI - minusI)) +
  geom_tile(data=filter(temp, plusI - minusI >  0.05), fill="red4") +
  geom_tile(data=filter(temp, plusI - minusI < -0.05), fill="blue4") +
  geom_tile(data=temp) +
  scale_fill_gradient2(low="blue", mid="grey70", midpoint=0, high="red", na.value="transparent", 
                       limits=c(-0.05,0.05),
                       breaks=c(-0.05, 0, 0.05)) +
  theme(axis.text.x = element_text(angle=90, hjust=1, vjust=0.5),
        legend.position = "bottom") +
  scale_y_continuous(breaks=c(10,22,26,34,37,58)) +
  ggtitle("Deletion rate")

# ggplot(filter(temp, AA=="mtLys"),
#        aes(x=position, y=minusI)) +
#   geom_line() +
#   facet_grid(rows=vars(gene)) +
#   geom_text(y=-0.0, aes(label=base))

```

####Mutation
```{r}
temp <- Q_base %>%
  filter(project=="Q") %>%
  filter(bin_start=="60",
         sample=="Q100",
         pileup >=500) %>%
  group_by(AA, anticodon) %>%
  filter(position > 25, position < 40) %>%
  mutate(pileup_max = max(pileup)) %>%
  filter(pileup == pileup_max) %>%
  select(AA, anticodon, chr, gene)
  


temp <- Q_base %>%
  filter(gene %in% temp$gene) %>% #take the most abundant for each anticodon
  filter(project=="Q") %>%
  filter(#source=="cytosolic",
         #chr == "chr1.trna111",
         bin_start=="60",
         sample=="Q0",
         pileup >=500) %>%
  group_by(AA, anticodon, chr, gene, treatment, sample, position, source) %>%
  summarise(mean_mutation = mean(mutation)) %>%
  pivot_wider(names_from = c("treatment"), values_from = c("mean_mutation"))


plot2 <- ggplot(filter(temp),
       aes(x=paste0(AA, anticodon, chr), y=position, fill=plusI - minusI)) +
  geom_tile(data=filter(temp, plusI - minusI >  0.1), fill="red4") +
  geom_tile(data=filter(temp, plusI - minusI < -0.1), fill="blue4") +
  geom_tile() +
  scale_fill_gradient2(low="blue", mid="grey70", midpoint=0, high="red", na.value="transparent", 
                       limits=c(-0.1,0.1),
                       breaks=c(-0.1, 0, 0.1)) +
  theme(axis.text.x = element_text(angle=90, hjust=1, vjust=0.5),
        axis.title.x = element_blank(),
        legend.position = "right") +
  labs(fill = "Difference\n(treated - untreated)") +
  ggtitle("Mutation rate")

```

####Figure
```{r}
layout <- rbind(c(1),c(2))
figure <- grid.arrange(plot1, plot2,  layout_matrix = layout)

path="../Draft/Figures20211227/"
figure_name="fig_S2a_human_others"
width=8
height=7
scale=1.5
dpi=600
# ggsave(paste0(path, figure_name,".svg"), 
#        plot = figure,
#        scale = scale,
#        dpi = dpi,
#        width = width, 
#        height = height)

ggsave(paste0(path, figure_name,".png"),
       plot = figure,
       scale = scale,
       dpi = dpi,
       width = width,
       height = height)

```

####Spot checks

#####Human list
```{r}
temp <- Q_base %>%
  filter(project=="Q") %>%
  filter(AA=="mtHis", #source=="cytosolic",
         # chr == "chr14.trna16",
         bin_start=="-2",
         sample=="Q100",
         pileup >= 500)

temp$treatment <- recode(temp$treatment, "minusI"="untreated", "plusI"="treated")

ggplot(filter(temp, 
              ),
       aes(x=position, y=deletion/pileup, color=treatment, group = interaction(treatment, rep, sample, gene))) +
  geom_line() +
  coord_cartesian(ylim = c(-0.015,0.15)) +
  # geom_text(aes(label=base), y=-0.01, color="black") +
  geom_vline(xintercept = c(31), linetype=2, alpha=0.3) +
  scale_color_manual("IO4", values= c("treated"="red", "untreated"="black")) +
  ylab("Deletion\nrate") +
  xlab("Position") +
  facet_grid(cols=vars( paste0(AA, anticodon, chr)) ) +
  theme(#legend.position = c(0.8,0.7),
        legend.position = "none",
        legend.background = element_rect(color="black", fill="white", linetype="solid"))

```






#####Ecoli list
```{r}
#Deeltion
#Ala dihydroU ~18?
#Arg at 26???
#Arg TCT, m3C
#Gln34 unknown
#GlyTCT5, 
#GlyTCC ~5, m2G?
#Leu M22G 26?
#Lys TTT 34 tm5s2U
#Lys TTT 37 t6A
#Mete m3C ~26?
#mtLys tauring 34


#Mutation
#m1A58s
#m22Gs

temp <- Q_base %>%
  filter(project=="Q") %>%
  filter(bin_start=="60",
         sample=="Q100",
         pileup >=500) %>%
  group_by(AA, anticodon) %>%
  filter(position > 25, position < 40) %>%
  mutate(pileup_max = max(pileup)) %>%
  filter(pileup == pileup_max) %>%
  select(AA, anticodon, chr, gene)
  
temp <- Q_base %>%
  filter(gene %in% temp$gene) %>% #take the most abundant for each anticodon
  filter(project=="Q") %>%
  filter(#AA=="Asp", source=="cytosolic",
         # chr == "chr1.trna69",
         bin_start=="60",
         sample == "Q100",
         pileup >= 100)
temp$treatment <- recode(temp$treatment, "minusI"="untreated", "plusI"="treated")


ggplot(filter(temp, 
              AA=="Ala"
              ),
       aes(x=position, 
           y=mutation,#deletion/pileup, 
           color=treatment, group = interaction(treatment, rep, sample, gene))) +
  geom_line() +
  # coord_cartesian(ylim = c(-0.015,0.1)) +
  # geom_text(aes(label=base), y=-0.01, color="black") +
  geom_vline(xintercept = c(34), linetype=2, alpha=0.3) +
  scale_color_manual("IO4", values= c("treated"="red", "untreated"="black")) +
  ylab("Deletion\nrate") +
  xlab("Position") +
  facet_grid(cols=vars( paste0(AA, anticodon, chr)) ) +
  theme(legend.position = c(0.8,0.7),
        legend.background = element_rect(color="black", fill="white", linetype="solid"))

```


###Ecoli
####Deletion
```{r}
temp <- Ecoli_base %>%
  filter(bin_start == "60",
         pileup >=50) %>%
  group_by(position, bin_start, treatment, amino_acid, anticodon, n1, n2) %>%
  mutate(deletion_rate = deletion / pileup) %>%
  select(position, bin_start, treatment, deletion_rate, amino_acid, anticodon, n1, n2, base) %>%
  pivot_wider(names_from = c("treatment"), values_from = c("deletion_rate"))


plot1 <- ggplot(data=filter(temp),
       aes(x=paste0(amino_acid, anticodon, "-", n1), y=position, fill=treated - untreated)) +
  geom_tile(data=filter(temp, treated - untreated >  0.03), fill="red4") +
  geom_tile(data=filter(temp, treated - untreated < -0.03), fill="blue4") +
  geom_tile() +
  scale_fill_gradient2(low="blue", mid="grey70", midpoint=0, high="red", na.value="transparent", 
                       limits=c(-0.03,0.03),
                       breaks=c(-0.03, 0, 0.03)) +
  theme(axis.text.x = element_text(angle=90, hjust=1, vjust=0.5),
        legend.position = "right",
        axis.title.x = element_blank()) +
  scale_y_continuous(breaks=c(10,22,26,34,37,58)) +
  labs(fill = "Difference\n(treated - untreated)") +
  ggtitle("Deletion rate")


```

####Stop
```{r}
temp <- Ecoli_base %>%
  filter(bin_start == "60",
         pileup >=50) %>%
  group_by(position, bin_start, treatment, amino_acid, anticodon, n1, n2) %>%
  # mutate(deletion_rate = deletion / pileup) %>%
  select(position, bin_start, treatment, stop, amino_acid, anticodon, n1, n2, base) %>%
  pivot_wider(names_from = c("treatment"), values_from = c("stop"))


ggplot(data=filter(temp),
       aes(x=paste0(amino_acid, anticodon, "-", n1), y=position, fill=treated - untreated)) +
  geom_tile(data=filter(temp, treated - untreated >  0.1), fill="red4") +
  geom_tile(data=filter(temp, treated - untreated < -0.1), fill="blue4") +
  geom_tile() +
  scale_y_continuous(breaks=c(10,20,30,40,50,60)) +
  scale_fill_gradient2(low="blue", mid="grey70", midpoint=0, high="red", na.value="transparent", 
                       limits=c(-0.1,0.1),
                       breaks=c(-0.1, 0, 0.1)) +
  theme(axis.text.x = element_text(angle=90, hjust=1, vjust=0.5),
        legend.position = "bottom") +
  ggtitle("Deletion rate")


```


####Mutation
```{r}
temp <- Ecoli_base %>%
  filter(bin_start == "60",
         pileup >=50) %>%
  group_by(position, bin_start, treatment, amino_acid, anticodon, n1, n2) %>%
  # mutate(deletion_rate = deletion / pileup) %>%
  select(position, bin_start, treatment, mutation, amino_acid, anticodon, n1, n2, base) %>%
  pivot_wider(names_from = c("treatment"), values_from = c("mutation"))


plot2 <- ggplot(data=filter(temp),
       aes(x=paste0(amino_acid, anticodon, "-", n1), y=position, fill=treated - untreated)) +
  geom_tile(data=filter(temp, treated - untreated >  0.1), fill="red4") +
  geom_tile(data=filter(temp, treated - untreated < -0.1), fill="blue4") +
  geom_tile() +
  scale_fill_gradient2(low="blue", mid="grey70", midpoint=0, high="red", na.value="transparent", 
                       limits=c(-0.11,0.11),
                       breaks=c(-0.1, -0.05, 0, 0.05, 0.1)
                       ) +
  theme(axis.text.x = element_text(angle=90, hjust=1, vjust=0.5),
        axis.title.x = element_blank(),
        legend.position = "right") +
  labs(fill = "Difference\n(treated - untreated)") +
  ggtitle("Mutation rate")
  
```

####Figure
```{r}
layout <- rbind(c(1),c(2))
figure <- grid.arrange(plot1, plot2,  layout_matrix = layout)

path="../Draft/Figures20211227/"
figure_name="fig_S2b_ecoli_others"
width=6
height=7
scale=1.5
dpi=600
# ggsave(paste0(path, figure_name,".svg"), 
#        plot = figure,
#        scale = scale,
#        dpi = dpi,
#        width = width, 
#        height = height)

ggsave(paste0(path, figure_name,".png"),
       plot = figure,
       scale = scale,
       dpi = dpi,
       width = width,
       height = height)

```

####Spot checks:

##### Ecoli list
```{r}
#Deletions
#Ala TCG cmo5U ~34
# GlnCTT cmnm5s2U, ~30s
#Ile acp3U or m7G ~50
#Leu TAG cmo5U ~34
#LysTTT mnm5s2U ~34
#Pro CGG m1G37
#Val GAT, TAC, acp3U ~45

#Mutations
#SerTGA 2'OmeC, cmo5U, ms2i6A
#SerGCT s2C
#Arg, S2C, mnm5U


#S2C32
temp <- Ecoli_base %>%
  filter(bin_start == "60",
         pileup >= 100)

ggplot(filter(temp,
              amino_acid=="Arg"), 
       aes(x=position, y=deletion / pileup, color=treatment, group=interaction(amino_acid, anticodon, n1,n2, treatment))) +
  geom_line() +
  geom_vline(xintercept = 32, linetype=2, alpha=0.3) +
  facet_grid(cols=vars(paste0(amino_acid, anticodon, "-",n1, "-", n2))) +
  # geom_text(aes(label=base), y=-0.01, color="black") +
  coord_cartesian(ylim = c(-0.015,0.1)) +
  theme(legend.position = "none",#c(0.8,0.7),
        legend.background = element_rect(color="black", fill="white", linetype="solid")) +
  scale_color_manual("IO4", values= c("treated"="red", "untreated"="black")) +
  ylab("Deletion\nrate")

ggplot(filter(temp,
              amino_acid=="Arg"), 
       aes(x=position, y=mutation, color=treatment, group=interaction(amino_acid, anticodon, n1,n2, treatment))) +
  geom_line() +
  geom_vline(xintercept = 32, linetype=2, alpha=0.3) +
  facet_grid(cols=vars(paste0(amino_acid, anticodon, "-",n1, "-", n2))) +
  # geom_text(aes(label=base), y=-0.01, color="black") +
  # coord_cartesian(ylim = c(-0.015,0.1)) +
  theme(legend.position = "none",#c(0.8,0.7),
        legend.background = element_rect(color="black", fill="white", linetype="solid")) +
  scale_color_manual("IO4", values= c("treated"="red", "untreated"="black")) +
  ylab("Mutation\nrate")

#SerGCT S2C32
ggplot(filter(temp,
              anticodon=="GCT"), 
       aes(x=position, y=deletion / pileup, color=treatment, group=interaction(amino_acid, anticodon, n1,n2, treatment))) +
  geom_line() +
  geom_vline(xintercept = 32, linetype=2, alpha=0.3) +
  facet_grid(cols=vars(paste0(amino_acid, anticodon, "-",n1, "-", n2))) +
  # geom_text(aes(label=base), y=-0.01, color="black") +
  coord_cartesian(ylim = c(-0.015,0.1)) +
  theme(legend.position = "none",#c(0.8,0.7),
        legend.background = element_rect(color="black", fill="white", linetype="solid")) +
  scale_color_manual("IO4", values= c("treated"="red", "untreated"="black")) +
  ylab("Deletion\nrate")

ggplot(filter(temp,
              anticodon=="GCT"), 
       aes(x=position, y=mutation, color=treatment, group=interaction(amino_acid, anticodon, n1,n2, treatment))) +
  geom_line() +
  geom_vline(xintercept = 32, linetype=2, alpha=0.3) +
  facet_grid(cols=vars(paste0(amino_acid, anticodon, "-",n1, "-", n2))) +
  # geom_text(aes(label=base), y=-0.01, color="black") +
  # coord_cartesian(ylim = c(-0.015,0.1)) +
  theme(legend.position = "none",#c(0.8,0.7),
        legend.background = element_rect(color="black", fill="white", linetype="solid")) +
  scale_color_manual("IO4", values= c("treated"="red", "untreated"="black")) +
  ylab("Mutation\nrate")


#Gln 32?
ggplot(filter(temp,
              anticodon=="TTG"), 
       aes(x=position, y=deletion / pileup, color=treatment, group=interaction(amino_acid, anticodon, n1,n2, treatment))) +
  geom_line() +
  geom_vline(xintercept = c(30,33), linetype=2, alpha=0.3) +
  facet_grid(cols=vars(paste0(amino_acid, anticodon, "-",n1, "-", n2))) +
  # geom_text(aes(label=base), y=-0.01, color="black") +
  # coord_cartesian(ylim = c(-0.015,0.1)) +
  theme(legend.position = "none",#c(0.8,0.7),
        legend.background = element_rect(color="black", fill="white", linetype="solid")) +
  scale_color_manual("IO4", values= c("treated"="red", "untreated"="black")) +
  ylab("Deletion\nrate")

ggplot(filter(temp,
              anticodon=="TTG"), 
       aes(x=position, y=mutation, color=treatment, group=interaction(amino_acid, anticodon, n1,n2, treatment))) +
  geom_line() +
  geom_vline(xintercept = c(30,33), linetype=2, alpha=0.3) +
  facet_grid(cols=vars(paste0(amino_acid, anticodon, "-",n1, "-", n2))) +
  # geom_text(aes(label=base), y=-0.01, color="black") +
  # coord_cartesian(ylim = c(-0.015,0.1)) +
  theme(legend.position = "none",#c(0.8,0.7),
        legend.background = element_rect(color="black", fill="white", linetype="solid")) +
  scale_color_manual("IO4", values= c("treated"="red", "untreated"="black")) +
  ylab("Mutation\nrate")






#Gln  ZOOM32?
ggplot(filter(temp,
              anticodon=="TTG"), 
       aes(x=position, y=deletion / pileup, color=treatment, group=interaction(amino_acid, anticodon, n1,n2, treatment))) +
  geom_line() +
  geom_vline(xintercept = c(30,33), linetype=2, alpha=0.3) +
  facet_grid(cols=vars(paste0(amino_acid, anticodon, "-",n1, "-", n2))) +
  geom_text(aes(label=base), y=-0.01, color="black") +
  coord_cartesian(xlim = c(25,40), 
                  # ylim(-0.015, 0.1)
                  ) +
  theme(legend.position = "none",#c(0.8,0.7),
        legend.background = element_rect(color="black", fill="white", linetype="solid")) +
  scale_color_manual("IO4", values= c("treated"="red", "untreated"="black")) +
  ylab("Deletion\nrate")

ggplot(filter(temp,
              anticodon=="TTG"), 
       aes(x=position, y=mutation, color=treatment, group=interaction(amino_acid, anticodon, n1,n2, treatment))) +
  geom_line() +
  geom_vline(xintercept = c(30,33), linetype=2, alpha=0.3) +
  facet_grid(cols=vars(paste0(amino_acid, anticodon, "-",n1, "-", n2))) +
  geom_text(aes(label=base), y=-0.01, color="black") +
  coord_cartesian(xlim = c(25,40), 
                  # ylim(-0.015, 0.1)
                  ) +
  theme(legend.position = "none",#c(0.8,0.7),
        legend.background = element_rect(color="black", fill="white", linetype="solid")) +
  scale_color_manual("IO4", values= c("treated"="red", "untreated"="black")) +
  ylab("Mutation\nrate")








#Glu 32?
ggplot(filter(temp,
              anticodon=="TTC"), 
       aes(x=position, y=deletion / pileup, color=treatment, group=interaction(amino_acid, anticodon, n1,n2, treatment))) +
  geom_line() +
  geom_vline(xintercept = c(30,34), linetype=2, alpha=0.3) +
  facet_grid(cols=vars(paste0(amino_acid, anticodon, "-",n1, "-", n2))) +
  # geom_text(aes(label=base), y=-0.01, color="black") +
  # coord_cartesian(ylim = c(-0.015,0.1)) +
  theme(legend.position = "none",#c(0.8,0.7),
        legend.background = element_rect(color="black", fill="white", linetype="solid")) +
  scale_color_manual("IO4", values= c("treated"="red", "untreated"="black")) +
  ylab("Deletion\nrate")

ggplot(filter(temp,
              anticodon=="TTC"), 
       aes(x=position, y=mutation, color=treatment, group=interaction(amino_acid, anticodon, n1,n2, treatment))) +
  geom_line() +
  geom_vline(xintercept = c(30,34), linetype=2, alpha=0.3) +
  facet_grid(cols=vars(paste0(amino_acid, anticodon, "-",n1, "-", n2))) +
  # geom_text(aes(label=base), y=-0.01, color="black") +
  # coord_cartesian(ylim = c(-0.015,0.1)) +
  theme(legend.position = "none",#c(0.8,0.7),
        legend.background = element_rect(color="black", fill="white", linetype="solid")) +
  scale_color_manual("IO4", values= c("treated"="red", "untreated"="black")) +
  ylab("Mutation\nrate")




#Glu zoom 32
ggplot(filter(temp,
              anticodon=="TTC"), 
       aes(x=position, y=deletion / pileup, color=treatment, group=interaction(amino_acid, anticodon, n1,n2, treatment))) +
  geom_line() +
  geom_vline(xintercept = c(30,34), linetype=2, alpha=0.3) +
  facet_grid(cols=vars(paste0(amino_acid, anticodon, "-",n1, "-", n2))) +
  geom_text(aes(label=base), y=-0.01, color="black") +
  coord_cartesian(xlim = c(25,40), 
                  ylim = c(-0.015, 0.1)
                  ) +
  theme(legend.position = "none",#c(0.8,0.7),
        legend.background = element_rect(color="black", fill="white", linetype="solid")) +
  scale_color_manual("IO4", values= c("treated"="red", "untreated"="black")) +
  ylab("Deletion\nrate")

ggplot(filter(temp,
              anticodon=="TTC"), 
       aes(x=position, y=mutation, color=treatment, group=interaction(amino_acid, anticodon, n1,n2, treatment))) +
  geom_line() +
  geom_vline(xintercept = c(30,34), linetype=2, alpha=0.3) +
  facet_grid(cols=vars(paste0(amino_acid, anticodon, "-",n1, "-", n2))) +
  geom_text(aes(label=base), y=-0.01, color="black") +
  coord_cartesian(xlim = c(25,40), 
                  ylim = c(-0.015, 0.1)
                  ) +
  theme(legend.position = "none",#c(0.8,0.7),
        legend.background = element_rect(color="black", fill="white", linetype="solid")) +
  scale_color_manual("IO4", values= c("treated"="red", "untreated"="black")) +
  ylab("Mutation\nrate")





#LysTTT 32?
ggplot(filter(temp,
              anticodon=="TTT"), 
       aes(x=position, y=deletion / pileup, color=treatment, group=interaction(amino_acid, anticodon, n1,n2, treatment))) +
  geom_line() +
  geom_vline(xintercept = c(30,34), linetype=2, alpha=0.3) +
  facet_grid(cols=vars(paste0(amino_acid, anticodon, "-",n1, "-", n2))) +
  # geom_text(aes(label=base), y=-0.01, color="black") +
  # coord_cartesian(ylim = c(-0.015,0.1)) +
  theme(legend.position = "none",#c(0.8,0.7),
        legend.background = element_rect(color="black", fill="white", linetype="solid")) +
  scale_color_manual("IO4", values= c("treated"="red", "untreated"="black")) +
  ylab("Deletion\nrate")

ggplot(filter(temp,
              anticodon=="TTT"), 
       aes(x=position, y=mutation, color=treatment, group=interaction(amino_acid, anticodon, n1,n2, treatment))) +
  geom_line() +
  geom_vline(xintercept = c(30,34), linetype=2, alpha=0.3) +
  facet_grid(cols=vars(paste0(amino_acid, anticodon, "-",n1, "-", n2))) +
  # geom_text(aes(label=base), y=-0.01, color="black") +
  # coord_cartesian(ylim = c(-0.015,0.1)) +
  theme(legend.position = "none",#c(0.8,0.7),
        legend.background = element_rect(color="black", fill="white", linetype="solid")) +
  scale_color_manual("IO4", values= c("treated"="red", "untreated"="black")) +
  ylab("Mutation\nrate")




#LysTTT 32?
ggplot(filter(temp,
              anticodon=="TTT"), 
       aes(x=position, y=deletion / pileup, color=treatment, group=interaction(amino_acid, anticodon, n1,n2, treatment))) +
  geom_line() +
  geom_vline(xintercept = c(30,34), linetype=2, alpha=0.3) +
  facet_grid(cols=vars(paste0(amino_acid, anticodon, "-",n1, "-", n2))) +
  geom_text(aes(label=base), y=-0.01, color="black") +
  coord_cartesian(xlim = c(25,40), 
                  ylim = c(-0.015, 0.1)
                  ) +
  theme(legend.position = "none",#c(0.8,0.7),
        legend.background = element_rect(color="black", fill="white", linetype="solid")) +
  scale_color_manual("IO4", values= c("treated"="red", "untreated"="black")) +
  ylab("Deletion\nrate")

ggplot(filter(temp,
              anticodon=="TTT"), 
       aes(x=position, y=mutation, color=treatment, group=interaction(amino_acid, anticodon, n1,n2, treatment))) +
  geom_line() +
  geom_vline(xintercept = c(30,34), linetype=2, alpha=0.3) +
  facet_grid(cols=vars(paste0(amino_acid, anticodon, "-",n1, "-", n2))) +
  geom_text(aes(label=base), y=-0.01, color="black") +
  coord_cartesian(xlim = c(25,40), 
                  ylim = c(-0.015, 0.1)
                  ) +
  theme(legend.position = "none",#c(0.8,0.7),
        legend.background = element_rect(color="black", fill="white", linetype="solid")) +
  scale_color_manual("IO4", values= c("treated"="red", "untreated"="black")) +
  ylab("Mutation\nrate")

```




#_
##Figure S3: BH4 and tris

###Effects on Q
```{r}
temp <- tris_base %>%
  filter(project=="Q2") %>%
  filter(#AA %in% c("mtHis", "mtAsp", "mtAsn", "mtTyr"), #source=="cytosolic",
         (AA=="mtHis" & position==31) | (AA=="mtAsp" & position==31) |
           (AA=="mtAsn" & position==34) | (AA=="mtTyr" & position==30) |
           (AA=="His" & chr=="chr1.trna111" & position==34) | (AA=="Asp" & chr=="chr1.trna69" & position==34) |
           (AA=="Asn" & chr=="chr1.trna26"& position==35) | (AA=="Tyr" & chr=="chr14.trna16" & position==34),
         # chr == "chr1.trna111",
         bin_start=="60",
         # treatment=="plusI",
         pileup >=50)

temp$sample <- recode(temp$sample, "Q0"="0Q", "Q100"="100Q")


ggplot(temp,
       aes(x=paste0(AA, anticodon), y=deletion / pileup, color=treatment)) +
  geom_point() +
  # scale_y_log10() +
  ylab("Deletion rate")+
  labs(color="Treatment") +
  theme(axis.text.x = element_text(angle=90, vjust=0.5),
        axis.title.x = element_blank()) 

```

###Dihydrouridine
```{r}
temp <- tris_base %>%
  filter(project=="Q2") %>%
  filter(bin_start=="60",
         sample=="Q100",
         pileup >=500) %>%
  group_by(AA, anticodon) %>%
  filter(position > 25, position < 40) %>%
  mutate(pileup_max = max(pileup)) %>%
  filter(pileup == pileup_max) %>%
  select(AA, anticodon, chr, gene)
  


temp <- tris_base %>%
  filter(gene %in% temp$gene) %>% #take the most abundant for each anticodon
  filter(project=="Q2") %>%
  filter(#source=="cytosolic",
         #chr == "chr1.trna111",
         bin_start=="60",
         sample=="Q100",
         pileup >=500) %>%
  group_by(AA, anticodon, chr, gene, treatment, sample, position, source, base) %>%
  summarise(mean_deletion = mean(deletion / pileup)) 


ggplot(filter(temp, AA %in% c("Val")),
       aes(x=position, y=mean_deletion, color=treatment)) +
  geom_line() +
  geom_text(aes(label=base)) +
  geom_vline(xintercept = c(17,19), linetype=2, alpha=0.3) +
  coord_cartesian(ylim = c(-0.015, 0.2),
                  xlim=c(0,23)) +
  facet_grid(rows = vars(paste0(AA, anticodon))) +
  ylab("Deletion rate")+
  labs(color="Treatment") +
  theme(axis.text.x = element_text(angle=90, vjust=0.5),
        axis.title.x = element_blank()) 

```

####mtDihydroU
```{r}
temp <- tris_base %>%
  filter(project=="Q2") %>%
  filter(bin_start=="60",
         sample=="Q100",
         pileup >=500) %>%
  group_by(AA, anticodon) %>%
  filter(position > 25, position < 40) %>%
  mutate(pileup_max = max(pileup)) %>%
  filter(pileup == pileup_max) %>%
  select(AA, anticodon, chr, gene)
  


temp <- tris_base %>%
  filter(gene %in% temp$gene) %>% #take the most abundant for each anticodon
  filter(project=="Q2") %>%
  filter(#source=="cytosolic",
         #chr == "chr1.trna111",
         bin_start=="60",
         sample=="Q100",
         pileup >=500) %>%
  group_by(AA, anticodon, chr, gene, treatment, sample, position, source, base) %>%
  summarise(mean_deletion = mean(deletion / pileup)) 


ggplot(filter(temp, AA %in% c("mtLeu", "mtAsn","mtGln")),
       aes(x=position, y=mean_deletion, color=treatment)) +
  geom_line() +
  geom_text(aes(label=base)) +
  geom_vline(xintercept = c(17,19), linetype=2, alpha=0.3) +
  coord_cartesian(ylim = c(-0.015, 0.2),
                  xlim=c(15,30)) +
  facet_grid(rows = vars(paste0(AA, anticodon))) +
  ylab("Deletion rate")+
  labs(color="Treatment") +
  theme(axis.text.x = element_text(angle=90, vjust=0.5),
        axis.title.x = element_blank()) 

```


###Sulfur groups
```{r}

# temp <- tris_base %>%
#   filter(project=="Q2") %>%
#   filter(AA=="mtSer", #source!="cytosolic",
#          # anticodon=="TCT",
#          # chr == "chr1.trna69",
#          bin_start=="60",
#          sample == "Q100",
#          pileup >= 50) %>%
#   group_by(treatment, rep, sample, gene) %>%
#   mutate(norm_pileup = pileup / max(pileup)) #%>%
#   # filter(gene %in% temp_most$gene)
# # temp$treatment <- recode(temp$treatment, "minusI"="untreated", "plusI"="treated")
# 
# 
# ggplot(filter(temp, 
#               # chr == "chr1.trna69",
#               ),
#        aes(x=position, y=stop, color=treatment, group = interaction(treatment, rep, sample, gene))) +
#   geom_line() +
#   coord_cartesian(ylim = c(-0.015,1)) +
#   geom_text(aes(label=base), y=-0.01, color="black") +
#   geom_vline(xintercept = c(33), linetype=2, alpha=0.3) +
#   # scale_color_manual("IO4", values= c("treated"="red", "untreated"="black")) +
#   # ylab("Deletion\nrate") +
#   xlab("Position") +
#   facet_grid(rows=vars( paste0(AA, anticodon, chr)) ) +
#   theme(legend.position = c(0.8,0.7),
#         legend.background = element_rect(color="black", fill="white", linetype="solid"))


temp_most <- tris_base %>%
  filter(project=="Q2") %>%
  filter(bin_start=="60",
         sample=="Q100",
         treatment=="minusBxminusT",
         pileup >=50) %>%
  group_by(AA, anticodon) %>%
  filter(position > 25, position < 40) %>%
  mutate(pileup_max = max(pileup)) %>%
  filter(pileup == pileup_max) %>%
  select(AA, anticodon, chr, gene)

temp1 <- tris_base %>%
  filter(project=="Q2") %>%
  filter(gene %in% temp_most$gene) %>%
  filter((AA=="mtGlu" & position==28 & base=="T") | #Deletion
           (AA=="mtGln" & position==32 & base=="T") |
           (AA=="mtLys" & position ==28 & base=="T"),
         bin_start=="60",
         sample == "Q100",
         pileup >= 50) %>%
  mutate(modification = "τm5s2U34")
# temp1$treatment <- recode(temp1$treatment, "minusI"="untreated", "plusI"="treated")


temp2 <- tris_base %>%
  filter(project=="Q2") %>%
  filter(gene %in% temp_most$gene) %>%
  filter((AA=="mtTrp" & position==36 & base=="A") | #Stop *Off by one because of how stop is calculated
           (AA=="mtTyr" & position==33 & base=="A") |
           (AA=="mtPhe" & position==38 & base=="A") |
           (AA=="mtSer" & position==33 & base=="A" & anticodon=="TGA"),
         bin_start=="60",
         sample == "Q100",
         pileup >= 50) %>%
  mutate(modification = "ms2i6A")
# temp2$treatment <- recode(temp2$treatment, "minusI"="untreated", "plusI"="treated")

# temp3 <- Q_base %>%
#   filter(project=="Q") %>%
#   filter((AA=="mtAsn" & position==37 & base=="A") |
#            (AA=="mtThr" & position==35 & base=="A") |
#            (AA=="mtLys" & position ==28 & base=="T"),
#          bin_start=="60",
#          sample == "Q100",
#          pileup >= 100) %>%
#   mutate(modification = "t6A")
# temp3$treatment <- recode(temp3$treatment, "minusI"="untreated", "plusI"="treated")

temp3 <- tris_base %>%
  filter(project=="Q2") %>%
  filter(gene %in% temp_most$gene) %>%
  filter((AA=="Arg" & position==34 & base=="T" & anticodon=="TCT") | #Mutation
           (AA=="Glu" & position==34 & base=="T" & anticodon =="TTC") |
           (AA=="Gln" & position ==34 & base=="T" & anticodon =="TTG"),
         bin_start=="60",
         sample == "Q100",
         pileup >= 50) %>%
  mutate(modification = "mcm5s2u34")
# temp3$treatment <- recode(temp3$treatment, "minusI"="untreated", "plusI"="treated")

temp4 <- tris_base %>%
  filter(project=="Q2") %>%
  filter(gene %in% temp_most$gene) %>%
  filter((AA=="Lys" & position==33 & base=="T" & anticodon=="TTT"),
         bin_start=="60",
         sample == "Q100",
         pileup >= 50) %>%
  mutate(modification = "mnm5s2U34")
# temp4$treatment <- recode(temp4$treatment, "minusI"="untreated", "plusI"="treated")





plot1 <- ggplot(temp1, 
       aes(x=paste0(AA, anticodon), y=deletion/pileup, color=treatment)) +
  facet_grid(cols=vars(modification)) +
  geom_point() +
  ylab("Deletion rate") +
  theme(legend.position = "none",#c(0.8,0.7),
        legend.background = element_rect(color="black", fill="white", linetype="solid")) +
  # scale_color_manual("IO4", values= c("treated"="red", "untreated"="black")) +
  theme(axis.title.x = element_blank(),
        axis.text.x = element_text(angle=90, vjust=0.5))


plot2 <- ggplot(temp2, 
       aes(x=paste0(AA, anticodon), y=stop, color=treatment)) +
  facet_grid(cols=vars(modification)) +
  geom_point() +
  ylab("Stop rate") +
  theme(legend.position = "none",#c(0.8,0.7),
        legend.background = element_rect(color="black", fill="white", linetype="solid")) +
  # scale_color_manual("IO4", values= c("treated"="red", "untreated"="black")) +
  theme(axis.title.x = element_blank(),
        axis.text.x = element_text(angle=90, vjust=0.5))

plot3 <- ggplot(temp3, 
       aes(x=paste0(AA, anticodon), y=mutation, color=treatment)) +
  facet_grid(cols=vars(modification)) +
  geom_point() +
  ylab("Mutation rate") +
  theme(legend.position = "none",#c(0.8,0.7),
        legend.background = element_rect(color="black", fill="white", linetype="solid")) +
  # scale_color_manual("IO4", values= c("treated"="red", "untreated"="black")) +
  theme(axis.title.x = element_blank(),
        axis.text.x = element_text(angle=90, vjust=0.5))

plot4 <- ggplot(temp4, 
       aes(x=paste0(AA, anticodon), y=deletion/pileup, color=treatment)) +
  facet_grid(cols=vars(modification)) +
  geom_point() +
  ylab("Deletion rate") +
  theme(legend.position = "none",#c(0.8,0.7),
        legend.background = element_rect(color="black", fill="white", linetype="solid")) +
  # scale_color_manual("IO4", values= c("treated"="red", "untreated"="black")) +
  theme(axis.title.x = element_blank(),
        axis.text.x = element_text(angle=90, vjust=0.5))


figure_legend <- get_legend(plot1+theme(legend.position = "right",
                                       legend.background = element_rect(color="black", fill="white", linetype="solid")) )

layout <- rbind(c(1,1,2,2,3,3,4,4,4,5,5))
figure <- grid.arrange(plot1, plot4, plot3, plot2, figure_legend,  layout_matrix = layout)

path="../Draft/Figures20211227/"
figure_name="fig_s3c_human_others"
width=6
height=2
scale=1.5
dpi=600
# ggsave(paste0(path, figure_name,".svg"), 
#        plot = figure,
#        scale = scale,
#        dpi = dpi,
#        width = width, 
#        height = height)

ggsave(paste0(path, figure_name,".png"),
       plot = figure,
       scale = scale,
       dpi = dpi,
       width = width,
       height = height)


```











#_
###Human
####Tris  deletion
```{r}

temp <- tris_base %>%
  filter(project=="Q2") %>%
  filter(bin_start=="60",
         sample=="Q100",
         pileup >=500) %>%
  group_by(AA, anticodon) %>%
  filter(position > 25, position < 40) %>%
  mutate(pileup_max = max(pileup)) %>%
  filter(pileup == pileup_max) %>%
  select(AA, anticodon, chr, gene)
  


temp <- tris_base %>%
  filter(gene %in% temp$gene) %>% #take the most abundant for each anticodon
  filter(project=="Q2") %>%
  filter(#source=="cytosolic",
         #chr == "chr1.trna111",
         bin_start=="60",
         sample=="Q100",
         pileup >=500) %>%
  group_by(AA, anticodon, chr, gene, treatment, sample, position, source, base) %>%
  summarise(mean_deletion = mean(deletion / pileup)) %>%
  pivot_wider(names_from = c("treatment"), values_from = c("mean_deletion"))


ggplot(filter(temp),
       aes(x=paste0(AA, anticodon, chr), y=position, fill=minusBxplusT - minusBxminusT)) +
  # geom_tile(data=filter(temp, plusB - minusB >  0.05), fill="red4") +
  # geom_tile(data=filter(temp, plusB - minusB < -0.05), fill="blue4") +
  geom_tile(data=temp) +
  scale_fill_gradient2(low="blue", mid="grey70", midpoint=0, high="red", na.value="transparent", 
                       #limits=c(-0.05,0.05),
                       #breaks=c(-0.05, 0, 0.05)
                       ) +
  theme(axis.text.x = element_text(angle=90, hjust=1, vjust=0.5),
        legend.position = "right",
        axis.title.x = element_blank()) +
  scale_y_continuous(breaks=c(10,22,26,34,37,58)) +
  labs(fill = "Tris difference\n(treated - untreated)") +
  ggtitle("Deletion rate")

```

#####GluTTC
```{r}
temp <- tris_base %>%
  filter(project=="Q2") %>%
  filter(bin_start=="60",
         sample=="Q100",
         pileup >=500) %>%
  group_by(AA, anticodon) %>%
  filter(position > 25, position < 40) %>%
  mutate(pileup_max = max(pileup)) %>%
  filter(pileup == pileup_max) %>%
  select(AA, anticodon, chr, gene)
  
temp <- tris_base %>%
  filter(gene %in% temp$gene) %>% #take the most abundant for each anticodon
  filter(project=="Q2") %>%
  filter(#source=="cytosolic",
         #chr == "chr1.trna111",
         bin_start=="60",
         sample=="Q100",
         pileup >=500) %>%
  group_by(AA, anticodon, chr, gene, treatment, sample, position, source, base) %>%
  summarise(mean_deletion = mean(deletion / pileup))


ggplot(filter(temp, AA=="Glu", anticodon=="TTC", chr=="chr13.trna3"),
       aes(x=position, y=mean_deletion, color=treatment)) +
  geom_line() +
  facet_grid(rows=vars(gene)) 
  # geom_text(y=-0.0, aes(label=base))

```




####Tris  mutation
```{r}

temp <- tris_base %>%
  filter(project=="Q2") %>%
  filter(bin_start=="60",
         sample=="Q100",
         pileup >=500) %>%
  group_by(AA, anticodon) %>%
  filter(position > 25, position < 40) %>%
  mutate(pileup_max = max(pileup)) %>%
  filter(pileup == pileup_max) %>%
  select(AA, anticodon, chr, gene)
  


temp <- tris_base %>%
  filter(gene %in% temp$gene) %>% #take the most abundant for each anticodon
  filter(project=="Q2") %>%
  filter(#source=="cytosolic",
         #chr == "chr1.trna111",
         bin_start=="60",
         sample=="Q100",
         pileup >=500) %>%
  group_by(AA, anticodon, chr, gene, treatment, sample, position, source, base) %>%
  summarise(mean_mutation = mutation) %>%
  pivot_wider(names_from = c("treatment"), values_from = c("mean_mutation"))


ggplot(filter(temp),
       aes(x=paste0(AA, anticodon, chr), y=position, fill=minusBxplusT - minusBxminusT)) +
  # geom_tile(data=filter(temp, plusB - minusB >  0.05), fill="red4") +
  # geom_tile(data=filter(temp, plusB - minusB < -0.05), fill="blue4") +
  geom_tile(data=temp) +
  scale_fill_gradient2(low="blue", mid="grey70", midpoint=0, high="red", na.value="transparent", 
                       #limits=c(-0.05,0.05),
                       #breaks=c(-0.05, 0, 0.05)
                       ) +
  theme(axis.text.x = element_text(angle=90, hjust=1, vjust=0.5),
        legend.position = "right",
        axis.title.x = element_blank()) +
  scale_y_continuous(breaks=c(10,22,26,34,37,58)) +
  labs(fill = "Tris difference\n(treated - untreated)") +
  ggtitle("Mutation rate")

```



####Borohydride deletion
```{r}
temp <- tris_base %>%
  filter(project=="Q2") %>%
  filter(bin_start=="60",
         sample=="Q100",
         pileup >=500) %>%
  group_by(AA, anticodon) %>%
  filter(position > 25, position < 40) %>%
  mutate(pileup_max = max(pileup)) %>%
  filter(pileup == pileup_max) %>%
  select(AA, anticodon, chr, gene)
  


temp <- tris_base %>%
  filter(gene %in% temp$gene) %>% #take the most abundant for each anticodon
  filter(project=="Q2") %>%
  filter(#source=="cytosolic",
         #chr == "chr1.trna111",
         bin_start=="60",
         sample=="Q100",
         pileup >=500) %>%
  group_by(AA, anticodon, chr, gene, treatment, sample, position, source, base) %>%
  summarise(mean_deletion = mean(deletion / pileup)) %>%
  pivot_wider(names_from = c("treatment"), values_from = c("mean_deletion"))


ggplot(filter(temp),
       aes(x=paste0(AA, anticodon, chr), y=position, fill=plusBxminusT - minusBxminusT)) +
  # geom_tile(data=filter(temp, plusB - minusB >  0.05), fill="red4") +
  # geom_tile(data=filter(temp, plusB - minusB < -0.05), fill="blue4") +
  geom_tile(data=temp) +
  scale_fill_gradient2(low="blue", mid="grey70", midpoint=0, high="red", na.value="transparent", 
                       #limits=c(-0.05,0.05),
                       #breaks=c(-0.05, 0, 0.05)
                       ) +
  theme(axis.text.x = element_text(angle=90, hjust=1, vjust=0.5),
        legend.position = "right",
        axis.title.x = element_blank()) +
  scale_y_continuous(breaks=c(10,22,26,34,37,58)) +
  labs(fill = "Borohydride difference\n(treated - untreated)") +
  ggtitle("Deletion rate")


```

####Borohydride  mutation
```{r}

temp <- tris_base %>%
  filter(project=="Q2") %>%
  filter(bin_start=="60",
         sample=="Q100",
         pileup >=500) %>%
  group_by(AA, anticodon) %>%
  filter(position > 25, position < 40) %>%
  mutate(pileup_max = max(pileup)) %>%
  filter(pileup == pileup_max) %>%
  select(AA, anticodon, chr, gene)
  


temp <- tris_base %>%
  filter(gene %in% temp$gene) %>% #take the most abundant for each anticodon
  filter(project=="Q2") %>%
  filter(#source=="cytosolic",
         #chr == "chr1.trna111",
         bin_start=="60",
         sample=="Q100",
         pileup >=500) %>%
  group_by(AA, anticodon, chr, gene, treatment, sample, position, source, base) %>%
  summarise(mean_mutation = mutation) %>%
  pivot_wider(names_from = c("treatment"), values_from = c("mean_mutation"))


ggplot(filter(temp),
       aes(x=paste0(AA, anticodon, chr), y=position, fill=plusBxminusT - minusBxminusT)) +
  # geom_tile(data=filter(temp, plusB - minusB >  0.05), fill="red4") +
  # geom_tile(data=filter(temp, plusB - minusB < -0.05), fill="blue4") +
  geom_tile(data=temp) +
  scale_fill_gradient2(low="blue", mid="grey70", midpoint=0, high="red", na.value="transparent", 
                       #limits=c(-0.05,0.05),
                       #breaks=c(-0.05, 0, 0.05)
                       ) +
  theme(axis.text.x = element_text(angle=90, hjust=1, vjust=0.5),
        legend.position = "right",
        axis.title.x = element_blank()) +
  scale_y_continuous(breaks=c(10,22,26,34,37,58)) +
  labs(fill = "Borohydride difference\n(treated - untreated)") +
  ggtitle("Mutation rate")

```



#_
#_
#==========


#_
##Fun zone 
###Fragments
####Huamn-Asn
```{r}
temp <- Q_base %>%
  filter(project=="Q") %>%
  filter(AA=="Asp", source=="cytosolic",
         # chr == "chr1.trna69",
         bin_start %nin% c(-1,-2,-3),
         sample=="Q100",
         treatment == "plusI",
         pileup >= 100
         )

temp$treatment <- recode(temp$treatment, "minusI"="untreated", "plusI"="treated")


ggplot(filter(temp, position==34,
              # (chr=="chr1.trna69" & position==34)|(chr=="chr12.trna5" & position==34)|(chr=="chr6.trna144" & position==34),
              sample=="Q100"), 
       aes(x=paste0(AA, anticodon, chr), y=deletion/pileup, color=bin_start, group= interaction(treatment, rep, sample, gene))) +
  geom_point() +
  theme(axis.text.x = element_text(angle=90))

```

####Huamn-His
```{r}
temp <- Q_base %>%
  filter(project=="Q") %>%
  filter(AA=="His", source=="cytosolic",
         # chr == "chr1.trna69",
         bin_start %nin% c(-1,-2,-3),
         sample=="Q100",
         treatment == "plusI",
         pileup >= 100
         )

temp$treatment <- recode(temp$treatment, "minusI"="untreated", "plusI"="treated")


ggplot(filter(temp, position==34,
              # (chr=="chr1.trna69" & position==34)|(chr=="chr12.trna5" & position==34)|(chr=="chr6.trna144" & position==34),
              sample=="Q100"), 
       aes(x=paste0(AA, anticodon, chr), y=deletion/pileup, color=bin_start, group= interaction(treatment, rep, sample, gene))) +
  geom_point() +
  theme(axis.text.x = element_text(angle=90))

```

####Huamn-Asp
```{r}
temp <- Q_base %>%
  filter(project=="Q") %>%
  filter(AA=="Asp", source=="cytosolic",
         # chr == "chr1.trna69",
         bin_start %nin% c(-1,-2,-3),
         sample=="Q100",
         treatment == "plusI",
         pileup >= 100
         )

temp$treatment <- recode(temp$treatment, "minusI"="untreated", "plusI"="treated")


ggplot(filter(temp, position==34,
              # (chr=="chr1.trna69" & position==34)|(chr=="chr12.trna5" & position==34)|(chr=="chr6.trna144" & position==34),
              sample=="Q100"), 
       aes(x=paste0(AA, anticodon, chr), y=deletion/pileup, color=bin_start, group= interaction(treatment, rep, sample, gene))) +
  geom_point() +
  theme(axis.text.x = element_text(angle=90))

```

####Huamn-Tyr
```{r}
temp <- Q_base %>%
  filter(project=="Q") %>%
  filter(AA=="Tyr", source=="cytosolic",
         # chr == "chr1.trna69",
         bin_start %nin% c(-1,-2,-3),
         sample=="Q100",
         treatment == "plusI",
         pileup >= 100
         )

temp$treatment <- recode(temp$treatment, "minusI"="untreated", "plusI"="treated")


ggplot(filter(temp, position==34,
              # (chr=="chr1.trna69" & position==34)|(chr=="chr12.trna5" & position==34)|(chr=="chr6.trna144" & position==34),
              sample=="Q100"), 
       aes(x=paste0(AA, anticodon, chr), y=deletion/pileup, color=bin_start, group= interaction(treatment, rep, sample, gene))) +
  geom_point() +
  theme(axis.text.x = element_text(angle=90))

```

####Huamn-mtHis
```{r}
temp <- Q_base %>%
  filter(project=="Q") %>%
  filter(AA=="mtHis", source=="mitochondrial",
         # chr == "chr1.trna69",
         bin_start %nin% c(-1,-2,-3),
         sample=="Q100",
         treatment == "plusI",
         pileup >= 100
         )

temp$treatment <- recode(temp$treatment, "minusI"="untreated", "plusI"="treated")


ggplot(filter(temp, position==34,
              # (chr=="chr1.trna69" & position==34)|(chr=="chr12.trna5" & position==34)|(chr=="chr6.trna144" & position==34),
              sample=="Q100"), 
       aes(x=paste0(AA, anticodon, chr), y=deletion/pileup, color=bin_start, group= interaction(treatment, rep, sample, gene))) +
  geom_point() +
  theme(axis.text.x = element_text(angle=90))

```

####Huamn-mtAsp
```{r}
temp <- Q_base %>%
  filter(project=="Q") %>%
  filter(AA=="mtAsp", source=="mitochondrial",
         # chr == "chr1.trna69",
         bin_start %nin% c(-1,-2,-3),
         sample=="Q100",
         treatment == "plusI",
         pileup >= 100
         )

temp$treatment <- recode(temp$treatment, "minusI"="untreated", "plusI"="treated")


ggplot(filter(temp, position==34,
              # (chr=="chr1.trna69" & position==34)|(chr=="chr12.trna5" & position==34)|(chr=="chr6.trna144" & position==34),
              sample=="Q100"), 
       aes(x=paste0(AA, anticodon, chr), y=deletion/pileup, color=bin_start, group= interaction(treatment, rep, sample, gene))) +
  geom_point() +
  theme(axis.text.x = element_text(angle=90))

```

####Huamn-mtAsn
```{r}
temp <- Q_base %>%
  filter(project=="Q") %>%
  filter(AA=="mtAsn", source=="mitochondrial",
         # chr == "chr1.trna69",
         bin_start %nin% c(-1,-2,-3),
         sample=="Q100",
         treatment == "plusI",
         pileup >= 100
         )

temp$treatment <- recode(temp$treatment, "minusI"="untreated", "plusI"="treated")


ggplot(filter(temp, position==34,
              # (chr=="chr1.trna69" & position==34)|(chr=="chr12.trna5" & position==34)|(chr=="chr6.trna144" & position==34),
              sample=="Q100"), 
       aes(x=paste0(AA, anticodon, chr), y=deletion/pileup, color=bin_start, group= interaction(treatment, rep, sample, gene))) +
  geom_point() +
  theme(axis.text.x = element_text(angle=90))

```

####Huamn-mtTyr
```{r}
temp <- Q_base %>%
  filter(project=="Q") %>%
  filter(AA=="mtTyr", source=="mitochondrial",
         # chr == "chr1.trna69",
         bin_start %nin% c(-1,-2,-3),
         sample=="Q100",
         treatment == "plusI",
         pileup >= 100
         )

temp$treatment <- recode(temp$treatment, "minusI"="untreated", "plusI"="treated")


ggplot(filter(temp, position==34,
              # (chr=="chr1.trna69" & position==34)|(chr=="chr12.trna5" & position==34)|(chr=="chr6.trna144" & position==34),
              sample=="Q100"), 
       aes(x=paste0(AA, anticodon, chr), y=deletion/pileup, color=bin_start, group= interaction(treatment, rep, sample, gene))) +
  geom_point() +
  theme(axis.text.x = element_text(angle=90))

```

####Ecoli-His
```{r}
temp <- Ecoli_base %>%
  filter(amino_acid=="His",
         # chr == "chr1.trna69",
         bin_start %nin% c(-1,-2,-3),
         treatment == "treated",
         pileup >= 100
         )


ggplot(filter(temp, position==34,
              # (chr=="chr1.trna69" & position==34)|(chr=="chr12.trna5" & position==34)|(chr=="chr6.trna144" & position==34),
              ), 
       aes(x=paste0(amino_acid, anticodon, n1), y=deletion/pileup, color=bin_start, group= interaction(treatment, n1))) +
  geom_point() +
  theme(axis.text.x = element_text(angle=90))

```

####Ecoli-Asp
```{r}
temp <- Ecoli_base %>%
  filter(amino_acid=="Asp",
         # chr == "chr1.trna69",
         bin_start %nin% c(-1,-2,-3),
         treatment == "treated",
         pileup >= 100
         )


ggplot(filter(temp, position==34,
              # (chr=="chr1.trna69" & position==34)|(chr=="chr12.trna5" & position==34)|(chr=="chr6.trna144" & position==34),
              ), 
       aes(x=paste0(amino_acid, anticodon, n1), y=deletion/pileup, color=bin_start, group= interaction(treatment, n1))) +
  geom_point() +
  theme(axis.text.x = element_text(angle=90))

```

####Ecoli-Asn
```{r}
temp <- Ecoli_base %>%
  filter(amino_acid=="Asn",
         # chr == "chr1.trna69",
         bin_start %nin% c(-1,-2,-3),
         treatment == "treated",
         pileup >= 100
         )


ggplot(filter(temp, position==34,
              # (chr=="chr1.trna69" & position==34)|(chr=="chr12.trna5" & position==34)|(chr=="chr6.trna144" & position==34),
              ), 
       aes(x=paste0(amino_acid, anticodon, n1), y=deletion/pileup, color=bin_start, group= interaction(treatment, n1))) +
  geom_point() +
  theme(axis.text.x = element_text(angle=90))

```

####Ecoli-Tyr
```{r}
temp <- Ecoli_base %>%
  filter(amino_acid=="Tyr",
         # chr == "chr1.trna69",
         bin_start %nin% c(-1,-2,-3),
         treatment == "treated",
         pileup >= 100
         )


ggplot(filter(temp, position==34,
              # (chr=="chr1.trna69" & position==34)|(chr=="chr12.trna5" & position==34)|(chr=="chr6.trna144" & position==34),
              ), 
       aes(x=paste0(amino_acid, anticodon, "-", n1), y=deletion/pileup, color=bin_start, group= interaction(treatment, n1))) +
  geom_point() +
  theme(axis.text.x = element_text(angle=90))

```

#_
####V34 - bust
```{r}
#E.coli
#V34 Ecoli
temp <- Ecoli_base %>%
  filter(bin_start == "60",
         anticodon=="TAG",
         pileup >= 100)

ggplot(temp, aes(x=position, y=deletion/pileup , color=treatment, group=interaction(amino_acid, anticodon, n1,n2, treatment))) +
  geom_line() +
  geom_vline(xintercept = 35, linetype=2, alpha=0.3) +
  facet_grid(cols=vars(paste0(amino_acid, anticodon, "-",n1, "-", n2))) +
  geom_text(aes(label=base), y=-0.01, color="black") +
  coord_cartesian(ylim = c(-0.015,0.1), xlim=c(25, 40)) +
  theme(legend.position = c(0.8,0.7),
        legend.background = element_rect(color="black", fill="white", linetype="solid")) +
  scale_color_manual("IO4", values= c("treated"="red", "untreated"="black")) 
  # ylab("Deletion\nrate")


temp1 <- Ecoli_base %>%
  filter(bin_start == "60",
         (anticodon=="TGC" & position ==34 & base=="T")|
           (anticodon=="TAC" & position ==34 & base=="T"),
         pileup >= 100) %?%
  mutate(modification = "cmo5U")

```
#_
#_
#Effect of 0Q 100Q
###Human
####Deletion
```{r}
temp <- Q_base %>%
  filter(project=="Q") %>%
  filter(bin_start=="60",
         sample=="Q100",
         pileup >=500) %>%
  group_by(AA, anticodon) %>%
  filter(position > 25, position < 40) %>%
  mutate(pileup_max = max(pileup)) %>%
  filter(pileup == pileup_max) %>%
  select(AA, anticodon, chr, gene)
  


temp <- Q_base %>%
  filter(gene %in% temp$gene) %>% #take the most abundant for each anticodon
  filter(project=="Q") %>%
  filter(source=="cytosolic",
         #chr == "chr1.trna111",
         bin_start=="60",
         treatment=="plusI",
         pileup >=500) %>%
  group_by(AA, anticodon, chr, gene, treatment, sample, position) %>%
  summarise(mean_deletion = mean(deletion / pileup)) %>%
  pivot_wider(names_from = c("sample"), values_from = c("mean_deletion"))


ggplot(filter(temp),
       aes(x=paste0(AA, anticodon, chr), y=position, fill=Q100 - Q0)) +
  geom_tile() +
  scale_fill_gradient2(low="blue", mid="grey70", midpoint=0, high="red", na.value="grey70", 
                       limits=c(-0.05,0.05),
                       breaks=c(-0.05, 0, 0.05)) +
  geom_tile(data=filter(temp, Q100 - Q0 >  0.05), fill="red4") +
  geom_tile(data=filter(temp, Q100 - Q0 < -0.05), fill="blue4") +
  theme(axis.text.x = element_text(angle=90, hjust=1, vjust=0.5)) +
  scale_y_continuous(breaks=c(10,22,26,34,37,58)) +
  ggtitle("Deletion rate")

```

####Mutation
```{r}
temp <- Q_base %>%
  filter(project=="Q") %>%
  filter(bin_start=="60",
         sample=="Q100",
         pileup >=500) %>%
  group_by(AA, anticodon) %>%
  filter(position > 25, position < 40) %>%
  mutate(pileup_max = max(pileup)) %>%
  filter(pileup == pileup_max) %>%
  select(AA, anticodon, chr, gene)
  


temp <- Q_base %>%
  filter(gene %in% temp$gene) %>% #take the most abundant for each anticodon
  filter(project=="Q") %>%
  filter(source=="cytosolic",
         #chr == "chr1.trna111",
         bin_start=="60",
         treatment=="plusI",
         pileup >=500) %>%
  group_by(AA, anticodon, chr, gene, treatment, sample, position) %>%
  summarise(mean_mutation = mean(mutation)) %>%
  pivot_wider(names_from = c("sample"), values_from = c("mean_mutation"))


ggplot(filter(temp),
       aes(x=paste0(AA, anticodon, chr), y=position, fill=Q100 - Q0)) +
  geom_tile() +
  scale_fill_gradient2(low="blue", mid="grey70", midpoint=0, high="red", na.value="grey70", 
                       limits=c(-0.1,0.1),
                       breaks=c(-0.1, 0, 0.1)) +
  geom_tile(data=filter(temp, Q100 - Q0 >  0.1), fill="red4") +
  geom_tile(data=filter(temp, Q100 - Q0 < -0.1), fill="blue4") +
  theme(axis.text.x = element_text(angle=90, hjust=1, vjust=0.5)) +
  ggtitle("Mutation")

```
#_


#mtAsp weird stuff
```{r}


temp <- Q_base %>%
  filter(project=="Q") %>%
  filter(AA=="Asp", #source=="cytosolic",
         chr == "chr1.trna69",
         bin_start=="60",
         # sample == "Q100",
         pileup >= 100)
temp$treatment <- recode(temp$treatment, "minusI"="untreated", "plusI"="treated")

ggplot(filter(temp, position==31, base=="G",
              # (chr=="chr1.trna69" & position==34)|(chr=="chr12.trna5" & position==34)|(chr=="chr6.trna144" & position==34),
              base=="G",
              # sample=="Q100"
              ), 
       aes(x=paste0(AA, anticodon,"\n", chr), y=deletion/pileup, color=treatment, group= interaction(treatment, rep, sample, gene))) +
  geom_point() +
  scale_color_manual("IO4", values= c("treated"="red", "untreated"="black")) +
  ylab("Deletion rate") +
  theme(axis.text.x = element_text(angle=90, vjust=0.5),
        axis.title.x = element_blank(),
        legend.position = "none") +
  facet_grid(cols=vars(sample))


ggplot(filter(temp),
       aes(x=position, y=stop, color=interaction(treatment), group=interaction(sample, rep, treatment))) +
  geom_line() +
  geom_vline(xintercept = c(34), linetype=2) +
  geom_hline(yintercept = c(0.074, 0.035), linetype=2, alpha=0.3) +
  geom_text(aes(label=base), color="black", y= -0.005) +
  coord_cartesian(ylim = c(-0.01, 0.1)) +
  facet_grid(rows=vars(sample),
             cols=vars(paste0(AA, anticodon, chr)))

```

##QCal
```{r}
temp <- Qcal_base %>%
  filter(AA=="Asp", #source=="cytosolic",
         chr == "chr1.trna69",
         bin_start=="60",
         pileup >=500,
         # position==34
         ) %>%
  mutate(Qlevel = sample)

temp$Qlevel <- recode(temp$Qlevel, "Q0"=0, "Q10"=10, "Q20"=20, "Q30"=30, "Q40"=40, 
                      "Q50"=50, "Q60"=60, "Q70"=70, "Q80"=80, "Q90"=90, "Q100"=100)
 
ggplot(filter(temp),
       aes(x=position, y=stop, color=Qlevel, group=interaction(Qlevel))) +
  geom_line(alpha=0.9) +
  geom_vline(xintercept = c(34), linetype=2) +
  scale_color_gradient(low="blue", high="orange") +
  geom_text(aes(label=base), color="black", y= -0.005) +
  coord_cartesian(ylim = c(-0.01, 0.3),
                  xlim = c(30,40)) +
  facet_grid(#rows=vars(sample),
             cols=vars(paste0(AA, anticodon, chr)))
```



#Ecoli S4U
```{r}

temp <- Ecoli_base %>%
  filter(bin_start == "60",
         amino_acid=="His",
         # anticodon=="CGA",
         pileup >= 1000)

ggplot(temp, aes(x=position, y=deletion/pileup, color=treatment, group=interaction(amino_acid, anticodon, n1,n2, treatment))) +
  geom_line() +
  geom_vline(xintercept = 8, linetype=2, alpha=0.3) +
  facet_grid(cols=vars(paste0(amino_acid, anticodon, "-",n1, "-", n2))) +
  # geom_text(aes(label=base), y=-0.01, color="black") +
  coord_cartesian(ylim = c(-0.015,0.1)) +
  theme(legend.position = c(0.75,0.7),
        legend.background = element_rect(color="black", fill="white", linetype="solid")) +
  scale_color_manual("IO4", values= c("treated"="red", "untreated"="black"))


```


#_
#Check m1G
```{r}
temp <- Q_base %>%
  filter(project=="Q") %>%
  filter(AA=="Trp",anticodon=="CCA", source=="cytosolic",
         # chr == "chr1.trna111",
         bin_start=="60",
         # sample=="Q0",
         pileup >= 100)

temp$treatment <- recode(temp$treatment, "minusI"="untreated", "plusI"="treated")
temp$sample <- recode(temp$sample, "Q0"="0Q", "Q100"="100Q")


ggplot(filter(temp, 
              # chr=="chr1.trna50"
              ),
       aes(x=position, y=deletion/pileup, color=treatment, group = interaction(treatment, rep, sample, gene))) +
  geom_line() +
  coord_cartesian(ylim = c(-0.015,0.15),
                  xlim = c(29,39)) +
  scale_x_continuous(breaks = c(31,33,35,37,39)) +
  # geom_text(aes(label=base), y=-0.01, color="black") +
  geom_vline(xintercept = c(34), linetype=2, alpha=0.3) +
  scale_color_manual("IO4", values= c("treated"="red", "untreated"="black")) +
  ylab("Deletion rate") +
  xlab("Position") +
  facet_grid(cols=vars( paste0(AA, anticodon, chr)),
             rows=vars( sample)) +
  theme(#legend.position = c(0.8,0.7),
        legend.position = "none",
        legend.background = element_rect(color="black", fill="white", linetype="solid"))











temp <- Qcal_base %>%
  filter(#project=="Q", 
         pileup >= 1000,
         bin_start=="60") %>%
  filter(#(AA=="Asp" & chr=="chr1.trna69") |
         #(AA=="Asn" & chr=="chr1.trna26") |
         #(AA=="Tyr" & chr =="chr14.trna16") |
         (AA=="Trp" & anticodon == "CCA") #|
         #(AA =="mtHis") |
         #(AA =="mtAsn") |
         #(AA =="mtTyr") |
         #( AA =="mtAsp") 
         )

temp$sample <- recode(temp$sample, "Q0"=0, "Q10"=10, "Q20"=20, "Q30"=30, "Q40"=40, 
                      "Q50"=50, "Q60"=60, "Q70"=70, "Q80"=80, "Q90"=90, "Q100"=100)
ggplot(temp,
       aes(x=position, y=deletion / pileup, color=sample, group=interaction(sample, gene))) +
  geom_line() +
  scale_color_continuous(low="black", high="red") +
  geom_vline(xintercept = c(34), alpha=0.3, linetype=2) +
  scale_x_continuous(breaks=c(32,34,36,38)) +
  # scale_y_log10() +
  coord_cartesian(xlim = c(29,39),
                  ylim = c(0, 0.15 )) +
  facet_wrap(~AA) +
  theme(legend.position = "none")


```

###Thiol in tetra borate
```{r}
temp <- Q_base %>%
  filter(project=="Q") %>%
  filter(AA=="Glu",anticodon=="TTC", source=="cytosolic",
         chr == "chr13.trna5",
         bin_start=="60",
         # sample=="Q0",
         pileup >= 100)

temp$treatment <- recode(temp$treatment, "minusI"="untreated", "plusI"="treated")
temp$sample <- recode(temp$sample, "Q0"="0Q", "Q100"="100Q")


ggplot(filter(temp, 
              # chr=="chr1.trna50"
              ),
       aes(x=position, y=mutation, color=treatment, group = interaction(treatment, rep, sample, gene))) +
  geom_line() +
  coord_cartesian(#ylim = c(-0.015,0.15),
                  xlim = c(29,39)) +
  scale_x_continuous(breaks = c(31,33,35,37,39)) +
  # geom_text(aes(label=base), y=-0.01, color="black") +
  geom_vline(xintercept = c(34), linetype=2, alpha=0.3) +
  scale_color_manual("IO4", values= c("treated"="red", "untreated"="black")) +
  # ylab("Deletion rate") +
  xlab("Position") +
  facet_grid(cols=vars( paste0(AA, anticodon)),
             rows=vars( sample)) +
  theme(#legend.position = c(0.8,0.7),
        legend.position = "none",
        legend.background = element_rect(color="black", fill="white", linetype="solid"))



temp <- Qcal_base %>%
  filter(#project=="Q", 
         pileup >= 1000,
         bin_start=="60") %>%
  filter(#(AA=="Asp" & chr=="chr1.trna69") |
         #(AA=="Asn" & chr=="chr1.trna26") |
         #(AA=="Tyr" & chr =="chr14.trna16") |
         (AA=="Glu" & anticodon == "TTC" & chr=="chr13.trna5") #|
         #(AA =="mtHis") |
         #(AA =="mtAsn") |
         #(AA =="mtTyr") |
         #( AA =="mtAsp") 
         )

temp$sample <- recode(temp$sample, "Q0"=0, "Q10"=10, "Q20"=20, "Q30"=30, "Q40"=40, 
                      "Q50"=50, "Q60"=60, "Q70"=70, "Q80"=80, "Q90"=90, "Q100"=100)
ggplot(temp,
       aes(x=position, y=mutation, color=sample, group=interaction(sample, gene))) +
  geom_line() +
  scale_color_continuous(low="black", high="red") +
  geom_vline(xintercept = c(34), alpha=0.3, linetype=2) +
  scale_x_continuous(breaks=c(32,34,36,38)) +
  # scale_y_log10() +
  coord_cartesian(xlim = c(29,39),
                  #ylim = c(0, 0.15 )
                  ) +
  facet_wrap(~AA) +
  theme(legend.position = "none")
```




#_
#_
#_

#Draft E coli stress analysis

##Read in data
###Basewise

```{r}
PATH <- "../data/191227_Ecoli_stress/5_tsv/Escherichia_tRNA_reference/"
# PATH="../../20201021_COVID/5_tsv/hg19CCA+mito_adjusted_names+5Setc/" #Old stuff is good still
FILES <-data.frame( file_name = list.files(PATH) ) %>%
  filter(!grepl("unassigned", file_name))

#Split generic file names into salient parts
FILES <- FILES %>%
  extract(file_name, "(.*).tsv", into="file_name2", remove=FALSE) %>%
  separate(file_name2, remove=TRUE, sep="_", c("library","junk1", "barcode","junk2","bin_start","bin_stop", "junk3")) %>%
  select(-junk1, -junk2, -junk3)
#Annotate the total BIN
FILES <- FILES %>%
  mutate(bin_start = ifelse(is.na(bin_start), -3, bin_start),
         bin_stop = ifelse(is.na(bin_stop), -3, bin_stop))

#====================================
#PROJECT SPECIFIC DECODING
FILES$file_name <- as.character(FILES$file_name)

FILES$library <- recode(FILES$library, 
                       "TP-CK4-RPL7"="rep1_minus",
                       "TP-CK4-RPL10"="rep1_plus",
                       "TP-CK4-RPL11"="rep2_minus",
                       "TP-CK4-RPL12"="rep2_plus")
FILES$barcode <- recode(FILES$barcode, 
                       "bc6"="None",
                       "bc7"="DIP",
                       "bc10"="aMG",
                       "bc12"="H2O2")

FILES <- FILES %>%
  separate(library, sep="_", into =c("rep", "DM")) %>%
  mutate(treatment = barcode) %>%
  select(-barcode)

#End project specific ================================

read_in_one <- function(row){
  output <- read.csv(paste0(PATH, row$file_name), header=T, sep="\t") %>%
    mutate(bin_start = row$bin_start,
           bin_stop  = row$bin_stop,
           #Some project specific bits
           DM = row$DM,
           rep = row$rep,
           treatment = row$treatment
           )
  #specify data types since enpty dataframes get confused and sad
  output$gene <- as.character(output$gene)
  output$base <- as.character(output$base)
  return(output)
}

data_EcoliStress_base <- FILES %>%
  group_by(file_name) %>%
  do(read_in_one(.)) %>%
  ungroup()

data_EcoliStress_base <- data_EcoliStress_base

```

###Extra processing
```{r}
temp <- data_EcoliStress_base %>%
  separate(gene, sep="tRNA-", c("wasted","Isodecoder")) %>%
  filter(Isodecoder %nin% c("tRNA-Und-NNN-1-1","tRNA-Und-NNN-2-1")) %>%
  select(-wasted)
temp$Isodecoder <- str_replace_all(temp$Isodecoder, "-1-1","-1")
temp$Isodecoder <- str_replace_all(temp$Isodecoder, "-2-1","-2") 

temp <- temp %>%
  separate(Isodecoder, sep="-", into = c("AA", "anticodon", "chr"))

EcoliStress_base <- temp

```

##Stress figures
###Thiol group traces
####s2C32
#####traces
```{r}
temp <- EcoliStress_base %>%
  filter(bin_start=="60") %>%
  filter(AA=="Arg" | (AA=="Ser" & anticodon=="GCT")) %>%
  filter(DM=="minus")

ggplot(filter(temp, treatment %in% c("None","DIP")),
       aes(x=position, y=mutation, color=treatment,  group=interaction(rep, treatment, AA, anticodon, chr))) +
  geom_line() +
  geom_text(aes(label=base), y=-0.02) +
  geom_vline(xintercept = c(32), linetype=2, alpha=0.3) +
  coord_cartesian(xlim = c(30,37),
                  ylim = c(-0.05, .75)) +
  facet_grid(rows = vars(paste0(AA, anticodon)))

```

#####traces 2
```{r}
temp <- EcoliStress_base %>%
  filter(bin_start=="60") %>%
  filter(AA=="Arg" | (AA=="Ser" & anticodon=="GCT")) %>%
  filter(DM=="minus")

plot1 <- ggplot(filter(temp, treatment %in% c("None","DIP"),
                       anticodon=="ACG"),
       aes(x=position, y=mutation, color=treatment,  group=interaction(rep, treatment, AA, anticodon, chr))) +
  geom_line() +
  geom_text(aes(label=base), y=-0.02) +
  geom_vline(xintercept = c(32), linetype=2, alpha=0.3) +
  coord_cartesian(xlim = c(30,37),
                  ylim = c(-0.05, .5)
                  ) +
  facet_grid(rows = vars(paste0(AA, anticodon)))

plot2 <- ggplot(filter(temp, treatment %in% c("None","DIP"),
                       anticodon=="CCG"),
       aes(x=position, y=mutation, color=treatment,  group=interaction(rep, treatment, AA, anticodon, chr))) +
  geom_line() +
  geom_text(aes(label=base), y=-0.02) +
  geom_vline(xintercept = c(32), linetype=2, alpha=0.3) +
  coord_cartesian(xlim = c(30,37),
                  ylim = c(-0.05, .4)
                  ) +
  facet_grid(rows = vars(paste0(AA, anticodon)))

plot3 <- ggplot(filter(temp, treatment %in% c("None","DIP"),
                       anticodon=="CCT"),
       aes(x=position, y=mutation, color=treatment,  group=interaction(rep, treatment, AA, anticodon, chr))) +
  geom_line() +
  geom_text(aes(label=base), y=-0.02) +
  geom_vline(xintercept = c(32), linetype=2, alpha=0.3) +
  coord_cartesian(xlim = c(30,37),
                  ylim = c(-0.05, .15)
                  ) +
  facet_grid(rows = vars(paste0(AA, anticodon)))

plot4 <- ggplot(filter(temp, treatment %in% c("None","DIP"),
                       anticodon=="TCT"),
       aes(x=position, y=mutation, color=treatment,  group=interaction(rep, treatment, AA, anticodon, chr))) +
  geom_line() +
  geom_text(aes(label=base), y=-0.02) +
  geom_vline(xintercept = c(32), linetype=2, alpha=0.3) +
  coord_cartesian(xlim = c(30,37),
                  ylim = c(-0.05, .1)
                  ) +
  facet_grid(rows = vars(paste0(AA, anticodon)))

plot5 <- ggplot(filter(temp, treatment %in% c("None","DIP"),
                       anticodon=="GCT"),
       aes(x=position, y=mutation, color=treatment,  group=interaction(rep, treatment, AA, anticodon, chr))) +
  geom_line() +
  geom_text(aes(label=base), y=-0.02) +
  geom_vline(xintercept = c(32), linetype=2, alpha=0.3) +
  coord_cartesian(xlim = c(30,37),
                  ylim = c(-0.05, .75)
                  ) +
  facet_grid(rows = vars(paste0(AA, anticodon)))

layout <- rbind(c(1),c(2),c(3),c(4),c(5))
figure <- grid.arrange(plot1,plot2, plot3, plot4, plot5,  layout_matrix = layout)

path="../Draft/Figures20220117//"
figure_name="fig_Xx_Ecoli_traces"
width=2
height=5
scale=1.5
dpi=600
# ggsave(paste0(path, figure_name,".svg"), 
#        plot = figure,
#        scale = scale,
#        dpi = dpi,
#        width = width, 
#        height = height)

ggsave(paste0(path, figure_name,".png"),
       plot = figure,
       scale = scale,
       dpi = dpi,
       width = width,
       height = height)


```
#####dots
```{r}
temp <- EcoliStress_base %>%
  filter(bin_start=="60") %>%
  filter( (AA=="Arg" & anticodon=="ACG" & position==33) | 
            (AA=="Arg" & anticodon=="CCG" & position==33)|
            (AA=="Arg" & anticodon=="CCT" & position==32) |
            (AA=="Arg" & anticodon=="TCT" & position==32) |
           (AA=="Ser" & anticodon=="GCT" & position==33)) %>%
  filter(DM=="minus")
temp$treatment <- factor(temp$treatment, levels=c("None", "DIP","H2O2","aMG"))

ggplot(filter(temp),
       aes(x=paste0(AA, anticodon), y=mutation, color=treatment)) +
  geom_boxplot() 

```

#####Pvalues
```{r}
temp <- EcoliStress_base %>%
  filter(bin_start=="60") %>%
  filter( (AA=="Arg" & anticodon=="ACG" & position==33) | 
            (AA=="Arg" & anticodon=="CCG" & position==33)|
            (AA=="Arg" & anticodon=="CCT" & position==32) |
            (AA=="Arg" & anticodon=="TCT" & position==32) |
           (AA=="Ser" & anticodon=="GCT" & position==33)) %>%
  filter(DM=="minus")

temp$treatment <- factor(temp$treatment, levels=c("None", "DIP","H2O2","aMG"))
my_comparisons <- list( c("None", "DIP"),
                        c("None", "H2O2"),
                        c("None","aMG")
                        )
ggplot(filter(temp),
       aes(x=treatment, y= mutation )) +
  geom_boxplot()  +
  geom_point(aes(color=anticodon))  +
  geom_line(aes(group=interaction(AA, anticodon, rep))) +
  # scale_y_log10() +
  stat_compare_means(comparisons = my_comparisons, size=4,
                     method="wilcox.test",
                     label="p.signif",
                     paired=T
                     ) 

```

#####Subtraction
```{r}
temp <- EcoliStress_base %>%
  filter(bin_start=="60") %>%
  filter( (AA=="Arg" & anticodon=="ACG" & position==33) | 
            (AA=="Arg" & anticodon=="CCG" & position==33)|
            (AA=="Arg" & anticodon=="CCT" & position==32) |
            (AA=="Arg" & anticodon=="TCT" & position==32) |
           (AA=="Ser" & anticodon=="GCT" & position==33)) %>%
  filter(DM=="minus")

temp <- temp %>%
  filter(treatment =="None") %>%
  group_by(AA, anticodon) %>%
  summarise(mean_of_control = mean(mutation)) %>%
  full_join(., temp, by=c("AA", "anticodon"))

temp$treatment <- factor(temp$treatment, levels=c("None", "DIP","H2O2","aMG"))
my_comparisons <- list( c("None", "DIP"),
                        c("None", "H2O2"),
                        c("None","aMG")
                        )
ggplot(filter(temp),
       aes(x=treatment, y= mutation - mean_of_control )) +
  geom_boxplot()  +
  geom_point(aes(color=anticodon))  +
  geom_line(aes(group=interaction(AA, anticodon, rep))) +
  # scale_y_log10() +
  stat_compare_means(comparisons = my_comparisons, size=4,
                     method="wilcox.test",
                     label="p.signif",
                     paired=T
                     ) 

write.csv(temp, file = "EcoliStresss2U.csv")

```

#####Divisions
````{r}
ggplot(filter(temp),
       aes(x=treatment, y= mutation / mean_of_control )) +
  geom_boxplot()  +
  geom_point(aes(color=anticodon))  +
  geom_line(aes(group=interaction(AA, anticodon, rep))) +
  scale_y_log10() +
  stat_compare_means(comparisons = my_comparisons, size=4,
                     method="wilcox.test",
                     label="p.signif",
                     paired=T
                     ) 

```

####cmnm5s2U34
#####traces
```{r}
temp <- EcoliStress_base %>%
  filter(bin_start=="60") %>%
  filter( (AA=="Gln" & anticodon=="TTG") | (AA=="Glu" & anticodon=="TTC")) %>%
  filter(DM=="minus")

ggplot(filter(temp),
       aes(x=position, y=mutation, color=treatment,  group=interaction(rep, treatment, AA, anticodon, chr))) +
  geom_line() +
  geom_text(aes(label=base), y=-0.02) +
  geom_vline(xintercept = c(34), linetype=2, alpha=0.3) +
  coord_cartesian(xlim = c(30,40),
                  ylim = c(-0.03, .25)) +
  facet_grid(rows = vars(paste0(AA, anticodon)))

```

#####dots
```{r}
temp <- EcoliStress_base %>%
  filter(bin_start=="60") %>%
  filter( (AA=="Gln" & anticodon=="TTG" & position==33) | 
            (AA=="Glu" & anticodon=="TTC" & position==35)) %>%
  filter(DM=="minus")
temp$treatment <- factor(temp$treatment, levels=c("None", "DIP","H2O2","aMG"))

ggplot(filter(temp),
       aes(x=paste0(AA, anticodon), y=mutation, color=treatment)) +
  geom_boxplot() +
  geom_point()

temp$treatment <- factor(temp$treatment, levels=c("None", "DIP","H2O2","aMG"))
my_comparisons <- list( c("None", "DIP"),
                        c("None", "H2O2"),
                        c("None","aMG")
                        )
ggplot(filter(temp),
       aes(x=treatment, y= mutation )) +
  geom_boxplot()  +
  geom_point(aes(color=anticodon))  +
  coord_cartesian(ylim = c(0, 0.35)) +
  geom_line(aes(group=interaction(AA, anticodon, rep))) +
  # scale_y_log10() +
  stat_compare_means(comparisons = my_comparisons, size=4,
                     method="wilcox.test",
                     label="p.signif",
                     paired=T
                     ) 
```

#####subrataction
```{r}
temp <- EcoliStress_base %>%
  filter(bin_start=="60") %>%
  filter( (AA=="Gln" & anticodon=="TTG" & position==33) | 
            (AA=="Glu" & anticodon=="TTC" & position==35)) %>%
  filter(DM=="minus")

temp <- temp %>%
  filter(treatment =="None") %>%
  group_by(AA, anticodon) %>%
  summarise(mean_of_control = mean(mutation)) %>%
  full_join(., temp, by=c("AA", "anticodon"))

temp$treatment <- factor(temp$treatment, levels=c("None", "DIP","H2O2","aMG"))
my_comparisons <- list( c("None", "DIP"),
                        c("None", "H2O2"),
                        c("None","aMG")
                        )
ggplot(filter(temp),
       aes(x=treatment, y= mutation - mean_of_control )) +
  geom_boxplot()  +
  geom_point(aes(color=anticodon))  +
  geom_line(aes(group=interaction(AA, anticodon, rep))) +
  coord_cartesian(ylim = c(-0.2, 0.2)) +
  # scale_y_log10() +
  stat_compare_means(comparisons = my_comparisons, size=4,
                     method="wilcox.test",
                     label="p.signif",
                     paired=F
                     ) 

write.csv(temp, file = "EcoliStresscmnm5s2U.csv")
```












